<!doctype html><html lang=en><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta http-equiv=content-language content="en"><meta name=author content="Sine"><meta name=description content="Note: This article is mainly translated by Google translator, please turn to the Chinese version for more accurate expression if possible. For a while, I paid more attention to digital health and automation, so I tossed a wave of related things and engaged in data storage and Kanban. Recalling that the entire process feels like a micro data warehouse, you need to obtain the data source yourself, design the storage"><meta name=keywords content="blog,developer,personal"><meta name=twitter:card content="summary"><meta name=twitter:title content="Personal Automation System and Information Dashboard"><meta name=twitter:description content="Note: This article is mainly translated by Google translator, please turn to the Chinese version for more accurate expression if possible. For a while, I paid more attention to digital health and automation, so I tossed a wave of related things and engaged in data storage and Kanban. Recalling that the entire process feels like a micro data warehouse, you need to obtain the data source yourself, design the storage"><meta property="og:title" content="Personal Automation System and Information Dashboard"><meta property="og:description" content="Note: This article is mainly translated by Google translator, please turn to the Chinese version for more accurate expression if possible. For a while, I paid more attention to digital health and automation, so I tossed a wave of related things and engaged in data storage and Kanban. Recalling that the entire process feels like a micro data warehouse, you need to obtain the data source yourself, design the storage"><meta property="og:type" content="article"><meta property="og:url" content="https://ssine.ink/en/posts/personal-automation-n-dashboard/"><meta property="article:published_time" content="2021-04-17T00:51:21+08:00"><meta property="article:modified_time" content="2021-04-17T00:51:21+08:00"><title>Personal Automation System and Information Dashboard · Sine's Site</title><link rel=canonical href=https://ssine.ink/en/posts/personal-automation-n-dashboard/><link rel=preconnect href=https://fonts.gstatic.com><link href="https://fonts.googleapis.com/css?family=Lato:400,700%7CMerriweather:300,700%7CSource+Code+Pro:400,700&display=swap" rel=stylesheet><link rel=preload href="https://ssine.ink/fonts/forkawesome-webfont.woff2?v=1.1.7" as=font type=font/woff2 crossorigin><link rel=stylesheet href=https://ssine.ink/css/coder.min.a050bb9724f6a498b574acf612d6d523bc68756ddc62579923710a8542947c52.css integrity="sha256-oFC7lyT2pJi1dKz2EtbVI7xodW3cYleZI3EKhUKUfFI=" crossorigin=anonymous media=screen><link rel=stylesheet href=https://ssine.ink/css/coder-dark.min.126ad3988d46bdae6217a11105b53c9662bca05f39d42d3c0fb366919d334620.css integrity="sha256-EmrTmI1Gva5iF6ERBbU8lmK8oF851C08D7NmkZ0zRiA=" crossorigin=anonymous media=screen><link rel=icon type=image/png href=https://ssine.ink/favicon.ico sizes=32x32><link rel=icon type=image/png href=https://ssine.ink/favicon.ico sizes=16x16><link rel=apple-touch-icon href=https://ssine.ink/images/apple-touch-icon.png><link rel=apple-touch-icon sizes=180x180 href=https://ssine.ink/images/apple-touch-icon.png><meta name=generator content="Hugo 0.74.1"></head><body class=colorscheme-auto><div class=float-container><a id=dark-mode-toggle class=colorscheme-toggle><i class="fa fa-adjust fa-fw" aria-hidden=true></i></a></div><main class=wrapper><nav class=navigation><section class=container><a class=navigation-title href=https://ssine.ink/en>Sine's Site</a>
<input type=checkbox id=menu-toggle>
<label class="menu-button float-right" for=menu-toggle><i class="fa fa-bars fa-fw" aria-hidden=true></i></label><ul class=navigation-list><li class=navigation-item><a class=navigation-link href=https://ssine.ink/en/posts/>Blog</a></li><li class=navigation-item><a class=navigation-link href=https://kiwi.ssine.cc>Wiki</a></li><li class=navigation-item><a class=navigation-link href=https://ssine.ink/en/gallery>Gallery</a></li><li class=navigation-item><a class=navigation-link href=https://ssine.ink/en/projects/>Projects</a></li><li class="navigation-item menu-separator"><span>|</span></li><li class=navigation-item><a href=https://ssine.ink/posts/personal-automation-n-dashboard/>中文</a></li></ul></section></nav><div class=content><section class="container post"><article><header><div class=post-title><h1 class=title>Personal Automation System and Information Dashboard</h1></div><div class=post-meta><div class=date><span class=posted-on><i class="fa fa-calendar" aria-hidden=true></i><time datetime=2021-04-17T00:51:21+08:00>April 17, 2021</time></span>
<span class=reading-time><i class="fa fa-clock-o" aria-hidden=true></i>12-minute read</span></div></div></header><div><p><strong>Note: This article is mainly translated by Google translator, please turn to the Chinese version for more accurate expression if possible.</strong></p><p>For a while, I paid more attention to digital health and automation, so I tossed a wave of related things and engaged in data storage and Kanban. Recalling that the entire process feels like a micro data warehouse, you need to obtain the data source yourself, design the storage format and transfer it to the database, and then display the information in the database.</p><h1 id=automation-and-data-collection>Automation and data collection</h1><p>First, let’s talk about some of the information I care about and the process of data collection.</p><h2 id=android-automation-tool-tasker>Android automation tool Tasker</h2><p>Although I forgot why I studied Tasker in the first place, I look back on Tasker as a vital part of the entire system, so I give priority to the introduction.</p><p>The first is the choice of various automation tools. Unlike the ShortCuts shortcut application that almost dominates the world on IOS (mainly IOS has strict permissions, the official resource is the crown prince). There are many choices on Android. Tasker is more active. And Macrodroid, Tasker is an old-fashioned application that has existed a long time ago. There are many community-related resources, but Macrodroid&rsquo;s UI is much better than Tasker. Because the focus is still on things, and the ability of Tasker to be more programmers (js/shell scripts, HTTP related), I bought Tasker.</p><p>There will be a tutorial when the software is opened for the first time. The following briefly describes some of the more important concepts:</p><ul><li>Variables: global variables that can be accessed and modified, used to store state</li><li>Task: equivalent to a program, composed of a set of instructions, instructions can do various things, such as requesting HTTP API</li><li>Trigger: A condition used to determine when to execute a task, which can be divided into:</li><li>Event: When something happens, such as turning on the phone screen and scanning the NFC Tag</li><li>Location: Triggered when entering a certain location, need to turn on positioning, GPS->WLAN->base station, power consumption and accuracy are reduced in turn</li><li>Application: Triggered when an application is opened</li><li>Time: trigger at a certain point in time</li><li>State: Triggered when entering or leaving a certain state, such as when entering the battery> 10% state</li><li>Configuration file: It is composed of trigger conditions and tasks, and the configuration of the task is executed when the trigger conditions are met</li><li>Project: The top-level namespace, which can manage multiple sets of the above variables, tasks, triggers, and configuration files</li></ul><p>The other information is combined with the specific application description below.</p><h2 id=daily-management>Daily management</h2><p>The first thing I want to do is to record the &ldquo;time of the occurrence of various events each day&rdquo;, such as what time to get up and go to bed every day, when to go to get off work, and so on. The time to wake up and fall asleep depends on the bracelet. Let me talk about commuting and work records first.</p><p>The daily schedule can be summarized as</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text>     通勤时间        工作时间           通勤时间
离家 &lt;------&gt; 到公司 &lt;------&gt; 离开公司 &lt;------&gt; 到家
</code></pre></div><p>As long as these four time points are recorded, the relevant time can be obtained. So how does the mobile phone learn about these events?</p><ol><li>This is the most direct way to use location information, but high-precision GPS positioning consumes a lot of power, and low-precision base station positioning is not accurate enough, and it takes a long time to react.</li><li>Connect and disconnect via Wifi. Connected to the Wifi at home = home, disconnected from the Wifi at home = leaving home, the same goes for the company. However, this has a flaw. For example, if you disconnect the Wifi for a while when you are at home, it will be recorded as leaving home and returning.</li><li>Wifi connection and disconnection + Wifi changes. This is an enhanced version of 2. If the Wifi I disconnected last time was at home, and the Wifi I connected this time belonged to the company, then I can be sure that connecting to Wifi this time means coming to the company. However, there is still a disadvantage, that is, it is difficult to determine whether the Wifi is really leaving the location of the Wifi when it is disconnected, because you don’t know what the next Wifi is connected to (you can only wait until the next Wifi connection to record) .</li></ol><p>My current method is to use the third method to judge the event of entering the place, and to judge the leaving place by scanning the NFC Tag, like clocking in after get off work. In fact, if you want to change to delayed recording, pure Wifi is fine, but it is lazy.</p><p>The first thing to maintain is the information of the &ldquo;Last Wifi&rdquo;:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text>Profile: Anon (23)
  Restore: no
  State: Not Wifi Connected [SSID:* MAC:* IP:* Active: Any ]
Enter: Anon (27)

Profile: Anon (25)
  Restore: no
  State: Wifi Connected [SSID:* MAC:* IP:* Active: Any ]
Enter: Anon (29)

Task: Anon (27)
  A1: Variable Set [Name:%LastWIFI To:%CurrentWIFI ]
  A2: Variable Set [Name:%CurrentWIFI To:. ]

Task: Anon (29)
  A1: Test Net [Type: Wifi SSID Data: Store Result In:%CurrentWIFI ]
</code></pre></div><p>It is to update LastWifi when Wifi is disconnected, and assign value to CurrentWifi when Wifi is connected.</p><p>Then there are the records of going home and going to work:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text>Profile: 记录：到家 (8)
  Cooldown: 600 Restore: no
  Variables: [ %action: has value ]
  State: Wifi Connected [SSID: 爷斋小二 MAC:* IP:* Active: Any ]
Enter: Anon (30)

Task: Anon (30)
  A1: Wait [MS:0 Seconds:5 Minutes:0 Hours:0 Days:0 ]
  A2: If [ %CurrentWIFI neq %LastWIFI ]
  A3: HTTP Request [Method: GET URL: https://tracker.example.com/life-tracer/log-action?action=%action]
  A4: End If

Profile: 记录：到公司 (14)
  Cooldown: 600 Restore: no
  Variables: [ %action: has value ]
  State: Wifi Connected [SSID: ByteDance Inc MAC:* IP:* Active: Any ]
Enter: Anon (28)

Task: Anon (28)
  A1: Wait [MS:0 Seconds:5 Minutes:0 Hours:0 Days:0 ]
  A2: If [ %CurrentWIFI neq %LastWIFI ]
  A3: HTTP Request [Method: GET URL: https://tracker.example.com/life-tracer/log-action?action=%action]
  A4: End If
</code></pre></div><p>If there is a change during the Wifi connection, please request the built API to record the time. The API will be discussed later.</p><p>As for leaving home and leaving the company, it is triggered by NFC tags:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text>Profile: 记录：离公司 (16)
  Cooldown: 600 Restore: no
  Variables: [ %action: has value ]
  Event: NFC Tag [ID:048AFF32100289 Content: 下班 ]
Enter: Anon (9)

Task: Anon (9)
  A1: HTTP Request [Method: GET URL: https://tracker.example.com/life-tracer/log-action?action=离公司]
</code></pre></div><p>This requires an NFC tag and a mobile phone that supports NFC (which basically supports it now), write a specific value to the tag, or directly use the ID to determine the tag, and trigger the corresponding event when the tag is scanned. The NFC tag uses the NTAG215 coin card used in the previous Mock Switch Amiibo.<a href=https://m.tb.cn/h.4ppvxjN>Taobao link</a> . The Android application NFC Tools Pro is a very useful tool for reading and writing NFC.</p><p>Although the NFC tag is sometimes tasteless, it’s just to clock in and record the time and tap the screen of the phone, but it’s still more ceremonial than pressing the button on the phone. It can be placed in a prominent position to remind you to scan, and it’s more efficient than unlocking the phone. Open the app to record high.</p><h2 id=body-index>Body index</h2><p>There are some health-related indicators, such as heart rate, sleep time, and daily steps, which are suitable for collection with smart bracelets or watches. However, it is troublesome to automatically collect and store these data. First of all, many devices do not support data export. There are many foreign devices that support Google Fit, but Google Fit only provides one-time or bi-monthly export. Not suitable for Kanban. Huawei&rsquo;s watches have many functions, and various data algorithms are also very accurate. Unfortunately, they are too closed to get data. I found a third-party app on Mi Band<a href="https://play.google.com/store/apps/details?id=com.mc.miband1">Notify & Fitness for Mi Band</a> It&rsquo;s very open, you can export data, and support integration with Tasker through intent, so I decided to do it with Xiaomi bracelet and this app.</p><p>First, use the normal process to pair the official Mi Health app with the Mi Band, and then the Notify app can run with Mi Health, or take out the key of the Mi Health APP, Notify runs independently, and the Notify app has detailed instructions. Because Xiaomi&rsquo;s health is bloated, I only use Notify.</p><p>The main beauty of the Notify application is that it can be automated through the Android intent mechanism combined with Tasker. Intent is a mechanism for transferring messages between different applications. Supported functions can be found in the official documentation<a href=http://www.mibandnotify.com/help/tasker_send_intent.php>Bags integration</a> There are mainly two types of receiving and sending. On the one hand, you can send out intents when various events occur, and on the other hand, you can do something when you receive intents. Exporting the data uses the &ldquo;Export steps/sleep/heart/weight spreadsheet data&rdquo; function. When receiving this intent, it will export the steps, sleep, heart rate, weight and other information into a csv file.</p><p>The weight and body fat are the Xiaomi body fat scales that I bought, and it can also be seamlessly integrated with the Notify app, so even though the body fat is not accurate, it is still convenient to use it.</p><p>Bags ：</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text>Profile: Sync Miband (19)
  Restore: no
  Time: Every 3h
Enter: 导出手环数据 (6)

Task:     导出手环数据 (6)
  A1: Send Intent [Action: com.mc.miband.syncData Target: Broadcast Receiver ]
  A2: Wait [Seconds:30]
  A3: Variable Set [Name:%start_time To:%TIMEMS-24*2*60*60*1000 ]
  A4: Send Intent [Action: com.mc.miband.taskerExportAllSpreadsheetData Extra: start:%start_time Target: Broadcast Receiver ]
  A5: Wait [Seconds:30]
  A6: Run Shell [Command: curl -u user:password -T /storage/emulated/0/miband/mibandnotify/export/exportHeart.csv https://drive.example.com/remote.php/dav/files/sine/Backup/Fitness/exportHeart.csv ]
  A7: Run Shell [Command: curl -u user:password -T /storage/emulated/0/miband/mibandnotify/export/exportSleep.csv https://drive.example.com/remote.php/dav/files/sine/Backup/Fitness/exportSleep.csv ]
  A8: Run Shell [Command: curl -u user:password -T /storage/emulated/0/miband/mibandnotify/export/exportSleepDetails.csv https://drive.example.com/remote.php/dav/files/sine/Backup/Fitness/exportSleepDetails.csv ]
  A9: Run Shell [Command: curl -u user:password -T /storage/emulated/0/miband/mibandnotify/export/exportWeight.csv https://drive.example.com/remote.php/dav/files/sine/Backup/Fitness/exportWeight.csv ]
  A10: Run Shell [Command: curl -u user:password -T /storage/emulated/0/miband/mibandnotify/export/exportSteps.csv https://drive.example.com/remote.php/dav/files/sine/Backup/Fitness/exportSteps.csv ]
  A11: HTTP Request [Method: GET URL: https://tracker.example.com/sync/mongo?items=miband ]
</code></pre></div><p>The above profile is executed every three hours, first send an intent to the Notify app to synchronize data from the bracelet, wait 30 seconds and then send a command to export the data of the past two days, wait for 30 seconds to export the data (enough), and then use Shell commands curl to send the exported csv file to the Nextcloud network disk (via the Webdav interface), and finally request the server to parse and store the exported data on the network disk.</p><p>The following is a script that parses the exported file and stores it in MongoDB. The analysis of sleep data is troublesome. There are multiple sleep stages and it is a messy array. I don&rsquo;t know if it is accurate:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>add_heart_data</span>():
    txt <span style=color:#f92672>=</span> get_fs_file_content(<span style=color:#e6db74>&#39;/Backup/Fitness/exportHeart.csv&#39;</span>)
    df <span style=color:#f92672>=</span> pd<span style=color:#f92672>.</span>read_csv(StringIO(txt), sep<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;;&#39;</span>)

    inserts <span style=color:#f92672>=</span> []
    <span style=color:#66d9ef>for</span> _, row <span style=color:#f92672>in</span> tqdm<span style=color:#f92672>.</span>tqdm(df<span style=color:#f92672>.</span>iterrows(), total<span style=color:#f92672>=</span>df<span style=color:#f92672>.</span>shape[<span style=color:#ae81ff>0</span>]):
        inserts<span style=color:#f92672>.</span>append({
            <span style=color:#e6db74>&#39;ts&#39;</span>: datetime<span style=color:#f92672>.</span>fromtimestamp(row[<span style=color:#e6db74>&#39;时间戳&#39;</span>] <span style=color:#f92672>//</span> <span style=color:#ae81ff>1000</span>, timezone<span style=color:#f92672>.</span>utc)<span style=color:#f92672>.</span>replace(microsecond<span style=color:#f92672>=</span>row[<span style=color:#e6db74>&#39;时间戳&#39;</span>] <span style=color:#f92672>%</span> <span style=color:#ae81ff>1000</span>),
            <span style=color:#e6db74>&#39;value&#39;</span>: row[<span style=color:#e6db74>&#39;心率&#39;</span>]
        })

    insert_docs(<span style=color:#e6db74>&#39;sine&#39;</span>, <span style=color:#e6db74>&#39;heart_rate&#39;</span>, inserts)

<span style=color:#66d9ef>def</span> <span style=color:#a6e22e>add_step_data</span>():
    txt <span style=color:#f92672>=</span> get_fs_file_content(<span style=color:#e6db74>&#39;/Backup/Fitness/exportSteps.csv&#39;</span>)
    df <span style=color:#f92672>=</span> pd<span style=color:#f92672>.</span>read_csv(StringIO(txt), sep<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;;&#39;</span>)

    inserts <span style=color:#f92672>=</span> []
    <span style=color:#66d9ef>for</span> _, row <span style=color:#f92672>in</span> tqdm<span style=color:#f92672>.</span>tqdm(df<span style=color:#f92672>.</span>iterrows(), total<span style=color:#f92672>=</span>df<span style=color:#f92672>.</span>shape[<span style=color:#ae81ff>0</span>]):
        inserts<span style=color:#f92672>.</span>append({
            <span style=color:#e6db74>&#39;ts&#39;</span>: datetime<span style=color:#f92672>.</span>fromtimestamp(row[<span style=color:#e6db74>&#39;时间戳&#39;</span>] <span style=color:#f92672>//</span> <span style=color:#ae81ff>1000</span>, timezone<span style=color:#f92672>.</span>utc)<span style=color:#f92672>.</span>replace(microsecond<span style=color:#f92672>=</span>row[<span style=color:#e6db74>&#39;时间戳&#39;</span>] <span style=color:#f92672>%</span> <span style=color:#ae81ff>1000</span>),
            <span style=color:#e6db74>&#39;value&#39;</span>: row[<span style=color:#e6db74>&#39;步数&#39;</span>]
        })

    insert_docs(<span style=color:#e6db74>&#39;sine&#39;</span>, <span style=color:#e6db74>&#39;step&#39;</span>, inserts)

<span style=color:#66d9ef>def</span> <span style=color:#a6e22e>add_weight_data</span>():
    txt <span style=color:#f92672>=</span> get_fs_file_content(<span style=color:#e6db74>&#39;/Backup/Fitness/exportWeight.csv&#39;</span>)
    df <span style=color:#f92672>=</span> pd<span style=color:#f92672>.</span>read_csv(StringIO(txt), sep<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;;&#39;</span>)

    inserts <span style=color:#f92672>=</span> []
    <span style=color:#66d9ef>for</span> _, row <span style=color:#f92672>in</span> tqdm<span style=color:#f92672>.</span>tqdm(df<span style=color:#f92672>.</span>iterrows(), total<span style=color:#f92672>=</span>df<span style=color:#f92672>.</span>shape[<span style=color:#ae81ff>0</span>]):
        inserts<span style=color:#f92672>.</span>append({
            <span style=color:#e6db74>&#39;ts&#39;</span>: datetime<span style=color:#f92672>.</span>fromtimestamp(row[<span style=color:#e6db74>&#39;时间戳&#39;</span>] <span style=color:#f92672>//</span> <span style=color:#ae81ff>1000</span>, timezone<span style=color:#f92672>.</span>utc)<span style=color:#f92672>.</span>replace(microsecond<span style=color:#f92672>=</span>row[<span style=color:#e6db74>&#39;时间戳&#39;</span>] <span style=color:#f92672>%</span> <span style=color:#ae81ff>1000</span>),
            <span style=color:#e6db74>&#39;value&#39;</span>: row[<span style=color:#e6db74>&#39;体重&#39;</span>]
        })

    insert_docs(<span style=color:#e6db74>&#39;sine&#39;</span>, <span style=color:#e6db74>&#39;weight&#39;</span>, inserts)

    inserts <span style=color:#f92672>=</span> []
    <span style=color:#66d9ef>for</span> _, row <span style=color:#f92672>in</span> tqdm<span style=color:#f92672>.</span>tqdm(df<span style=color:#f92672>.</span>iterrows(), total<span style=color:#f92672>=</span>df<span style=color:#f92672>.</span>shape[<span style=color:#ae81ff>0</span>]):
        inserts<span style=color:#f92672>.</span>append({
            <span style=color:#e6db74>&#39;ts&#39;</span>: datetime<span style=color:#f92672>.</span>fromtimestamp(row[<span style=color:#e6db74>&#39;时间戳&#39;</span>] <span style=color:#f92672>//</span> <span style=color:#ae81ff>1000</span>, timezone<span style=color:#f92672>.</span>utc)<span style=color:#f92672>.</span>replace(microsecond<span style=color:#f92672>=</span>row[<span style=color:#e6db74>&#39;时间戳&#39;</span>] <span style=color:#f92672>%</span> <span style=color:#ae81ff>1000</span>),
            <span style=color:#e6db74>&#39;value&#39;</span>: row[<span style=color:#e6db74>&#39;Fat&#39;</span>]
        })

    insert_docs(<span style=color:#e6db74>&#39;sine&#39;</span>, <span style=color:#e6db74>&#39;fat&#39;</span>, inserts)

<span style=color:#66d9ef>def</span> <span style=color:#a6e22e>add_sleep_data</span>():
    txt <span style=color:#f92672>=</span> get_fs_file_content(<span style=color:#e6db74>&#39;/Backup/Fitness/exportSleepDetails.csv&#39;</span>)
    df <span style=color:#f92672>=</span> pd<span style=color:#f92672>.</span>read_csv(StringIO(txt), sep<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;;&#39;</span>)

    events <span style=color:#f92672>=</span> []
    stage_map <span style=color:#f92672>=</span> {
        <span style=color:#e6db74>&#39;wake&#39;</span>: <span style=color:#ae81ff>5</span>,
        <span style=color:#e6db74>&#39;rem&#39;</span>: <span style=color:#ae81ff>4</span>,
        <span style=color:#e6db74>&#39;stage1&#39;</span>: <span style=color:#ae81ff>3</span>,
        <span style=color:#e6db74>&#39;stage2&#39;</span>: <span style=color:#ae81ff>2</span>,
        <span style=color:#e6db74>&#39;stage3&#39;</span>: <span style=color:#ae81ff>1</span>,
        <span style=color:#e6db74>&#39;stage4&#39;</span>: <span style=color:#ae81ff>0</span>,
    }
    miband_map <span style=color:#f92672>=</span> {
        <span style=color:#e6db74>&#39;浅睡&#39;</span>: <span style=color:#e6db74>&#39;stage1&#39;</span>,
        <span style=color:#e6db74>&#39;深睡&#39;</span>: <span style=color:#e6db74>&#39;stage3&#39;</span>,
        <span style=color:#e6db74>&#39;清醒&#39;</span>: <span style=color:#e6db74>&#39;wake&#39;</span>,
        <span style=color:#e6db74>&#39;REM&#39;</span>: <span style=color:#e6db74>&#39;rem&#39;</span>,
    }

    <span style=color:#66d9ef>for</span> _, row <span style=color:#f92672>in</span> df<span style=color:#f92672>.</span>iterrows():
        events<span style=color:#f92672>.</span>append((row[<span style=color:#e6db74>&#39;开始睡眠&#39;</span>], <span style=color:#e6db74>&#39;in&#39;</span>, miband_map[row[<span style=color:#e6db74>&#39;睡眠类型&#39;</span>]]))
        events<span style=color:#f92672>.</span>append((row[<span style=color:#e6db74>&#39;醒来&#39;</span>], <span style=color:#e6db74>&#39;out&#39;</span>, miband_map[row[<span style=color:#e6db74>&#39;睡眠类型&#39;</span>]]))

    events<span style=color:#f92672>.</span>sort(key<span style=color:#f92672>=</span><span style=color:#66d9ef>lambda</span> e: e[<span style=color:#ae81ff>0</span>])

    state <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;wake&#39;</span>
    stage_cnt <span style=color:#f92672>=</span> {
        <span style=color:#e6db74>&#39;wake&#39;</span>: <span style=color:#ae81ff>1</span>,
        <span style=color:#e6db74>&#39;rem&#39;</span>: <span style=color:#ae81ff>0</span>,
        <span style=color:#e6db74>&#39;stage1&#39;</span>: <span style=color:#ae81ff>0</span>,
        <span style=color:#e6db74>&#39;stage2&#39;</span>: <span style=color:#ae81ff>0</span>,
        <span style=color:#e6db74>&#39;stage3&#39;</span>: <span style=color:#ae81ff>0</span>,
        <span style=color:#e6db74>&#39;stage4&#39;</span>: <span style=color:#ae81ff>0</span>,
    }
    inserts <span style=color:#f92672>=</span> []
    <span style=color:#66d9ef>for</span> idx, evt <span style=color:#f92672>in</span> enumerate(events):
        <span style=color:#66d9ef>if</span> evt[<span style=color:#ae81ff>1</span>] <span style=color:#f92672>==</span> <span style=color:#e6db74>&#39;in&#39;</span>:
            stage_cnt[evt[<span style=color:#ae81ff>2</span>]] <span style=color:#f92672>+=</span> <span style=color:#ae81ff>1</span>
        <span style=color:#66d9ef>else</span>:
            stage_cnt[evt[<span style=color:#ae81ff>2</span>]] <span style=color:#f92672>-=</span> <span style=color:#ae81ff>1</span>

        <span style=color:#66d9ef>if</span> idx <span style=color:#f92672>==</span> len(events) <span style=color:#f92672>-</span> <span style=color:#ae81ff>1</span> <span style=color:#f92672>or</span> events[idx <span style=color:#f92672>+</span> <span style=color:#ae81ff>1</span>][<span style=color:#ae81ff>0</span>] <span style=color:#f92672>&gt;</span> evt[<span style=color:#ae81ff>0</span>]:
            <span style=color:#66d9ef>for</span> k <span style=color:#f92672>in</span> reversed(stage_cnt<span style=color:#f92672>.</span>keys()):
                <span style=color:#66d9ef>if</span> stage_cnt[k] <span style=color:#f92672>&gt;</span> <span style=color:#ae81ff>0</span> <span style=color:#f92672>and</span> k <span style=color:#f92672>!=</span> state:
                    ts <span style=color:#f92672>=</span> datetime<span style=color:#f92672>.</span>fromtimestamp(
                        evt[<span style=color:#ae81ff>0</span>] <span style=color:#f92672>//</span> <span style=color:#ae81ff>1000</span>, timezone<span style=color:#f92672>.</span>utc)<span style=color:#f92672>.</span>replace(microsecond<span style=color:#f92672>=</span>evt[<span style=color:#ae81ff>0</span>] <span style=color:#f92672>%</span> <span style=color:#ae81ff>1000</span>)
                    inserts<span style=color:#f92672>.</span>append({
                        <span style=color:#e6db74>&#39;ts&#39;</span>: ts,
                        <span style=color:#e6db74>&#39;value&#39;</span>: stage_map[k],
                    })
                    state <span style=color:#f92672>=</span> k
                    <span style=color:#66d9ef>break</span>

    insert_docs(<span style=color:#e6db74>&#39;sine&#39;</span>, <span style=color:#e6db74>&#39;sleep&#39;</span>, inserts)
</code></pre></div><p>Notify also has the function of sending intents when sleeping and waking up, so it can record the time of sleep, but there is usually a delay of about ten minutes:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text>Profile: 记录：睡着 (3)
  Restore: no
  Variables: [ %action:has value ]
  Event: Intent Received [ Action:com.mc.miband.tasker.fellAsleep ]
Enter: Anon (31)
    
Task:     Anon (31)
  A1: HTTP Request [  Method:GET URL:https://tracker.example.com/life-tracer/log-action?action=%action ] 
  A2: Wait [ MS:0 Seconds:0 Minutes:15 Hours:0 Days:0 ] 
  A3: Media Control [ Cmd:Pause Simulate Media Button:On Package/App Name: 网易云音乐 Use Notification If Available:Off ] 

Profile: 记录：醒来 (4)
  Restore: no
  Variables: [ %action:has value ]
  Event: Intent Received [ Action:com.mc.miband.tasker.wokeUp ]
Enter: Trace POST (2)

Task:     Trace POST (2)
  A1: Wait [ MS:0 Seconds:10 Minutes:0 Hours:0 Days:0 ] 
  A2: HTTP Request [  Method:GET URL:https://tracker.example.com/life-tracer/log-action?action=%action ] 
</code></pre></div><p>Both sleeping and waking up will request the API to record the event, and when sleeping, the music being played will be additionally closed.</p><h2 id=digital-health>Digital health</h2><p>Digital Wellbeing mainly advocates not to be dominated by electronic equipment, which is wasting a lot of unnecessary energy. Specific to the usage is to count the time used by each application.</p><h3 id=cell-phone>Cell phone</h3><p>The first is the mobile phone. Tasker comes with the function of getting the application usage time from the Android system, but I don’t know why the time recorded by this system function is horribly inaccurate, and there is a lack of documentation. It is not clear whether it is the process running time or the screen usage time. Later, I couldn’t bear it and decided I used Tasker to record:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text>Profile: Phone Usage - Change (38)
  Restore: no
  Event: App Changed [ Output Variables:* Package:* ]
Enter: Anon (39)

Task:     Anon (39)
  A1: If [ %CurrentAPP neq . ]
  A2: Variable Set [ Name:%usageTime To:%TIMES-%APPOpenTime ] 
  A3: JavaScriptlet [ Code:let l = []
    try {
      l = JSON.parse(global(&#34;APPUsageList&#34;))
    } catch (err) {
      l = []
    }
    l.push({ts: global(&#34;APPOpenTime&#34;), name: global(&#34;CurrentAPP&#34;), package: global(&#34;CurrentPackage&#34;), time: global(&#34;usageTime&#34;)})
    setGlobal(&#34;APPUsageList&#34;, JSON.stringify(l)) Libraries: Auto Exit:On Timeout (Seconds):45 ] 
  A5: End If 
  A6: Variable Set [ Name:%CurrentAPP To:%app_name ] 
  A7: Variable Set [ Name:%CurrentPackage To:%app_package ] 
  A8: Variable Set [ Name:%APPOpenTime To:%TIMES ] 
  

Profile: Phone Usage - Screen (40)
  Restore: no
  Event: Display Off
Enter: Anon (41)

Task:     Anon (41)
  A1: If [ %CurrentAPP neq . ]
  A2: Variable Set [ Name:%usageTime To:%TIMES-%APPOpenTime ] 
  A3: JavaScriptlet [ Code:let l = []
    try {
      l = JSON.parse(global(&#34;APPUsageList&#34;))
    } catch (err) {
      l = []
    }
    l.push({ts: global(&#34;APPOpenTime&#34;), name: global(&#34;CurrentAPP&#34;), package: global(&#34;CurrentPackage&#34;), time: global(&#34;usageTime&#34;)})
    setGlobal(&#34;APPUsageList&#34;, JSON.stringify(l)) Libraries: Auto Exit:On Timeout (Seconds):45 ] 
  A4: End If 
  A5: Variable Set [ Name:%CurrentAPP To:. ] 
  A6: Variable Set [ Name:%APPOpenTime To:. ] 

Profile: Sync Phone Usage (43)
  Priority: 4 Restore: no
  Time:  Every 1h
Enter: Anon (44)

Task:     Anon (44)
  A1: HTTP Request [  Method:POST URL:https://tracker.example.com/phone_usage Body:%APPUsageList ] 
  A2: Variable Set [ Name:%APPUsageList To:[] ] 
</code></pre></div><p>The specific content can be seen in the task description. The use time of the currently opened APP is recorded through several global variables, and the use of the last APP is included in the APPUsageList when the APP is switched. Finally, the current APPUsageList is sent to the APPUsageList at regular intervals. Document the API. Tasker&rsquo;s variables only support string types, so if you want to store more complex JSON format, you need to write scripts. Fortunately, Tasker supports JavascriptLet type tasks, you can run JS code directly, so you can achieve more complex logic.</p><h3 id=computer>computer</h3><p>The system on Mac comes with time statistics (but it cannot be exported, but the problem is not big, and you can see it anyway). There is no software on Windows. There is software that can count time, but there is no export function. I had to write a script for statistics by myself:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=color:#f92672>import</span> time
<span style=color:#f92672>import</span> win32gui
<span style=color:#f92672>import</span> win32process
<span style=color:#f92672>import</span> win32pdh
<span style=color:#f92672>import</span> uiautomation <span style=color:#f92672>as</span> auto
<span style=color:#f92672>import</span> psutil
<span style=color:#f92672>import</span> json
<span style=color:#f92672>from</span> urllib.parse <span style=color:#f92672>import</span> urlparse
<span style=color:#f92672>from</span> datetime <span style=color:#f92672>import</span> datetime, timezone
<span style=color:#f92672>import</span> requests
<span style=color:#f92672>import</span> copy
<span style=color:#f92672>import</span> logging
<span style=color:#f92672>from</span> win10toast <span style=color:#f92672>import</span> ToastNotifier
<span style=color:#f92672>import</span> os
<span style=color:#f92672>import</span> traceback
<span style=color:#f92672>import</span> re
<span style=color:#f92672>from</span> io <span style=color:#f92672>import</span> StringIO

logging<span style=color:#f92672>.</span>basicConfig(filename<span style=color:#f92672>=</span>os<span style=color:#f92672>.</span>path<span style=color:#f92672>.</span>join(
    __file__, <span style=color:#e6db74>&#39;../logs.log&#39;</span>), level<span style=color:#f92672>=</span>logging<span style=color:#f92672>.</span>INFO, format<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;[</span><span style=color:#e6db74>%(asctime)s</span><span style=color:#e6db74>][</span><span style=color:#e6db74>%(levelname)s</span><span style=color:#e6db74>] </span><span style=color:#e6db74>%(message)s</span><span style=color:#e6db74>&#39;</span>)

<span style=color:#66d9ef>def</span> <span style=color:#a6e22e>get_chrome_active_domain</span>(handle):
    ctl <span style=color:#f92672>=</span> auto<span style=color:#f92672>.</span>ControlFromHandle(handle)
    tmp <span style=color:#f92672>=</span> ctl<span style=color:#f92672>.</span>PaneControl(Depth<span style=color:#f92672>=</span><span style=color:#ae81ff>1</span>, Name<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;Google Chrome&#39;</span>)<span style=color:#f92672>.</span>GetChildren()[
        <span style=color:#ae81ff>1</span>]<span style=color:#f92672>.</span>GetChildren()[<span style=color:#ae81ff>0</span>]
    found <span style=color:#f92672>=</span> False
    <span style=color:#66d9ef>for</span> bar <span style=color:#f92672>in</span> tmp<span style=color:#f92672>.</span>GetChildren():
        last <span style=color:#f92672>=</span> bar<span style=color:#f92672>.</span>GetLastChildControl()
        <span style=color:#66d9ef>if</span> last <span style=color:#f92672>and</span> last<span style=color:#f92672>.</span>Name <span style=color:#f92672>!=</span> <span style=color:#e6db74>&#39;&#39;</span>:
            found <span style=color:#f92672>=</span> True
            <span style=color:#66d9ef>break</span>
    <span style=color:#66d9ef>if</span> found:
        addr_bar <span style=color:#f92672>=</span> bar<span style=color:#f92672>.</span>GroupControl(Depth<span style=color:#f92672>=</span><span style=color:#ae81ff>1</span>, Name<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;&#39;</span>)<span style=color:#f92672>.</span>EditControl()
        url <span style=color:#f92672>=</span> addr_bar<span style=color:#f92672>.</span>GetValuePattern()<span style=color:#f92672>.</span>Value
        <span style=color:#66d9ef>if</span> <span style=color:#e6db74>&#39;://&#39;</span> <span style=color:#f92672>not</span> <span style=color:#f92672>in</span> url:
            url <span style=color:#f92672>=</span> f<span style=color:#e6db74>&#39;http://{url}&#39;</span>
        domain <span style=color:#f92672>=</span> urlparse(url)<span style=color:#f92672>.</span>netloc
        <span style=color:#66d9ef>if</span> <span style=color:#f92672>not</span> re<span style=color:#f92672>.</span>match(<span style=color:#e6db74>r</span><span style=color:#e6db74>&#39;([\S]+(\.[\S]+)+)|(\S+:\d+)&#39;</span>, domain):
            <span style=color:#66d9ef>return</span> None
        <span style=color:#66d9ef>return</span> domain
    <span style=color:#66d9ef>else</span>:
        <span style=color:#66d9ef>return</span> None

process_name_map <span style=color:#f92672>=</span> {
    <span style=color:#e6db74>&#39;chrome.exe&#39;</span>: <span style=color:#e6db74>&#39;Chrome&#39;</span>,
    <span style=color:#e6db74>&#39;code.exe&#39;</span>: <span style=color:#e6db74>&#39;VS Code&#39;</span>,
    <span style=color:#e6db74>&#39;explorer.exe&#39;</span>: <span style=color:#e6db74>&#39;File Explorer&#39;</span>,
    <span style=color:#e6db74>&#39;powershell.exe&#39;</span>: <span style=color:#e6db74>&#39;Powershell&#39;</span>,
    <span style=color:#e6db74>&#39;wechat.exe&#39;</span>: <span style=color:#e6db74>&#39;Wechat&#39;</span>,
    <span style=color:#e6db74>&#39;element.exe&#39;</span>: <span style=color:#e6db74>&#39;Element&#39;</span>,
    <span style=color:#e6db74>&#39;qq.exe&#39;</span>: <span style=color:#e6db74>&#39;QQ&#39;</span>,
    <span style=color:#e6db74>&#39;cloudmusic.exe&#39;</span>: <span style=color:#e6db74>&#39;网易云音乐&#39;</span>,
}

<span style=color:#66d9ef>def</span> <span style=color:#a6e22e>check</span>():
    wh <span style=color:#f92672>=</span> win32gui<span style=color:#f92672>.</span>GetForegroundWindow()
    title_text <span style=color:#f92672>=</span> win32gui<span style=color:#f92672>.</span>GetWindowText(wh)
    tid, pid <span style=color:#f92672>=</span> win32process<span style=color:#f92672>.</span>GetWindowThreadProcessId(wh)
    process <span style=color:#f92672>=</span> psutil<span style=color:#f92672>.</span>Process(pid)
    process<span style=color:#f92672>.</span>as_dict()
    process_name <span style=color:#f92672>=</span> str(process<span style=color:#f92672>.</span>name())<span style=color:#f92672>.</span>lower()
    child_path <span style=color:#f92672>=</span> []
    <span style=color:#66d9ef>if</span> process_name <span style=color:#f92672>==</span> <span style=color:#e6db74>&#39;chrome.exe&#39;</span> <span style=color:#f92672>and</span> <span style=color:#e6db74>&#39; - &#39;</span> <span style=color:#f92672>in</span> title_text:
        domain <span style=color:#f92672>=</span> get_chrome_active_domain(wh)
        child_path<span style=color:#f92672>.</span>append(domain)
    <span style=color:#66d9ef>elif</span> process_name <span style=color:#f92672>==</span> <span style=color:#e6db74>&#39;code.exe&#39;</span>:
        child_path<span style=color:#f92672>.</span>append(title_text<span style=color:#f92672>.</span>split(<span style=color:#e6db74>&#39; - &#39;</span>)[<span style=color:#f92672>-</span><span style=color:#ae81ff>2</span>])

    <span style=color:#66d9ef>return</span> {
        <span style=color:#e6db74>&#39;process_name&#39;</span>: process_name,
        <span style=color:#e6db74>&#39;program_name&#39;</span>: process_name_map<span style=color:#f92672>.</span>get(process_name, process_name),
        <span style=color:#e6db74>&#39;window_title&#39;</span>: title_text,
        <span style=color:#e6db74>&#39;child_path&#39;</span>: child_path,
        <span style=color:#e6db74>&#39;ts&#39;</span>: datetime<span style=color:#f92672>.</span>utcnow(),
    }

<span style=color:#66d9ef>def</span> <span style=color:#a6e22e>state_changed</span>(a, b):
    <span style=color:#66d9ef>if</span> a[<span style=color:#e6db74>&#39;process_name&#39;</span>] <span style=color:#f92672>!=</span> b[<span style=color:#e6db74>&#39;process_name&#39;</span>]:
        <span style=color:#66d9ef>return</span> True
    <span style=color:#66d9ef>if</span> len(a[<span style=color:#e6db74>&#39;child_path&#39;</span>]) <span style=color:#f92672>!=</span> len(b[<span style=color:#e6db74>&#39;child_path&#39;</span>]):
        <span style=color:#66d9ef>return</span> True
    <span style=color:#66d9ef>if</span> any(map(<span style=color:#66d9ef>lambda</span> t: t[<span style=color:#ae81ff>0</span>] <span style=color:#f92672>!=</span> t[<span style=color:#ae81ff>1</span>], zip(a[<span style=color:#e6db74>&#39;child_path&#39;</span>], b[<span style=color:#e6db74>&#39;child_path&#39;</span>]))):
        <span style=color:#66d9ef>return</span> True
    <span style=color:#66d9ef>return</span> False

toaster <span style=color:#f92672>=</span> ToastNotifier()
toaster<span style=color:#f92672>.</span>show_toast(<span style=color:#e6db74>&#34;Desktop Usage Tracker&#34;</span>, <span style=color:#e6db74>&#34;Tracking started.&#34;</span>, duration<span style=color:#f92672>=</span><span style=color:#ae81ff>10</span>)

usages <span style=color:#f92672>=</span> []
last_app <span style=color:#f92672>=</span> None
last_send_time <span style=color:#f92672>=</span> datetime<span style=color:#f92672>.</span>now()
<span style=color:#66d9ef>while</span> True:
    <span style=color:#66d9ef>try</span>:
        tpassed <span style=color:#f92672>=</span> (datetime<span style=color:#f92672>.</span>now() <span style=color:#f92672>-</span> last_send_time)<span style=color:#f92672>.</span>total_seconds()
        <span style=color:#66d9ef>if</span> tpassed <span style=color:#f92672>&gt;</span> <span style=color:#ae81ff>60</span> <span style=color:#f92672>*</span> <span style=color:#ae81ff>10</span> <span style=color:#f92672>and</span> len(usages) <span style=color:#f92672>&gt;</span> <span style=color:#ae81ff>0</span>:
            <span style=color:#66d9ef>try</span>:
                logging<span style=color:#f92672>.</span>info(f<span style=color:#e6db74>&#39;{tpassed:.2f} seconds passed, sending usages&#39;</span>)
                res <span style=color:#f92672>=</span> requests<span style=color:#f92672>.</span>post(
                    <span style=color:#e6db74>&#39;https://tracker.example.com/desktop_usage&#39;</span>, json<span style=color:#f92672>=</span>usages)
                usages <span style=color:#f92672>=</span> []
                last_send_time <span style=color:#f92672>=</span> datetime<span style=color:#f92672>.</span>now()
                logging<span style=color:#f92672>.</span>info(<span style=color:#e6db74>&#39;sending done&#39;</span>)
            <span style=color:#66d9ef>except</span> <span style=color:#a6e22e>Exception</span> <span style=color:#66d9ef>as</span> err:
                logging<span style=color:#f92672>.</span>error(f<span style=color:#e6db74>&#39;failed to send usage: {err}&#39;</span>)

        app <span style=color:#f92672>=</span> check()
        <span style=color:#66d9ef>if</span> <span style=color:#f92672>not</span> last_app <span style=color:#f92672>or</span> state_changed(last_app, app):
            tmp <span style=color:#f92672>=</span> copy<span style=color:#f92672>.</span>deepcopy(last_app) <span style=color:#66d9ef>if</span> last_app <span style=color:#66d9ef>else</span> copy<span style=color:#f92672>.</span>deepcopy(app)
            tmp[<span style=color:#e6db74>&#39;time&#39;</span>] <span style=color:#f92672>=</span> (datetime<span style=color:#f92672>.</span>utcnow() <span style=color:#f92672>-</span>
                                tmp[<span style=color:#e6db74>&#39;ts&#39;</span>])<span style=color:#f92672>.</span>total_seconds()
            tmp[<span style=color:#e6db74>&#39;ts&#39;</span>] <span style=color:#f92672>=</span> tmp[<span style=color:#e6db74>&#39;ts&#39;</span>]<span style=color:#f92672>.</span>replace(tzinfo<span style=color:#f92672>=</span>timezone<span style=color:#f92672>.</span>utc)<span style=color:#f92672>.</span>timestamp()
            <span style=color:#66d9ef>if</span> tmp[<span style=color:#e6db74>&#39;process_name&#39;</span>] <span style=color:#f92672>==</span> <span style=color:#e6db74>&#39;chrome.exe&#39;</span> <span style=color:#f92672>and</span> len(tmp[<span style=color:#e6db74>&#39;child_path&#39;</span>]) <span style=color:#f92672>&gt;</span> <span style=color:#ae81ff>0</span>:
                <span style=color:#66d9ef>if</span> <span style=color:#f92672>not</span> isinstance(tmp[<span style=color:#e6db74>&#39;child_path&#39;</span>][<span style=color:#ae81ff>0</span>], str) <span style=color:#f92672>or</span> <span style=color:#f92672>not</span> re<span style=color:#f92672>.</span>match(<span style=color:#e6db74>r</span><span style=color:#e6db74>&#39;([\S]+(\.[\S]+)+)|(\S+:\d+)&#39;</span>, tmp[<span style=color:#e6db74>&#39;child_path&#39;</span>][<span style=color:#ae81ff>0</span>]):
                    tmp[<span style=color:#e6db74>&#39;child_path&#39;</span>] <span style=color:#f92672>=</span> []
            <span style=color:#66d9ef>if</span> len(usages) <span style=color:#f92672>&gt;</span> <span style=color:#ae81ff>0</span> <span style=color:#f92672>and</span> usages[<span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>][<span style=color:#e6db74>&#39;ts&#39;</span>] <span style=color:#f92672>==</span> tmp[<span style=color:#e6db74>&#39;ts&#39;</span>]:
                usages[<span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>] <span style=color:#f92672>=</span> tmp
            <span style=color:#66d9ef>else</span>:
                usages<span style=color:#f92672>.</span>append(tmp)
            last_app <span style=color:#f92672>=</span> app
    <span style=color:#66d9ef>except</span> <span style=color:#a6e22e>Exception</span> <span style=color:#66d9ef>as</span> err:
        logging<span style=color:#f92672>.</span>error(f<span style=color:#e6db74>&#39;exception: {err}&#39;</span>)
        s <span style=color:#f92672>=</span> StringIO()
        traceback<span style=color:#f92672>.</span>print_tb(err<span style=color:#f92672>.</span>__traceback__, file<span style=color:#f92672>=</span>s)
        logging<span style=color:#f92672>.</span>error(s<span style=color:#f92672>.</span>getvalue())
    time<span style=color:#f92672>.</span>sleep(<span style=color:#ae81ff>0.5</span>)
</code></pre></div><p>The above script will get the currently active window every half a second, and if the window changes, it will record the usage of the previous window (start, end). Special processing is done for the more commonly used software, you can get the domain name of the current tab of Chrome and the project that VSCode is working on. Mainly used various Windows-related packages. Finally, the usage status will be reported to the API regularly for data recording.</p><p>If you want this script to start on boot, you need to<code>C:\Users\&lt;name>\AppData\Roaming\Microsoft\Windows\Start Menu\Programs\Startup</code> Create a new one under the directory<code>vbs</code> File, the content is:</p><pre><code class=language-vbs data-lang=vbs>DIM objShell
set objShell=wscript.createObject(&quot;wscript.shell&quot;)
iReturn=objShell.Run(&quot;&quot;&quot;C:\ProgramData\Miniconda3\python.exe&quot;&quot; &quot;&quot;D:\Project\LifeTracker\DesktopTracker\track.py&quot;&quot;&quot;, 0, TRUE)
</code></pre><p>This will run the script in the background every time it starts.</p><h1 id=data-storage>data storage</h1><p>The foregoing mainly describes the source of various data. After the data is collected, it is sent to the server through the API, and the server does some simple processing and stores it in the database.</p><p>In terms of databases, most of the data is time indexed, and you can use relational databases, document databases, or time series databases. Considering that the relational database is not flexible enough, and the function of the time series database is relatively specific and the performance requirements are not so high, I decided to use the more convenient document database MongoDB for storage.</p><p>MongoDB&rsquo;s docker-compose file:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml>---
<span style=color:#66d9ef>version</span>: <span style=color:#e6db74>&#34;2.1&#34;</span>
<span style=color:#66d9ef>services</span>:
  <span style=color:#66d9ef>mongodb</span>:
    <span style=color:#66d9ef>image</span>: mongo:latest
    <span style=color:#66d9ef>container_name</span>: mongodb
    <span style=color:#66d9ef>environment</span>:
      - PUID=<span style=color:#ae81ff>1000</span>
      - PGID=<span style=color:#ae81ff>1000</span>
      - MONGO_INITDB_ROOT_USERNAME=x
      - MONGO_INITDB_ROOT_PASSWORD=x
    <span style=color:#66d9ef>volumes</span>:
      - /home/sine/service/mongodb/data:/data/db
    <span style=color:#66d9ef>ports</span>:
      - <span style=color:#ae81ff>2012</span>:<span style=color:#ae81ff>27017</span>
    <span style=color:#66d9ef>restart</span>: unless-stopped
</code></pre></div><p>The API service is built with Flask, and its main function is to receive and write data from HTTP:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=color:#a6e22e>@app.route</span>(<span style=color:#e6db74>&#39;/life-tracer/log-action&#39;</span>)
<span style=color:#66d9ef>def</span> <span style=color:#a6e22e>log_action</span>():
    action <span style=color:#f92672>=</span> request<span style=color:#f92672>.</span>args<span style=color:#f92672>.</span>get(<span style=color:#e6db74>&#39;action&#39;</span>)
    insert_docs(<span style=color:#e6db74>&#39;sine&#39;</span>, <span style=color:#e6db74>&#39;daily_events&#39;</span>, [{
        <span style=color:#e6db74>&#39;ts&#39;</span>: datetime<span style=color:#f92672>.</span>datetime<span style=color:#f92672>.</span>utcnow()<span style=color:#f92672>.</span>replace(tzinfo<span style=color:#f92672>=</span>datetime<span style=color:#f92672>.</span>timezone<span style=color:#f92672>.</span>utc),
        <span style=color:#e6db74>&#39;event&#39;</span>: action
    }])
    send_qq_msg(<span style=color:#ae81ff>123456</span>, f<span style=color:#e6db74>&#39;记录： {action}&#39;</span>)
    <span style=color:#66d9ef>return</span> <span style=color:#e6db74>&#39;200 OK&#39;</span>

<span style=color:#a6e22e>@app.route</span>(<span style=color:#e6db74>&#39;/sync/mongo&#39;</span>)
<span style=color:#66d9ef>def</span> <span style=color:#a6e22e>sync_mongo</span>():
    items <span style=color:#f92672>=</span> request<span style=color:#f92672>.</span>args<span style=color:#f92672>.</span>get(<span style=color:#e6db74>&#39;items&#39;</span>)
    items <span style=color:#f92672>=</span> items<span style=color:#f92672>.</span>split(<span style=color:#e6db74>&#39;,&#39;</span>)
    <span style=color:#66d9ef>for</span> item <span style=color:#f92672>in</span> items:
        <span style=color:#66d9ef>if</span> item <span style=color:#f92672>==</span> <span style=color:#e6db74>&#39;miband&#39;</span>:
            add_step_data()
            add_heart_data()
            add_sleep_data()
            add_weight_data()
        <span style=color:#66d9ef>elif</span> item <span style=color:#f92672>==</span> <span style=color:#e6db74>&#39;thermometer&#39;</span>:
            add_thermometer_data()
        <span style=color:#66d9ef>elif</span> item <span style=color:#f92672>==</span> <span style=color:#e6db74>&#39;waka&#39;</span>:
            add_wakatime_data()
    <span style=color:#66d9ef>return</span> <span style=color:#e6db74>&#39;200 OK&#39;</span>

<span style=color:#a6e22e>@app.route</span>(<span style=color:#e6db74>&#39;/phone_usage&#39;</span>, methods<span style=color:#f92672>=</span>[<span style=color:#e6db74>&#39;POST&#39;</span>])
<span style=color:#66d9ef>def</span> <span style=color:#a6e22e>phone_usage</span>():
    data <span style=color:#f92672>=</span> request<span style=color:#f92672>.</span>get_json(force<span style=color:#f92672>=</span>True)
    updates <span style=color:#f92672>=</span> []
    <span style=color:#66d9ef>for</span> d <span style=color:#f92672>in</span> data:
        <span style=color:#66d9ef>try</span>:
            ts <span style=color:#f92672>=</span> datetime<span style=color:#f92672>.</span>datetime<span style=color:#f92672>.</span>utcfromtimestamp(int(d[<span style=color:#e6db74>&#39;ts&#39;</span>]))
            updates<span style=color:#f92672>.</span>append(UpdateOne({<span style=color:#e6db74>&#39;ts&#39;</span>: ts}, {<span style=color:#e6db74>&#39;$set&#39;</span>: {
                <span style=color:#e6db74>&#39;ts&#39;</span>: ts,
                <span style=color:#e6db74>&#39;name&#39;</span>: d[<span style=color:#e6db74>&#39;name&#39;</span>],
                <span style=color:#e6db74>&#39;package&#39;</span>: d[<span style=color:#e6db74>&#39;package&#39;</span>],
                <span style=color:#e6db74>&#39;time&#39;</span>: int(d[<span style=color:#e6db74>&#39;time&#39;</span>]),
            }}, upsert<span style=color:#f92672>=</span>True))
        <span style=color:#66d9ef>except</span> <span style=color:#a6e22e>Exception</span> <span style=color:#66d9ef>as</span> err:
            <span style=color:#66d9ef>print</span>(err)
    bulk_write(<span style=color:#e6db74>&#39;sine&#39;</span>, <span style=color:#e6db74>&#39;phone_usage&#39;</span>, updates)

    <span style=color:#66d9ef>return</span> <span style=color:#e6db74>&#39;200 OK&#39;</span>

<span style=color:#a6e22e>@app.route</span>(<span style=color:#e6db74>&#39;/desktop_usage&#39;</span>, methods<span style=color:#f92672>=</span>[<span style=color:#e6db74>&#39;POST&#39;</span>])
<span style=color:#66d9ef>def</span> <span style=color:#a6e22e>desktop_usage</span>():
    data <span style=color:#f92672>=</span> request<span style=color:#f92672>.</span>get_json(force<span style=color:#f92672>=</span>True)
    updates <span style=color:#f92672>=</span> []
    <span style=color:#66d9ef>for</span> d <span style=color:#f92672>in</span> data:
        ts <span style=color:#f92672>=</span> datetime<span style=color:#f92672>.</span>datetime<span style=color:#f92672>.</span>utcfromtimestamp(d[<span style=color:#e6db74>&#39;ts&#39;</span>])
        updates<span style=color:#f92672>.</span>append(UpdateOne({<span style=color:#e6db74>&#39;ts&#39;</span>: ts}, {<span style=color:#e6db74>&#39;$set&#39;</span>: {
            <span style=color:#f92672>**</span>d,
            <span style=color:#e6db74>&#39;ts&#39;</span>: ts
        }}, upsert<span style=color:#f92672>=</span>True))
    bulk_write(<span style=color:#e6db74>&#39;sine&#39;</span>, <span style=color:#e6db74>&#39;desktop_usage&#39;</span>, updates)

    <span style=color:#66d9ef>return</span> <span style=color:#e6db74>&#39;200 OK&#39;</span>

<span style=color:#a6e22e>@app.route</span>(<span style=color:#e6db74>&#39;/thermometer_report&#39;</span>)
<span style=color:#66d9ef>def</span> <span style=color:#a6e22e>thermometer_report</span>():
    temperature <span style=color:#f92672>=</span> request<span style=color:#f92672>.</span>args<span style=color:#f92672>.</span>get(<span style=color:#e6db74>&#39;temperature&#39;</span>)
    humidity <span style=color:#f92672>=</span> request<span style=color:#f92672>.</span>args<span style=color:#f92672>.</span>get(<span style=color:#e6db74>&#39;humidity&#39;</span>)

    client[<span style=color:#e6db74>&#39;sine&#39;</span>][<span style=color:#e6db74>&#39;room_metrics&#39;</span>]<span style=color:#f92672>.</span>insert_one({
        <span style=color:#e6db74>&#39;ts&#39;</span>: datetime<span style=color:#f92672>.</span>datetime<span style=color:#f92672>.</span>utcnow(),
        <span style=color:#e6db74>&#39;temperature&#39;</span>: float(temperature),
        <span style=color:#e6db74>&#39;humidity&#39;</span>: float(humidity),
    })

    <span style=color:#66d9ef>return</span> <span style=color:#e6db74>&#39;200 OK&#39;</span>
</code></pre></div><p><code>/life-tracer/log-action</code> Can record events that occur at a certain point in time,<code>/sync/mongo</code> It is used to parse the data uploaded to Nextcloud and store it in the database. There are also scripts for processing Wakatime data, which can count the daily code writing. The Wakatime free API only provides detailed data for seven days, which can be stored for a long time.<code>/phone_usage</code> with <code>/desktop_usage</code> It’s an API for saving related script data in the section on digital health. Finally,<code>/thermometer_report</code> For storage in<a href=https://ssine.ink/posts/rpi-thermometer-and-ir/>Use Raspberry Pi for temperature and humidity reporting and infrared control</a> Room temperature and humidity data mentioned in.</p><h1 id=data-kanban>Data Kanban</h1><p>The ETL process of the data has been completed before, and there is still the last step: data display and analysis. This is achieved through Grafana Kanban.</p><p>Grafana&rsquo;s docker-compose file:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml>---
<span style=color:#66d9ef>version</span>: <span style=color:#e6db74>&#34;2.1&#34;</span>
<span style=color:#66d9ef>services</span>:
  <span style=color:#66d9ef>grafana</span>:
    <span style=color:#66d9ef>image</span>: grafana/grafana:latest
    <span style=color:#66d9ef>container_name</span>: grafana
    <span style=color:#66d9ef>environment</span>:
      - PUID=<span style=color:#ae81ff>1000</span>
      - PGID=<span style=color:#ae81ff>1000</span>
      - GF_PATHS_CONFIG=/var/lib/grafana/config.ini
    <span style=color:#66d9ef>volumes</span>:
      - /home/sine/service/grafana/data:/var/lib/grafana
    <span style=color:#66d9ef>ports</span>:
      - <span style=color:#ae81ff>2013</span>:<span style=color:#ae81ff>3000</span>
    <span style=color:#66d9ef>restart</span>: unless-stopped
</code></pre></div><p>Grafana&rsquo;s official MongoDB data source plug-in requires a paid enterprise version to use, so here is a plug-in from the community<a href=https://github.com/PhracturedBlue/mongodb-grafana-backend>mongodb-grafana-backend</a> , But this plugin is not signed, you need to manually<code>config.ini</code> This plugin is allowed in the configuration file:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-ini data-lang=ini><span style=color:#66d9ef>[plugins]</span>
<span style=color:#a6e22e>allow_loading_unsigned_plugins</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>grafana-mongodb-backend-datasource</span>
</code></pre></div><p>Although another MongoDB plugin<a href=https://github.com/JamesOsgood/mongodb-grafana>mongodb-grafana</a> There are many stars, but it is forwarded through a node service by Lingqi, which is extremely inelegant in Docker, so the previous plug-in that does not require back-end services is used. As for installation, refer to the README and copy the corresponding directory to Grafana&rsquo;s plugin, and then restart the Grafana service.</p><p>In addition, Plotly panel is used to draw pictures through js, and Pie Chart plug-in, both of which can be searched and installed on Grafana&rsquo;s settings page.</p><p>Put a complete picture first:</p><p><img src=dashboard.jpg alt=img></p><p>Let&rsquo;s take a look at the implementation of several of these panels.</p><p>Daily mobile phone usage time is a regular query</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json>[
  {<span style=color:#f92672>&#34;$match&#34;</span>: {<span style=color:#f92672>&#34;ts&#34;</span>: {<span style=color:#f92672>&#34;$gte&#34;</span>: <span style=color:#e6db74>&#34;$from&#34;</span>, <span style=color:#f92672>&#34;$lt&#34;</span> : <span style=color:#e6db74>&#34;$to&#34;</span>}}},
  {<span style=color:#f92672>&#34;$match&#34;</span>: {<span style=color:#f92672>&#34;name&#34;</span>: {<span style=color:#f92672>&#34;$ne&#34;</span>: <span style=color:#e6db74>&#34;一加桌面&#34;</span>}}},
  {<span style=color:#f92672>&#34;$group&#34;</span>: {
    <span style=color:#f92672>&#34;_id&#34;</span>: {<span style=color:#f92672>&#34;$dateToString&#34;</span>: {<span style=color:#f92672>&#34;format&#34;</span>: <span style=color:#e6db74>&#34;%Y-%m-%d&#34;</span>, <span style=color:#f92672>&#34;date&#34;</span>: <span style=color:#e6db74>&#34;$ts&#34;</span>}},
    <span style=color:#f92672>&#34;time&#34;</span>: {<span style=color:#f92672>&#34;$sum&#34;</span>: <span style=color:#e6db74>&#34;$time&#34;</span>}
  }},
  {<span style=color:#f92672>&#34;$project&#34;</span> : {<span style=color:#f92672>&#34;name&#34;</span> : <span style=color:#e6db74>&#34;usage&#34;</span>, <span style=color:#f92672>&#34;value&#34;</span> : <span style=color:#e6db74>&#34;$time&#34;</span>, <span style=color:#f92672>&#34;ts&#34;</span> : {<span style=color:#f92672>&#34;$toDate&#34;</span>: <span style=color:#e6db74>&#34;$_id&#34;</span>}, <span style=color:#f92672>&#34;_id&#34;</span> : <span style=color:#ae81ff>0</span>}},
  {<span style=color:#f92672>&#34;$sort&#34;</span>: {<span style=color:#f92672>&#34;ts&#34;</span> : <span style=color:#ae81ff>1</span>}}
]
</code></pre></div><p>Take out the data of a specific time period, filter out meaningless applications, and then sum up in units of days, and finally map to the specified format of the plug-in.</p><p>Pie chart of the usage time of mobile apps in the past period of time:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json>[
  {<span style=color:#f92672>&#34;$match&#34;</span>: {<span style=color:#f92672>&#34;ts&#34;</span>: {<span style=color:#f92672>&#34;$gte&#34;</span>: <span style=color:#e6db74>&#34;$from&#34;</span>, <span style=color:#f92672>&#34;$lt&#34;</span>: <span style=color:#e6db74>&#34;$to&#34;</span>}}},
  {<span style=color:#f92672>&#34;$group&#34;</span>: {
    <span style=color:#f92672>&#34;_id&#34;</span>: <span style=color:#e6db74>&#34;$name&#34;</span>,
    <span style=color:#f92672>&#34;total&#34;</span>: {<span style=color:#f92672>&#34;$sum&#34;</span>: <span style=color:#e6db74>&#34;$time&#34;</span>}
  }},
  {<span style=color:#f92672>&#34;$redact&#34;</span>: {
    <span style=color:#f92672>&#34;$cond&#34;</span>: [
      {<span style=color:#f92672>&#34;$gt&#34;</span>: [<span style=color:#e6db74>&#34;$total&#34;</span>, <span style=color:#ae81ff>300</span>]},
      <span style=color:#e6db74>&#34;$$KEEP&#34;</span>,
      <span style=color:#e6db74>&#34;$$PRUNE&#34;</span>
    ]
  }},
  {<span style=color:#f92672>&#34;$sort&#34;</span>: {<span style=color:#f92672>&#34;total&#34;</span>: <span style=color:#ae81ff>-1</span>}},
  {<span style=color:#f92672>&#34;$match&#34;</span>: {<span style=color:#f92672>&#34;_id&#34;</span>: {<span style=color:#f92672>&#34;$nin&#34;</span>: [<span style=color:#e6db74>&#34;一加桌面&#34;</span>, <span style=color:#e6db74>&#34;Root Explorer&#34;</span>, <span style=color:#e6db74>&#34;CaptivePortalLogin&#34;</span>]}}},
  {<span style=color:#f92672>&#34;$project&#34;</span>: {<span style=color:#f92672>&#34;name&#34;</span>: <span style=color:#e6db74>&#34;$_id&#34;</span>, <span style=color:#f92672>&#34;value&#34;</span>: <span style=color:#e6db74>&#34;$total&#34;</span>, <span style=color:#f92672>&#34;_id&#34;</span>: <span style=color:#ae81ff>0</span>}}
]
</code></pre></div><p>Filter by time, sum by name, then filter out applications that have been used for more than 5 minutes, and finally convert the format.</p><p>Line chart of weight:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json>[
  {<span style=color:#f92672>&#34;$match&#34;</span>: {<span style=color:#f92672>&#34;ts&#34;</span>: {<span style=color:#f92672>&#34;$gte&#34;</span>: <span style=color:#e6db74>&#34;$from&#34;</span>, <span style=color:#f92672>&#34;$lt&#34;</span>: <span style=color:#e6db74>&#34;$to&#34;</span>}, <span style=color:#f92672>&#34;value&#34;</span>: {<span style=color:#f92672>&#34;$gte&#34;</span>: <span style=color:#ae81ff>50</span>}}},
  {<span style=color:#f92672>&#34;$sort&#34;</span>: {<span style=color:#f92672>&#34;ts&#34;</span>: <span style=color:#ae81ff>1</span>}},
  {<span style=color:#f92672>&#34;$project&#34;</span>: {<span style=color:#f92672>&#34;name&#34;</span>: <span style=color:#e6db74>&#34;value&#34;</span>, <span style=color:#f92672>&#34;value&#34;</span>: <span style=color:#e6db74>&#34;$value&#34;</span>, <span style=color:#f92672>&#34;ts&#34;</span>: <span style=color:#e6db74>&#34;$ts&#34;</span>, <span style=color:#f92672>&#34;_id&#34;</span>: <span style=color:#ae81ff>0</span>}}
]
</code></pre></div><p>It&rsquo;s very simple. It should be noted that if the returned data is not sorted according to the event, the function of the mouse hover will be messy.</p><p>The data conversion of bar chart, pie chart, and line chart is included in the previous section, all of which can be easily realized by the built-in plug-in. Daily management and event duration are more difficult to do, because Grafana still focuses on the display of time series data. For example, the daily dot chart and scatter chart with a vertical line in the figure are not our business, and we need to rely on the external plugin Plotly.js to support.</p><p>First look at the daily management:</p><p><img src=daily_events.png alt=img></p><p>Each vertical line represents 0 to 24 o&rsquo;clock in a day, and the corresponding event is represented by dots on this line, which can show the trend of various events on many days. In terms of implementation, the data source is still MongoDB:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json>[
    {<span style=color:#f92672>&#34;$match&#34;</span>: {<span style=color:#f92672>&#34;ts&#34;</span>: {<span style=color:#f92672>&#34;$gte&#34;</span>: <span style=color:#e6db74>&#34;$from&#34;</span>, <span style=color:#f92672>&#34;$lt&#34;</span>: <span style=color:#e6db74>&#34;$to&#34;</span>}}},
    {<span style=color:#f92672>&#34;$project&#34;</span>: {<span style=color:#f92672>&#34;name&#34;</span>: <span style=color:#e6db74>&#34;$event&#34;</span>, <span style=color:#f92672>&#34;value&#34;</span>: <span style=color:#ae81ff>1</span>, <span style=color:#f92672>&#34;ts&#34;</span>: <span style=color:#e6db74>&#34;$ts&#34;</span>, <span style=color:#f92672>&#34;_id&#34;</span>: <span style=color:#ae81ff>0</span>}}
]
</code></pre></div><p>Select Plotly Panel in the Panel settings. There are two main configurations, a Layout can set the chart style, and a Script can customize the data processing script.</p><p>Layout:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json>{
  <span style=color:#f92672>&#34;font&#34;</span>: {
    <span style=color:#f92672>&#34;color&#34;</span>: <span style=color:#e6db74>&#34;darkgrey&#34;</span>
  },
  <span style=color:#f92672>&#34;paper_bgcolor&#34;</span>: <span style=color:#e6db74>&#34;rgba(0,0,0,0)&#34;</span>,
  <span style=color:#f92672>&#34;plot_bgcolor&#34;</span>: <span style=color:#e6db74>&#34;rgba(0,0,0,0)&#34;</span>,
  <span style=color:#f92672>&#34;margin&#34;</span>: {
    <span style=color:#f92672>&#34;t&#34;</span>: <span style=color:#ae81ff>10</span>,
    <span style=color:#f92672>&#34;b&#34;</span>: <span style=color:#ae81ff>40</span>
  },
  <span style=color:#f92672>&#34;xaxis&#34;</span>: {
    <span style=color:#f92672>&#34;type&#34;</span>: <span style=color:#e6db74>&#34;date&#34;</span>,
    <span style=color:#f92672>&#34;gridcolor&#34;</span>: <span style=color:#e6db74>&#34;rgb(46, 47, 49)&#34;</span>
  },
  <span style=color:#f92672>&#34;hovermode&#34;</span>: <span style=color:#e6db74>&#34;x&#34;</span>,
  <span style=color:#f92672>&#34;yaxis&#34;</span>: {
    <span style=color:#f92672>&#34;gridcolor&#34;</span>: <span style=color:#e6db74>&#34;rgb(46, 47, 49)&#34;</span>
  }
}
</code></pre></div><p>Script:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-js data-lang=js><span style=color:#66d9ef>let</span> <span style=color:#a6e22e>serieses</span> <span style=color:#f92672>=</span> []

<span style=color:#66d9ef>const</span> <span style=color:#a6e22e>getLocalISOString</span> <span style=color:#f92672>=</span> (<span style=color:#a6e22e>ts</span>) =&gt; {
  <span style=color:#a6e22e>d</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> Date(<span style=color:#a6e22e>ts</span>)
  <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>tzOffset</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>d</span>.<span style=color:#a6e22e>getTimezoneOffset</span>() <span style=color:#f92672>*</span> <span style=color:#ae81ff>60000</span>
  <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>new</span> Date(<span style=color:#a6e22e>d</span> <span style=color:#f92672>-</span> <span style=color:#a6e22e>tzOffset</span>).<span style=color:#a6e22e>toISOString</span>()
}

<span style=color:#66d9ef>for</span> (<span style=color:#66d9ef>let</span> <span style=color:#a6e22e>s</span> <span style=color:#66d9ef>of</span> <span style=color:#a6e22e>data</span>.<span style=color:#a6e22e>series</span>) {
  <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>s</span>.<span style=color:#a6e22e>name</span>) {
    <span style=color:#66d9ef>let</span> <span style=color:#a6e22e>dates</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>s</span>.<span style=color:#a6e22e>fields</span>[<span style=color:#ae81ff>0</span>].<span style=color:#a6e22e>values</span>.<span style=color:#a6e22e>map</span>(<span style=color:#a6e22e>d</span> =&gt; <span style=color:#a6e22e>getLocalISOString</span>(<span style=color:#a6e22e>d</span>).<span style=color:#a6e22e>substr</span>(<span style=color:#ae81ff>0</span>, <span style=color:#ae81ff>10</span>))
    <span style=color:#66d9ef>let</span> <span style=color:#a6e22e>values</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>s</span>.<span style=color:#a6e22e>fields</span>[<span style=color:#ae81ff>0</span>].<span style=color:#a6e22e>values</span>.<span style=color:#a6e22e>map</span>(<span style=color:#a6e22e>d</span> =&gt; <span style=color:#e6db74>&#39;2000-01-01 &#39;</span> <span style=color:#f92672>+</span> <span style=color:#a6e22e>getLocalISOString</span>(<span style=color:#a6e22e>d</span>).<span style=color:#a6e22e>substr</span>(<span style=color:#ae81ff>11</span>, <span style=color:#ae81ff>8</span>))
    <span style=color:#a6e22e>serieses</span>.<span style=color:#a6e22e>push</span>({
      <span style=color:#a6e22e>name</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>s</span>.<span style=color:#a6e22e>name</span>,
      <span style=color:#a6e22e>x</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>dates</span>,
      <span style=color:#a6e22e>y</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>values</span>,
      <span style=color:#a6e22e>type</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;scatter&#39;</span>,
      <span style=color:#a6e22e>mode</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;markers&#39;</span>,
      <span style=color:#a6e22e>marker</span><span style=color:#f92672>:</span> { <span style=color:#a6e22e>size</span><span style=color:#f92672>:</span> <span style=color:#ae81ff>12</span> },
    })
  }
}

<span style=color:#66d9ef>return</span> {
  <span style=color:#a6e22e>data</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>serieses</span>,
  <span style=color:#a6e22e>layout</span><span style=color:#f92672>:</span> {
    <span style=color:#a6e22e>xaxis</span><span style=color:#f92672>:</span> {
      <span style=color:#a6e22e>tickformat</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;&#39;</span>,
    },
    <span style=color:#a6e22e>yaxis</span><span style=color:#f92672>:</span> {
      <span style=color:#a6e22e>tickformat</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;%X&#39;</span>,
      <span style=color:#a6e22e>range</span><span style=color:#f92672>:</span> [<span style=color:#e6db74>&#39;2000-01-01 23:59:59&#39;</span>, <span style=color:#e6db74>&#39;2000-01-01 00:00:00&#39;</span>]
    }
  }
}
</code></pre></div><p>The main thing the script does is to traverse all events and set the x value of each event to the day and the y value to the time of the day. There is a very uncomfortable problem. When the mouse hovers over the corresponding column, only the first one of the same event of the day will display the label. That is to say, if you fall asleep multiple times that day, only the first fall asleep time will be displayed. come out. This problem is mentioned in an issue in the official warehouse, but no one has solved it, but I am very uncomfortable, so I simply changed it myself so that the same column can display multiple labels of the same type. The specific commit is in<a href=https://github.com/ssine/plotly.js/commit/adda7fae1358443e5a36b1eafb91541b6c4b61df>Here</a> , Recompile and overwrite the corresponding files in the Grafana plug-in directory to use it, also under the original issue<a href=https://github.com/plotly/plotly.js/issues/4294#issuecomment-755398700>Feedback</a> 。</p><p>The following is the statistical distribution of the duration of various events. The horizontal axis is the start time of the event, and the vertical axis is the end time of the event. In this way<code>y = - x + b</code> The point on the line is the &ldquo;isochronous line&rdquo; where the event time is b. Multiple points can easily see the statistical law of various times, such as work:</p><p><img src=event_work.png alt=img></p><p>And sleep:</p><p><img src=event_sleep.png alt=img></p><p>. The realization of the data source and layout is similar to the above, the data processing script:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-js data-lang=js><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>getLocalISOString</span> <span style=color:#f92672>=</span> (<span style=color:#a6e22e>ts</span>) =&gt; {
  <span style=color:#a6e22e>d</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> Date(<span style=color:#a6e22e>ts</span>)
  <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>tzOffset</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>d</span>.<span style=color:#a6e22e>getTimezoneOffset</span>() <span style=color:#f92672>*</span> <span style=color:#ae81ff>60000</span>
  <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>new</span> Date(<span style=color:#a6e22e>d</span> <span style=color:#f92672>-</span> <span style=color:#a6e22e>tzOffset</span>).<span style=color:#a6e22e>toISOString</span>()
}

<span style=color:#66d9ef>let</span> <span style=color:#a6e22e>series</span> <span style=color:#f92672>=</span> []

<span style=color:#66d9ef>for</span> (<span style=color:#66d9ef>let</span> <span style=color:#a6e22e>hour</span> <span style=color:#66d9ef>of</span> [<span style=color:#ae81ff>1</span>, <span style=color:#ae81ff>3</span>, <span style=color:#ae81ff>6</span>, <span style=color:#ae81ff>9</span>, <span style=color:#ae81ff>12</span>]) {
  <span style=color:#66d9ef>let</span> <span style=color:#a6e22e>duration</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>hour</span> <span style=color:#f92672>*</span> <span style=color:#ae81ff>3600000</span>
  <span style=color:#66d9ef>let</span> <span style=color:#a6e22e>y_start</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>duration</span>
  <span style=color:#66d9ef>let</span> <span style=color:#a6e22e>x_end</span> <span style=color:#f92672>=</span> (<span style=color:#ae81ff>24</span> <span style=color:#f92672>-</span> <span style=color:#a6e22e>hour</span>) <span style=color:#f92672>*</span> <span style=color:#ae81ff>3600000</span>
  <span style=color:#a6e22e>series</span>.<span style=color:#a6e22e>push</span>({
    <span style=color:#a6e22e>name</span><span style=color:#f92672>:</span> <span style=color:#e6db74>`</span><span style=color:#e6db74>${</span><span style=color:#a6e22e>hour</span><span style=color:#e6db74>}</span><span style=color:#e6db74> 小时`</span>,
    <span style=color:#a6e22e>x</span><span style=color:#f92672>:</span> [<span style=color:#e6db74>&#39;2000-01-01 00:00:00&#39;</span>, <span style=color:#e6db74>&#39;2000-01-01 &#39;</span> <span style=color:#f92672>+</span> (<span style=color:#66d9ef>new</span> Date(<span style=color:#a6e22e>x_end</span>).<span style=color:#a6e22e>toISOString</span>()).<span style=color:#a6e22e>substr</span>(<span style=color:#ae81ff>11</span>, <span style=color:#ae81ff>8</span>)],
    <span style=color:#a6e22e>y</span><span style=color:#f92672>:</span> [<span style=color:#e6db74>&#39;2000-01-01 &#39;</span> <span style=color:#f92672>+</span> (<span style=color:#66d9ef>new</span> Date(<span style=color:#a6e22e>y_start</span>).<span style=color:#a6e22e>toISOString</span>()).<span style=color:#a6e22e>substr</span>(<span style=color:#ae81ff>11</span>, <span style=color:#ae81ff>8</span>), <span style=color:#e6db74>&#39;2000-01-01 23:59:59&#39;</span>],
    <span style=color:#a6e22e>opacity</span><span style=color:#f92672>:</span> <span style=color:#ae81ff>0.5</span>,
    <span style=color:#a6e22e>mode</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;lines&#39;</span>,
    <span style=color:#a6e22e>line</span><span style=color:#f92672>:</span> {
      <span style=color:#a6e22e>width</span><span style=color:#f92672>:</span> <span style=color:#ae81ff>1</span>,
    }
  })
}

<span style=color:#66d9ef>const</span> <span style=color:#a6e22e>plotEvent</span> <span style=color:#f92672>=</span> (<span style=color:#a6e22e>name</span>, <span style=color:#a6e22e>entryNames</span>, <span style=color:#a6e22e>leaveNames</span>) =&gt; {
  <span style=color:#66d9ef>let</span> <span style=color:#a6e22e>events</span> <span style=color:#f92672>=</span> []

  <span style=color:#66d9ef>for</span> (<span style=color:#66d9ef>let</span> <span style=color:#a6e22e>s</span> <span style=color:#66d9ef>of</span> <span style=color:#a6e22e>data</span>.<span style=color:#a6e22e>series</span>) {
    <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>entryNames</span>.<span style=color:#a6e22e>includes</span>(<span style=color:#a6e22e>s</span>.<span style=color:#a6e22e>name</span>) <span style=color:#f92672>||</span> <span style=color:#a6e22e>leaveNames</span>.<span style=color:#a6e22e>includes</span>(<span style=color:#a6e22e>s</span>.<span style=color:#a6e22e>name</span>)) {
      <span style=color:#a6e22e>events</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>events</span>.<span style=color:#a6e22e>concat</span>(<span style=color:#a6e22e>s</span>.<span style=color:#a6e22e>fields</span>[<span style=color:#ae81ff>0</span>].<span style=color:#a6e22e>values</span>.<span style=color:#a6e22e>map</span>(<span style=color:#a6e22e>d</span> =&gt; ({
        <span style=color:#a6e22e>name</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>s</span>.<span style=color:#a6e22e>name</span>,
        <span style=color:#a6e22e>ts</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>d</span>
      })))
    }
  }
  
  <span style=color:#a6e22e>events</span>.<span style=color:#a6e22e>sort</span>((<span style=color:#a6e22e>a</span>, <span style=color:#a6e22e>b</span>) =&gt; <span style=color:#a6e22e>a</span>.<span style=color:#a6e22e>ts</span> <span style=color:#f92672>-</span> <span style=color:#a6e22e>b</span>.<span style=color:#a6e22e>ts</span>)
  
  <span style=color:#66d9ef>let</span> <span style=color:#a6e22e>lastTime</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>null</span>;
  <span style=color:#66d9ef>let</span> <span style=color:#a6e22e>xs</span> <span style=color:#f92672>=</span> [], <span style=color:#a6e22e>ys</span> <span style=color:#f92672>=</span> [];
  
  <span style=color:#66d9ef>for</span> (<span style=color:#66d9ef>let</span> <span style=color:#a6e22e>ev</span> <span style=color:#66d9ef>of</span> <span style=color:#a6e22e>events</span>) {
    <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>entryNames</span>.<span style=color:#a6e22e>includes</span>(<span style=color:#a6e22e>ev</span>.<span style=color:#a6e22e>name</span>)) {
      <span style=color:#a6e22e>lastTime</span> <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;2000-01-01 &#39;</span> <span style=color:#f92672>+</span> <span style=color:#a6e22e>getLocalISOString</span>(<span style=color:#a6e22e>ev</span>.<span style=color:#a6e22e>ts</span>).<span style=color:#a6e22e>substr</span>(<span style=color:#ae81ff>11</span>, <span style=color:#ae81ff>8</span>)
    } <span style=color:#66d9ef>else</span> <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>lastTime</span>) {
      <span style=color:#a6e22e>xs</span>.<span style=color:#a6e22e>push</span>(<span style=color:#a6e22e>lastTime</span>)
      <span style=color:#a6e22e>ys</span>.<span style=color:#a6e22e>push</span>(<span style=color:#e6db74>&#39;2000-01-01 &#39;</span> <span style=color:#f92672>+</span> <span style=color:#a6e22e>getLocalISOString</span>(<span style=color:#a6e22e>ev</span>.<span style=color:#a6e22e>ts</span>).<span style=color:#a6e22e>substr</span>(<span style=color:#ae81ff>11</span>, <span style=color:#ae81ff>8</span>))
      <span style=color:#a6e22e>lastTime</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>null</span>
    }
  }
  
  <span style=color:#a6e22e>series</span>.<span style=color:#a6e22e>push</span>({
    <span style=color:#a6e22e>name</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>name</span>,
    <span style=color:#a6e22e>x</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>xs</span>,
    <span style=color:#a6e22e>y</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>ys</span>,
    <span style=color:#a6e22e>type</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;scatter&#39;</span>,
    <span style=color:#a6e22e>mode</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;markers&#39;</span>,
  })
}

<span style=color:#a6e22e>plotEvent</span>(<span style=color:#e6db74>&#39;sleep&#39;</span>, [<span style=color:#e6db74>&#39;睡着&#39;</span>], [<span style=color:#e6db74>&#39;醒来&#39;</span>])
<span style=color:#a6e22e>plotEvent</span>(<span style=color:#e6db74>&#39;work&#39;</span>, [<span style=color:#e6db74>&#39;到公司&#39;</span>], [<span style=color:#e6db74>&#39;离公司&#39;</span>, <span style=color:#e6db74>&#39;到家&#39;</span>])

<span style=color:#66d9ef>return</span> {
  <span style=color:#a6e22e>data</span><span style=color:#f92672>:</span> <span style=color:#a6e22e>series</span>,
  <span style=color:#a6e22e>layout</span><span style=color:#f92672>:</span> {
    <span style=color:#a6e22e>xaxis</span><span style=color:#f92672>:</span> {
      <span style=color:#a6e22e>tickformat</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;%X&#39;</span>,
      <span style=color:#a6e22e>title</span><span style=color:#f92672>:</span> {
        <span style=color:#a6e22e>text</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;开始时间&#39;</span>
      }
    },
    <span style=color:#a6e22e>yaxis</span><span style=color:#f92672>:</span> {
      <span style=color:#a6e22e>tickformat</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;%X&#39;</span>,
      <span style=color:#a6e22e>autorange</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;reversed&#39;</span>,
      <span style=color:#a6e22e>title</span><span style=color:#f92672>:</span> {
        <span style=color:#a6e22e>text</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;结束时间&#39;</span>
      }
    },
    <span style=color:#a6e22e>hovermode</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#39;closest&#39;</span>
  }
}
</code></pre></div><p>It’s more troublesome here. First, find out all the state duration intervals according to the start time and end time of a state, and then calculate the start time and end time for x and y, and finally unify all dates into the same day.</p><h1 id=to-sum-up>to sum up</h1><p>Doing these things is mainly out of interest (perhaps also the love of life?), in retrospect, it is also a long journey, doing various things and integrating them in turn. A lot of scripts were also written in this process. Tasker is especially interesting. The task uses the mobile phone as the running environment. This is perhaps the most relevant to the real world in the project I wrote. At the same time, I have done a lot of thinking about the management of life, energy, and health. I hope this system can accompany me for a period of time.</p></div><footer></footer></article><script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script><script id=MathJax-script async src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script><script>MathJax={tex:{inlineMath:[['$','$'],['\\(','\\)']],processEscapes:true,processEnvironments:true},options:{skipHtmlTags:['script','noscript','style','textarea','pre']}};</script></section></div><footer class=footer><section class=container><p>© 2016 - 2023 Sine Liu</p></section></footer></main><script src=https://ssine.ink/js/dark-mode.min.0213e1773e6d1c5a644f847c67a6f8abac49a3776e2976f6008038af8c5b76a1.js></script><script type=application/javascript>var doNotTrack=false;if(!doNotTrack){(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');ga('create','UA-127064931-1','auto');ga('send','pageview');}</script></body></html>
<!doctype html><html lang=en><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta http-equiv=content-language content="en"><meta name=author content="Sine"><meta name=description content="Note: This article is mainly translated by Google translator, please turn to the Chinese version for more accurate expression if possible.
I usually like to toss something at home. For many services, soft routing is an infrastructure. The concept of soft routing is opposite to hard routing. Hard routing refers to a device that forwards network packets by proprietary hardware, while soft routing is a device that forwards network packets by a general-purpose computer through software."><meta name=keywords content="blog,developer,personal"><meta name=twitter:card content="summary"><meta name=twitter:title content="Soft routing and home network configuration"><meta name=twitter:description content="Note: This article is mainly translated by Google translator, please turn to the Chinese version for more accurate expression if possible.
I usually like to toss something at home. For many services, soft routing is an infrastructure. The concept of soft routing is opposite to hard routing. Hard routing refers to a device that forwards network packets by proprietary hardware, while soft routing is a device that forwards network packets by a general-purpose computer through software."><meta property="og:title" content="Soft routing and home network configuration"><meta property="og:description" content="Note: This article is mainly translated by Google translator, please turn to the Chinese version for more accurate expression if possible.
I usually like to toss something at home. For many services, soft routing is an infrastructure. The concept of soft routing is opposite to hard routing. Hard routing refers to a device that forwards network packets by proprietary hardware, while soft routing is a device that forwards network packets by a general-purpose computer through software."><meta property="og:type" content="article"><meta property="og:url" content="https://ssine.ink/en/posts/soft-router/"><meta property="article:published_time" content="2021-04-13T23:20:35+08:00"><meta property="article:modified_time" content="2021-04-13T23:20:35+08:00"><title>Soft routing and home network configuration · Sine's Site</title><link rel=canonical href=https://ssine.ink/en/posts/soft-router/><link rel=preconnect href=https://fonts.gstatic.com><link href="https://fonts.googleapis.com/css?family=Lato:400,700%7CMerriweather:300,700%7CSource+Code+Pro:400,700&display=swap" rel=stylesheet><link rel=preload href="https://ssine.ink/fonts/forkawesome-webfont.woff2?v=1.1.7" as=font type=font/woff2 crossorigin><link rel=stylesheet href=https://ssine.ink/css/coder.min.a050bb9724f6a498b574acf612d6d523bc68756ddc62579923710a8542947c52.css integrity="sha256-oFC7lyT2pJi1dKz2EtbVI7xodW3cYleZI3EKhUKUfFI=" crossorigin=anonymous media=screen><link rel=stylesheet href=https://ssine.ink/css/coder-dark.min.126ad3988d46bdae6217a11105b53c9662bca05f39d42d3c0fb366919d334620.css integrity="sha256-EmrTmI1Gva5iF6ERBbU8lmK8oF851C08D7NmkZ0zRiA=" crossorigin=anonymous media=screen><link rel=icon type=image/png href=https://ssine.ink/favicon.ico sizes=32x32><link rel=icon type=image/png href=https://ssine.ink/favicon.ico sizes=16x16><link rel=apple-touch-icon href=https://ssine.ink/images/apple-touch-icon.png><link rel=apple-touch-icon sizes=180x180 href=https://ssine.ink/images/apple-touch-icon.png><meta name=generator content="Hugo 0.74.1"></head><body class=colorscheme-auto><div class=float-container><a id=dark-mode-toggle class=colorscheme-toggle><i class="fa fa-adjust fa-fw" aria-hidden=true></i></a></div><main class=wrapper><nav class=navigation><section class=container><a class=navigation-title href=https://ssine.ink/en>Sine's Site</a>
<input type=checkbox id=menu-toggle>
<label class="menu-button float-right" for=menu-toggle><i class="fa fa-bars fa-fw" aria-hidden=true></i></label><ul class=navigation-list><li class=navigation-item><a class=navigation-link href=https://ssine.ink/en/posts/>Blog</a></li><li class=navigation-item><a class=navigation-link href=https://kiwi.ssine.cc>Wiki</a></li><li class=navigation-item><a class=navigation-link href=https://ssine.ink/en/gallery>Gallery</a></li><li class=navigation-item><a class=navigation-link href=https://ssine.ink/en/projects/>Projects</a></li><li class="navigation-item menu-separator"><span>|</span></li><li class=navigation-item><a href=https://ssine.ink/posts/soft-router/>中文</a></li></ul></section></nav><div class=content><section class="container post"><article><header><div class=post-title><h1 class=title>Soft routing and home network configuration</h1></div><div class=post-meta><div class=date><span class=posted-on><i class="fa fa-calendar" aria-hidden=true></i><time datetime=2021-04-13T23:20:35+08:00>April 13, 2021</time></span>
<span class=reading-time><i class="fa fa-clock-o" aria-hidden=true></i>7-minute read</span></div></div></header><div><p><strong>Note: This article is mainly translated by Google translator, please turn to the Chinese version for more accurate expression if possible.</strong></p><p>I usually like to toss something at home. For many services, soft routing is an infrastructure. The concept of soft routing is opposite to hard routing. Hard routing refers to a device that forwards network packets by proprietary hardware, while soft routing is a device that forwards network packets by a general-purpose computer through software. Compared with hard routing at the same price, soft routing has better hardware and higher configurability, but it requires certain network knowledge to be effective. Let&rsquo;s briefly talk about the deployment and functions of soft routing.</p><h1 id=equipment-and-system>Equipment and system</h1><p>Compared with ordinary computers, soft routers have several main features: more network ports, low power consumption, and small size. The soft routing device must have at least two network ports, one WAN port is used to connect to the public network, and one LAN port is connected to the local area network (but only one network port is enough for the bypass device). Because it needs 24 hours of uninterrupted operation, the power consumption is usually low and stable, and the size is small and convenient to be placed in a weak current box.</p><p>In terms of system, it is usually formed by adding customized software sources and related software on the basis of the Linux kernel. The more well-known ones are OpenWRT and Merlin. If you are brushing the system on a hard route, you need to see whether the hardware supports it. I bought NanoPi R2S as a soft router because the memory of the router I bought before was too low, and it came with a customized system, FriendlyWRT. The previous wireless router was only used as a wireless access point.</p><h1 id=network-topology>Network topology</h1><center><embed src=topo.svg type=image/svg+xml></center><p>The above is the current network topology of my home. Unicom broadband optical fiber is connected to the optical modem. After modulation, the network cable is connected to the soft router WAN port. The LAN port is connected in series with two routers. The router has its own Mesh function. Turn off DHCP and use it as a pure wireless AP.</p><h1 id=features>Features</h1><p>The device and network topology are introduced above, and the software deployment and the realization of various functions are discussed below.</p><h2 id=network-dialing>Network dialing</h2><p>The optical modem of China Unicom&rsquo;s broadband installation comes with its own dial-up and wireless functions, but if the optical modem dials, it cannot use DDNS to penetrate the intranet. (At the beginning, because of the public IP and want DDNS, I tossed for a long time for soft routing dialing. After that, the public IP is gone, so here the optical modem is only used for modem, and the soft router is responsible for dialing. For the benefits of soft routing dialing, please refer to<a href=https://v2ex.com/t/681901#r_9123965>Here</a> 。</p><p>There are two main things you need to do if you want to use soft routing to dial:</p><ol><li>Change the light cat to bridge mode</li><li>Get broadband username and password</li></ol><p>The first item differs depending on the device model and requires a lot of tricks. For the optical cat of China Unicom, you can refer to these two articles:</p><ul><li><a href=https://blog.51cto.com/hatech/2521226>Modified Unicom optical modem to bridge mode (Beijing area)</a></li><li><a href=https://bygeek.cn/2019/08/18/Change-Optical-modem-to-bridge-mode/>Remember the experience of modifying Unicom Optical Cat to bridge mode</a></li></ul><p>The second item needs to be remembered when installing broadband, or call China Unicom to reset the password.</p><p>Then configure the WAN port dial-up in the soft routing interface Network -> Interface.</p><h2 id=global-vpn>Global VPN</h2><p>PassWall is a good plugin that supports socks, ss, ssr, v2ray, brook and trojan. You can directly subscribe to the airport link and update it regularly. There is also a load balancing function. Nodes of the same protocol can be combined together, and network traffic is automatically distributed by load balancing, which can make full use of multiple nodes in the airport.</p><p>There are already many tutorials on the specific configuration, so I won’t go into details here. The page of PassWall itself is also relatively intuitive.</p><h3 id=host-accelerator>Host accelerator</h3><p>If you want to use it for Switch, ordinary ladders are not enough. Delay and stability are both problems, and special accelerators are usually needed. I looked around and found<a href=https://www.lingti.com/>Greyhound</a> There is a router plug-in. After downloading and running on the router, it can be controlled on the mobile phone. The Switch can enjoy the acceleration without any operation.</p><h2 id=internet-access>Internet access</h2><p>If there is a local service that needs to be exposed to the public network, it is usually necessary to bind the IP to the domain name (DNS resolution) and access it through the domain name. However, home broadband generally does not have a fixed IP or public network IP. At this time, DDNS is required to dynamically bind it. Set a changed public IP, or use external services for intranet penetration.</p><h3 id=ddns>DDNS</h3><p>If the home broadband itself has a public network IP, then DDNS can be used to expose the service to the public network. The principle of DDNS is very simple. It is to keep obtaining your own IP. Once you find that the IP has changed, you should request a domain name resolution service provider to resolve a specific domain name to your current IP. In this way, even if the IP changes, you can pass Domain name access to the same service.</p><p>There are also some disadvantages to this. First of all, due to policy reasons, telecom operators in most areas of China do not open ports 80 and 443 of home broadband IP. This results in the services we build can only provide services through non-standard ports. Regarding non-standard ports My previous article<a href=https://ssine.ink/posts/caddy-non-443-port-https/>Use Caddy to enable HTTPS on ports other than 443</a> Also mentioned. The second point is that DDNS only changes the DNS resolution after the IP has changed, which causes the service to be inaccessible during the period from the IP change to when the resolution takes effect.</p><h3 id=frp-intranet-penetration>FRP intranet penetration</h3><p>If there is no public IP, you can only find a way to penetrate the internal network. A more complete solution is FRP. You need a server with a public IP, bind the domain name to the server, and run the FRP service on the server. In this way, the FRP client on the soft route can connect to the FRP service, and supports the dynamic addition and deletion of the binding relationship between the domain name and the local IP on the client. If there is no independent server, there are many public service intranet penetration services that can be used online.</p><p>The disadvantages of FRP are that the delay will become higher and the need to purchase additional cloud hosts, but the stability of the service is much stronger than that of DDNS.</p><h2 id=intranet-static-ip-dns-hijacking>Intranet static IP, DNS hijacking</h2><p>Intranet services can be accessed directly using the intranet IP. For convenience, you can add a permanent fixed IP to the device at the soft-routed Network -> DHCP/DNS.</p><p>There is another interesting question. For example, I set up a cloud disk service on the intranet, located at 192.168.2.86, and bound it with the public domain name drive.abc.com through intranet penetration. Then access the cloud disk through drive.abc.com, the data packets will go to the local &lt;->FRP server &lt;->local route, which will increase the traffic of the FRP server and the bandwidth will also be restricted. It is indeed possible to access directly through the intranet IP 192.168.2.86, but in this way the cookie and other information in drive.abc.com cannot be shared, which is not elegant. In order to allow the same domain name to be directly connected to the internal network and use FRP on the public network, we can hijack the drive.abc.com domain name of the internal network and point it directly to 192.168.2.86, so that the above effect can be achieved, but this requires The client DNS points to the soft route. This is the default if the networked device does not have special settings. Just start dnsmasq and DNS redirection on the soft route. The function of setting a custom hijacked domain name is also on the Network -> DHCP/DNS page.</p></div><footer></footer></article><script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script><script id=MathJax-script async src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script><script>MathJax={tex:{inlineMath:[['$','$'],['\\(','\\)']],processEscapes:true,processEnvironments:true},options:{skipHtmlTags:['script','noscript','style','textarea','pre']}};</script></section></div><footer class=footer><section class=container><p>© 2016 - 2023 Sine Liu</p></section></footer></main><script src=https://ssine.ink/js/dark-mode.min.0213e1773e6d1c5a644f847c67a6f8abac49a3776e2976f6008038af8c5b76a1.js></script><script type=application/javascript>var doNotTrack=false;if(!doNotTrack){(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');ga('create','UA-127064931-1','auto');ga('send','pageview');}</script></body></html>
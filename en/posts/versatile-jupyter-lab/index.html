<!doctype html><html lang=en><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta http-equiv=content-language content="en"><meta name=author content="Sine"><meta name=description content="Note: This article is automatically translated, please turn to the Chinese version for more accurate expression if possible.
Usually there are some small ideas that need to be tested. For example, to see if TypeScript can support this syntax, use Python to do two questions and quickly process some files. At this time, it is more cumbersome to open an editor to write a script and then run it. Putting the environment of various languages on the machine is also messy and not portable."><meta name=keywords content="blog,developer,personal"><meta name=twitter:card content="summary"><meta name=twitter:title content="Building a Jupyter Lab Container with Multiple Kernels"><meta name=twitter:description content="Note: This article is automatically translated, please turn to the Chinese version for more accurate expression if possible.
Usually there are some small ideas that need to be tested. For example, to see if TypeScript can support this syntax, use Python to do two questions and quickly process some files. At this time, it is more cumbersome to open an editor to write a script and then run it. Putting the environment of various languages on the machine is also messy and not portable."><meta property="og:title" content="Building a Jupyter Lab Container with Multiple Kernels"><meta property="og:description" content="Note: This article is automatically translated, please turn to the Chinese version for more accurate expression if possible.
Usually there are some small ideas that need to be tested. For example, to see if TypeScript can support this syntax, use Python to do two questions and quickly process some files. At this time, it is more cumbersome to open an editor to write a script and then run it. Putting the environment of various languages on the machine is also messy and not portable."><meta property="og:type" content="article"><meta property="og:url" content="https://ssine.ink/en/posts/versatile-jupyter-lab/"><meta property="article:published_time" content="2021-03-07T19:08:13+08:00"><meta property="article:modified_time" content="2021-03-07T19:08:13+08:00"><title>Building a Jupyter Lab Container with Multiple Kernels · Sine's Site</title><link rel=canonical href=https://ssine.ink/en/posts/versatile-jupyter-lab/><link rel=preconnect href=https://fonts.gstatic.com><link href="https://fonts.googleapis.com/css?family=Lato:400,700%7CMerriweather:300,700%7CSource+Code+Pro:400,700&display=swap" rel=stylesheet><link rel=preload href="https://ssine.ink/fonts/forkawesome-webfont.woff2?v=1.1.7" as=font type=font/woff2 crossorigin><link rel=stylesheet href=https://ssine.ink/css/coder.min.a050bb9724f6a498b574acf612d6d523bc68756ddc62579923710a8542947c52.css integrity="sha256-oFC7lyT2pJi1dKz2EtbVI7xodW3cYleZI3EKhUKUfFI=" crossorigin=anonymous media=screen><link rel=stylesheet href=https://ssine.ink/css/coder-dark.min.126ad3988d46bdae6217a11105b53c9662bca05f39d42d3c0fb366919d334620.css integrity="sha256-EmrTmI1Gva5iF6ERBbU8lmK8oF851C08D7NmkZ0zRiA=" crossorigin=anonymous media=screen><link rel=icon type=image/png href=https://ssine.ink/favicon.ico sizes=32x32><link rel=icon type=image/png href=https://ssine.ink/favicon.ico sizes=16x16><link rel=apple-touch-icon href=https://ssine.ink/images/apple-touch-icon.png><link rel=apple-touch-icon sizes=180x180 href=https://ssine.ink/images/apple-touch-icon.png><meta name=generator content="Hugo 0.74.1"></head><body class=colorscheme-auto><div class=float-container><a id=dark-mode-toggle class=colorscheme-toggle><i class="fa fa-adjust fa-fw" aria-hidden=true></i></a></div><main class=wrapper><nav class=navigation><section class=container><a class=navigation-title href=https://ssine.ink/en>Sine's Site</a>
<input type=checkbox id=menu-toggle>
<label class="menu-button float-right" for=menu-toggle><i class="fa fa-bars fa-fw" aria-hidden=true></i></label><ul class=navigation-list><li class=navigation-item><a class=navigation-link href=https://ssine.ink/en/posts/>Blog</a></li><li class=navigation-item><a class=navigation-link href=https://kiwi.ssine.cc>Wiki</a></li><li class=navigation-item><a class=navigation-link href=https://ssine.ink/en/gallery>Gallery</a></li><li class=navigation-item><a class=navigation-link href=https://ssine.ink/en/projects/>Projects</a></li><li class="navigation-item menu-separator"><span>|</span></li><li class=navigation-item><a href=https://ssine.ink/posts/versatile-jupyter-lab/>中文</a></li></ul></section></nav><div class=content><section class="container post"><article><header><div class=post-title><h1 class=title>Building a Jupyter Lab Container with Multiple Kernels</h1></div><div class=post-meta><div class=date><span class=posted-on><i class="fa fa-calendar" aria-hidden=true></i><time datetime=2021-03-07T19:08:13+08:00>March 7, 2021</time></span>
<span class=reading-time><i class="fa fa-clock-o" aria-hidden=true></i>5-minute read</span></div></div></header><div><p><strong>Note: This article is automatically translated, please turn to the Chinese version for more accurate expression if possible.</strong></p><p>Usually there are some small ideas that need to be tested. For example, to see if TypeScript can support this syntax, use Python to do two questions and quickly process some files. At this time, it is more cumbersome to open an editor to write a script and then run it. Putting the environment of various languages on the machine is also messy and not portable. Therefore, a Jupyter Lab service was deployed, which can be written through the browser anytime, anywhere. Ideas for codes in various languages.</p><p>At present, Jupyter Lab is well received by the community, and Jupyter&rsquo;s Kernel has been implemented in various languages (see<a href=https://github.com/jupyter/jupyter/wiki/Jupyter-kernels>Documentation</a> ). I have selected several languages that are commonly used by myself for integration (usually there are several Kernel implementations in a language, and I have selected the more complete ones):</p><ul><li>GoLang -<a href=https://github.com/gopherdata/gophernotes>gophernotes</a></li><li>TypeScript & JavaScript - <a href=https://github.com/yunabe/tslab>tslab</a></li><li>C++11/14/17 - <a href=https://github.com/jupyter-xeus/xeus-cling>xeus-cling</a></li><li>Racket - <a href=https://github.com/rmculpepper/iracket>iracket</a></li><li>Ladder -<a href=https://github.com/almond-sh/almond>almond</a></li><li>Java - <a href=https://github.com/SpencerPark/IJava>IJava</a></li></ul><p>At present, this image has been made public on Docker Hub, and the method of use:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>docker run -d <span style=color:#ae81ff>\
</span><span style=color:#ae81ff></span>  --name<span style=color:#f92672>=</span>jupyter <span style=color:#ae81ff>\
</span><span style=color:#ae81ff></span>  -e LABUID<span style=color:#f92672>=</span><span style=color:#ae81ff>1000</span> <span style=color:#ae81ff>\
</span><span style=color:#ae81ff></span>  -e LABGID<span style=color:#f92672>=</span><span style=color:#ae81ff>1000</span> <span style=color:#ae81ff>\
</span><span style=color:#ae81ff></span>  -e LABPASSWD<span style=color:#f92672>=</span>userpassword <span style=color:#ae81ff>\
</span><span style=color:#ae81ff></span>  -e JUPYTER_TOKEN<span style=color:#f92672>=</span>token_to_jupyter_page <span style=color:#ae81ff>\
</span><span style=color:#ae81ff></span>  -p 80:8080 <span style=color:#ae81ff>\
</span><span style=color:#ae81ff></span>  -v /home/user/lab:/data <span style=color:#ae81ff>\
</span><span style=color:#ae81ff></span>  --restart unless-stopped <span style=color:#ae81ff>\
</span><span style=color:#ae81ff></span>  sineliu/jupyterlab-all-in-one:latest
</code></pre></div><p><img src=screenshot.png alt=screenshot></p><h2 id=some-implementation-details>Some implementation details</h2><p>The matter is very simple, but there are many problems to be solved when doing it. Let&rsquo;s talk briefly about it below.</p><h3 id=specify-jupyter-lab-password>Specify Jupyter Lab password</h3><p>Jupyter Lab usually generates a token after startup to log in in the browser, but this method is not convenient for users to log in again after a period of time (the token is easy to lose). There are two solutions, one is to log in with a username and password, and the other is to specify a Token. The user name and password login methods require cumbersome configuration. Fortunately, Jupyter Lab supports the use of environment variables<a href="https://jupyter-notebook.readthedocs.io/en/stable/config.html?highlight=JUPYTER_TOKEN#options">JUPYTER_TOKEN</a> Specify the Token, this thing is difficult to search, it took a long time to find the document (really a long time!). In this way, a Token that is easy to remember can be fixed by setting environment variables.</p><h3 id=avoid-problems-with-docker-root-permissions-by-customizing-users>Avoid problems with Docker Root permissions by customizing users</h3><p>The Docker container runs as the root user by default, which causes the owners of files created under the container to be root. I don&rsquo;t know if there is an official solution for docker. I finally achieved it by creating a user when the container was first started. This process is divided into two steps. The first is to identify the first startup (otherwise, an error will be reported when the user is created again at restart), and the second is to create a user with a specified password in a non-interactive way.</p><p>At the beginning, there was no idea of starting the script for the first time. I found that a file can be used as a flag. If the file does not exist, it is the first time. Then the file is created. After the file exists, it is known that it is not the first time to start.</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=color:#66d9ef>if</span> test -e /tmp/fr; <span style=color:#66d9ef>then</span> <span style=color:#ae81ff>\
</span><span style=color:#ae81ff></span>  regular script <span style=color:#ae81ff>\
</span><span style=color:#ae81ff></span><span style=color:#66d9ef>else</span> <span style=color:#ae81ff>\
</span><span style=color:#ae81ff></span>  touch /tmp/fr <span style=color:#ae81ff>\
</span><span style=color:#ae81ff></span>  initialization script <span style=color:#ae81ff>\
</span><span style=color:#ae81ff></span><span style=color:#66d9ef>fi</span>
</code></pre></div><p>After that, the user who creates the specified password non-interactively, generally changes the password interactively (the user needs to manually enter the password on the command line), fortunately<code>chpasswd</code> The command supports streaming input so that it can be used<code>|</code> The symbol sets the password, and the mirror will read three environment variables:</p><ul><li>LABUID: uid</li><li>LABGID: gid</li><li>LABPASSWD: User password</li></ul><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>groupadd -g <span style=color:#e6db74>${</span>LABGID<span style=color:#e6db74>}</span> username
useradd -u <span style=color:#e6db74>${</span>LABUID<span style=color:#e6db74>}</span> -g <span style=color:#e6db74>${</span>LABGID<span style=color:#e6db74>}</span> -G wheel username
echo <span style=color:#e6db74>&#34;username:</span><span style=color:#e6db74>${</span>LABPASSWD<span style=color:#e6db74>}</span><span style=color:#e6db74>&#34;</span> | chpasswd
</code></pre></div><p>First create a group with a specified group id, then create a user, and assign the specified user id and group id, and add it to the wheel user group to give the user root privileges. Finally, use echo + pip to avoid chpasswd from requiring interactive input and password setting.</p><h3 id=fight-the-internet>Fight the internet</h3><p>The domestic network environment will be slow, stuck or even interrupted when accessing many external network resources. This problem is particularly obvious in the Docker build process, because there are many resources to download. The more commonly used resources are usually from domestic sources, and many rare installation packages can only be tried a few more times. How to<code>curl</code> When the download fails, it does not report an error but retry silently? It can be done in a loop:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=color:#66d9ef>for</span> i in <span style=color:#ae81ff>1</span> <span style=color:#ae81ff>2</span> <span style=color:#ae81ff>3</span> <span style=color:#ae81ff>4</span> 5; <span style=color:#66d9ef>do</span> <span style=color:#ae81ff>\
</span><span style=color:#ae81ff></span>  curl -L https://git.io/vQhTU | bash <span style=color:#f92672>&amp;&amp;</span> break <span style=color:#ae81ff>\
</span><span style=color:#ae81ff></span>  <span style=color:#f92672>||</span> sleep 1; <span style=color:#ae81ff>\
</span><span style=color:#ae81ff></span><span style=color:#66d9ef>done</span>
</code></pre></div><p>The entire loop will retry 5 times. Once the script executes normally and no error is reported, it will break to exit the loop, otherwise it will retry after sleeping for 1 second.</p><p>Later, I happened to rent a server in Hong Kong, and the speed of accessing resources at home and abroad was flying fast, which is also a good solution (just to spend more money XD).</p><h3 id=upload-docker-hub>Upload Docker Hub</h3><p>The process of uploading to Docker Hub is simpler than expected. First, register an account, then name it and create a warehouse. Use the name of the repository when building the image locally:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>docker build -t sineliu/jupyterlab-all-in-one:latest .
</code></pre></div><p>after that</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>docker push sineliu/jupyterlab-all-in-one:latest
</code></pre></div><p>That&rsquo;s it.</p></div><footer></footer></article><script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script><script id=MathJax-script async src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script><script>MathJax={tex:{inlineMath:[['$','$'],['\\(','\\)']],processEscapes:true,processEnvironments:true},options:{skipHtmlTags:['script','noscript','style','textarea','pre']}};</script></section></div><footer class=footer><section class=container><p>© 2016 - 2023 Sine Liu</p></section></footer></main><script src=https://ssine.ink/js/dark-mode.min.0213e1773e6d1c5a644f847c67a6f8abac49a3776e2976f6008038af8c5b76a1.js></script><script type=application/javascript>var doNotTrack=false;if(!doNotTrack){(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');ga('create','UA-127064931-1','auto');ga('send','pageview');}</script></body></html>
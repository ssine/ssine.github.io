<!doctype html><html lang=en><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta http-equiv=content-language content="en"><meta name=author content="Sine"><meta name=description content="Note: This article is automatically translated, please turn to the Chinese version for more accurate expression if possible.
Recently, I need to share some chat records with others. Because the large amount of screenshots is too troublesome, I want to take the WeChat data directly and back it up by the way. Follow the common process, take the EnMicroMsg.db file, find the password, and export. However, when the database password was obtained, the mobile phone imei used to register WeChat was untestable, and the current mobile phone failed."><meta name=keywords content="blog,developer,personal"><meta name=twitter:card content="summary"><meta name=twitter:title content="WeChat History Extraction"><meta name=twitter:description content="Note: This article is automatically translated, please turn to the Chinese version for more accurate expression if possible.
Recently, I need to share some chat records with others. Because the large amount of screenshots is too troublesome, I want to take the WeChat data directly and back it up by the way. Follow the common process, take the EnMicroMsg.db file, find the password, and export. However, when the database password was obtained, the mobile phone imei used to register WeChat was untestable, and the current mobile phone failed."><meta property="og:title" content="WeChat History Extraction"><meta property="og:description" content="Note: This article is automatically translated, please turn to the Chinese version for more accurate expression if possible.
Recently, I need to share some chat records with others. Because the large amount of screenshots is too troublesome, I want to take the WeChat data directly and back it up by the way. Follow the common process, take the EnMicroMsg.db file, find the password, and export. However, when the database password was obtained, the mobile phone imei used to register WeChat was untestable, and the current mobile phone failed."><meta property="og:type" content="article"><meta property="og:url" content="https://ssine.ink/en/posts/wechat-data-decryption/"><meta property="article:published_time" content="2020-04-03T00:17:06+08:00"><meta property="article:modified_time" content="2020-04-03T00:17:06+08:00"><title>WeChat History Extraction · Sine's Site</title><link rel=canonical href=https://ssine.ink/en/posts/wechat-data-decryption/><link rel=preconnect href=https://fonts.gstatic.com><link href="https://fonts.googleapis.com/css?family=Lato:400,700%7CMerriweather:300,700%7CSource+Code+Pro:400,700&display=swap" rel=stylesheet><link rel=preload href="https://ssine.ink/fonts/forkawesome-webfont.woff2?v=1.1.7" as=font type=font/woff2 crossorigin><link rel=stylesheet href=https://ssine.ink/css/coder.min.a050bb9724f6a498b574acf612d6d523bc68756ddc62579923710a8542947c52.css integrity="sha256-oFC7lyT2pJi1dKz2EtbVI7xodW3cYleZI3EKhUKUfFI=" crossorigin=anonymous media=screen><link rel=stylesheet href=https://ssine.ink/css/coder-dark.min.126ad3988d46bdae6217a11105b53c9662bca05f39d42d3c0fb366919d334620.css integrity="sha256-EmrTmI1Gva5iF6ERBbU8lmK8oF851C08D7NmkZ0zRiA=" crossorigin=anonymous media=screen><link rel=icon type=image/png href=https://ssine.ink/favicon.ico sizes=32x32><link rel=icon type=image/png href=https://ssine.ink/favicon.ico sizes=16x16><link rel=apple-touch-icon href=https://ssine.ink/images/apple-touch-icon.png><link rel=apple-touch-icon sizes=180x180 href=https://ssine.ink/images/apple-touch-icon.png><meta name=generator content="Hugo 0.74.1"></head><body class=colorscheme-auto><div class=float-container><a id=dark-mode-toggle class=colorscheme-toggle><i class="fa fa-adjust fa-fw" aria-hidden=true></i></a></div><main class=wrapper><nav class=navigation><section class=container><a class=navigation-title href=https://ssine.ink/en>Sine's Site</a>
<input type=checkbox id=menu-toggle>
<label class="menu-button float-right" for=menu-toggle><i class="fa fa-bars fa-fw" aria-hidden=true></i></label><ul class=navigation-list><li class=navigation-item><a class=navigation-link href=https://ssine.ink/en/posts/>Blog</a></li><li class=navigation-item><a class=navigation-link href=https://kiwi.ssine.cc>Wiki</a></li><li class=navigation-item><a class=navigation-link href=https://ssine.ink/en/gallery>Gallery</a></li><li class=navigation-item><a class=navigation-link href=https://ssine.ink/en/projects/>Projects</a></li><li class="navigation-item menu-separator"><span>|</span></li><li class=navigation-item><a href=https://ssine.ink/posts/wechat-data-decryption/>中文</a></li></ul></section></nav><div class=content><section class="container post"><article><header><div class=post-title><h1 class=title>WeChat History Extraction</h1></div><div class=post-meta><div class=date><span class=posted-on><i class="fa fa-calendar" aria-hidden=true></i><time datetime=2020-04-03T00:17:06+08:00>April 3, 2020</time></span>
<span class=reading-time><i class="fa fa-clock-o" aria-hidden=true></i>7-minute read</span></div></div></header><div><p><strong>Note: This article is automatically translated, please turn to the Chinese version for more accurate expression if possible.</strong></p><p>Recently, I need to share some chat records with others. Because the large amount of screenshots is too troublesome, I want to take the WeChat data directly and back it up by the way. Follow the common process, take the EnMicroMsg.db file, find the password, and export. However, when the database password was obtained, the mobile phone imei used to register WeChat was untestable, and the current mobile phone failed. Therefore, we can only use brute force cracking. See below for details.</p><p>The whole process is divided into three steps:</p><ol><li>Extract the chat message database</li><li>Get database password, decrypt</li><li>Export chat history</li></ol><h1 id=extract-the-chat-message-database>Extract the chat message database</h1><p>WeChat user messages are stored in sqlite3 files, located in<code>/data/data/com.tencent.mm/MicroMsg/{hash}/EnMicroMsg.db</code> . As long as it can be taken out, there are not many obstacles behind. However, owning<code>/data/data/com.tencent.mm</code> The only users with folder access permissions are: 1. Tencent development user 2. root. Since my phone has been rooted, it is easy to export this file. Here are a few ideas for non-root users:</p><h2 id=back-up-to-a-system-with-root-privileges>Back up to a system with root privileges</h2><p>Since the machine does not have root permission, the chat history of the current mobile phone will be transferred to a system with root permission through WeChat chat history migration. The most reliable way is to find a rooted mobile phone. If you don&rsquo;t have such a device, you can also install an Android emulator on your computer. The emulator usually has root permissions. I have tried the Night God Simulator, but it only supports Android 4, which is already an ancient version, and it crashed after logging in to the account on WeChat. In addition to the night god, there are many simulators to try, and readers can find them by themselves.</p><h2 id=with-the-help-of-the-manufacturers-backup-function>With the help of the manufacturer&rsquo;s backup function</h2><p>Some mobile phone manufacturers provide system-level backup software functions. You can use this function to obtain a backup of the WeChat data storage directory, and then unpack the backup file to obtain this information. I know of Xiaomi, but I haven&rsquo;t actually tried it. Samsung mobile phones used to support this feature, but it was later cancelled, probably for safety reasons.</p><h2 id=fake-developer-users>Fake developer users</h2><p>Since the developer can access the data directory of his application, he can also pretend to be a developer and copy the data inside through the adb shell. According to Android&rsquo;s security policy, only applications packaged in development mode can use adb shell to access the data directory. Therefore, it is necessary to obtain a WeChat installation package in the development state. I have tried to decompile WeChat, change the development mode mark in it, and package it back to install, but the process is extremely cumbersome, and because the signature is different during the second packaging, it cannot replace the previous WeChat application. Even if it is installed, the previous WeChat application cannot be obtained. Data. But I have no experience in Android development, maybe an experienced developer can do it.</p><p>Finally, if you don&rsquo;t have root before but you want to be rooted in order to obtain chat records, you must carefully consider it, because there is a step in the rooting process that needs to delete all data, and the consequences of not deleting forcibly rooting are unpredictable.</p><h1 id=get-database-password-and-decrypt>Get database password and decrypt</h1><p>Taken out in the previous step<code>EnMicroMsg.db</code> The database file is encrypted, and the encryption method is SQLCipher V2. Here are two ways to obtain the password.</p><h2 id=generate-password-via-imei>Generate password via IMEI</h2><p>Many blogs on the Internet have mentioned the method of generating the WeChat database password, which is the first 7 digits of the MD5 value after the mobile phone&rsquo;s IMEI number and WeChat uin are spliced together. MD5 is in lowercase letters.</p><p>The first is IMEI, dial on the phone<code>*#06#</code> You can check, each card slot has an IMEI (take the first 14 digits), and each mobile phone has an MEID. Try it out. However, one thing that hurts is that the IMEI may not be the current mobile phone. I also saw that it is the IMEI of the mobile phone used when registering WeChat.</p><p>The rest is uin, similar to the id of a WeChat user, located in<code>/data/data/com.tencent.mm/shared_prefs/auth_info_key_prefs.xml</code> ：</p><img src=./auth_info_key_prefs.jpg><p>Regardless of whether uin is a negative number or not, just concatenate it as a string and IMEI. Then take the string IMEI + uin to calculate the MD5 value (you will find an online tool for calculation in Baidu), and take out the first 7 digits (lowercase) to be the password.</p><h2 id=brute-force>Brute force</h2><p>The password I got through the process in the previous section was wrong, and I even tried it with the mobile phone I used in high school, but it also failed. However, the password has only 7 digits and the character set is also limited (MD5 is a hexadecimal string), so there are only $16^7$ possibilities in total, and the amount of calculation is acceptable for brute force cracking.</p><p>There are ready-made tools on the Internet, so I won’t make wheels:<a href=https://github.com/chg-hou/EnMicroMsg.db-Password-Cracker>EnMicroMsg.db-Password-Cracker</a> , This program uses CPU, my i7-6700HQ runs about 200 lines/s, and it takes 15 days.</p><p>This length of time is still a bit unacceptable, but fortunately, there is an issue under this warehouse.<a href=https://github.com/chg-hou/EnMicroMsg.db-Password-Cracker/issues/10>CUDA version completed but won&rsquo;t release</a> Here, there is a user who speaks honestly and said that he would not release his own GPU version, but he released it:<a href=https://github.com/whiteblackitty/SQLCipher-Password-Cracker-OpenCL>SQLCipher-Password-Cracker-OpenCL</a> . To run it, you need OpenCL + CUDA environment. There are more detailed configuration steps in the project README. It took a lot of effort to set up the environment. Due to various problems with CUDA, it took a day to toss.</p><p>The speed of this program is quite impressive, my GPU is GTX 1060, the average speed is 190k/s, and it only takes 20 min in the worst case.</p><p>After I ran, I found that I didn’t find the password.<a href=https://github.com/chg-hou/EnMicroMsg.db-Password-Cracker/issues/6>Dose not work on my database in Feb. 2018</a> The reason was found in the WeChat version 7.0, which changed the read-write head of the database, which caused a problem in determining the success of the decryption. This is in the CPU version of the program.<a href=https://github.com/chg-hou/EnMicroMsg.db-Password-Cracker/commit/20eb4f9bd8bb440bcc6817b4b7981b8bf58478a4>commit 20eb4</a> It was fixed. However, the GPU version has not changed, so it needs to be corrected manually:</p><p>Will<code>Lib/pbkdf2-sha1_aes-256-cbc.cl</code> Line 752 of the file (<a href=https://github.com/whiteblackitty/SQLCipher-Password-Cracker-OpenCL/blob/7dc8147c315d625426e79673a5dc5bad7f0177b3/Lib/pbkdf2-sha1_aes-256-cbc.cl#L752>link</a>) change into</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-cpp data-lang=cpp><span style=color:#66d9ef>if</span>(((uint)(data[<span style=color:#ae81ff>5</span>] <span style=color:#f92672>^</span> iv[<span style=color:#ae81ff>5</span>])<span style=color:#f92672>==</span><span style=color:#ae81ff>0x40</span>) <span style=color:#f92672>&amp;&amp;</span> ((uint)(data[<span style=color:#ae81ff>6</span>] <span style=color:#f92672>^</span> iv[<span style=color:#ae81ff>6</span>])<span style=color:#f92672>==</span><span style=color:#ae81ff>0x20</span>) <span style=color:#f92672>&amp;&amp;</span> ((uint)(data[<span style=color:#ae81ff>7</span>] <span style=color:#f92672>^</span> iv[<span style=color:#ae81ff>7</span>])<span style=color:#f92672>==</span><span style=color:#ae81ff>0x20</span>))
</code></pre></div><p>. After running again, the password was successfully obtained.</p><h2 id=database-decryption>Database decryption</h2><p>In the case of brute force cracking, the program will save a decrypted database when the password is obtained. If it is a calculation method, you can refer to<a href=https://github.com/ppwwyyxx/wechat-dump>wechat-dump</a> The project provides a script for decrypting using IMEI and uin.</p><h1 id=export-chat-history>Export chat history</h1><p>The decrypted database is an ordinary sqlite3 file, which can be opened with many software. SQLiteStudio is recommended here.</p><img src=./sqlitestudio.png><p>There are all chat records in the message table. Of course, no matter what software is used, the readability is very poor. A program is needed to display them separately according to chat groups/persons.</p><p><a href=https://github.com/ppwwyyxx/wechat-dump>wechat-dump</a> The library is a good library for extracting messages from the database and categorizing and exporting them. It needs to be run in the linux + python 2 environment. Please refer to the project README for the specific configuration.</p><p>List all contacts:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>./list-chats.py decrypted.db
</code></pre></div><p>Export all chat records as text files:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>./count-message.sh output_dir
</code></pre></div><p>Render a conversation as an html file:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>./dump-html.py <span style=color:#e6db74>&#34;&lt;contact_display_name&gt;&#34;</span>
</code></pre></div><p>The exported html file can be opened with a browser, or it can be further printed as pdf.</p><img src=./result.jpg><hr><p>The data generated by the user does not belong to the user, and it is ridiculous. The design of the application is not centered on the user experience, but centered on the user&rsquo;s wallet. Such strict restrictions on chat data can greatly increase the migration cost of WeChat users, because users cannot import chat records into other software. However, this is extremely unfriendly to users. The chat history roaming function requires payment, and the highest level of roaming cannot save all chat records, so users cannot back up data outside of the mobile phone at all, and there will be no data if there is a problem with the mobile phone. Up. I have always hated behaviors like QQ and WeChat, but the last mobile phone has been used for a long time. If you want to root, you will lose all your data. If you want to use the Android emulator, you will find problems frequently. Therefore, the first thing I do after changing the phone is to root, risking the security of the device, not for all kinds of plug-ins, just to retrieve my own data.</p></div><footer></footer></article><script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script><script id=MathJax-script async src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script><script>MathJax={tex:{inlineMath:[['$','$'],['\\(','\\)']],processEscapes:true,processEnvironments:true},options:{skipHtmlTags:['script','noscript','style','textarea','pre']}};</script></section></div><footer class=footer><section class=container><p>© 2016 - 2023 Sine Liu</p></section></footer></main><script src=https://ssine.ink/js/dark-mode.min.0213e1773e6d1c5a644f847c67a6f8abac49a3776e2976f6008038af8c5b76a1.js></script><script type=application/javascript>var doNotTrack=false;if(!doNotTrack){(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');ga('create','UA-127064931-1','auto');ga('send','pageview');}</script></body></html>
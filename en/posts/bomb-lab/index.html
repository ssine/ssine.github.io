<!doctype html><html lang=en><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta http-equiv=content-language content="en"><meta name=author content="Sine"><meta name=description content="This is the fourth experiment of assembly language. I didn&rsquo;t expect to use the well-known bomb lab on CSAPP. It is also very powerful.
Turn the bomb into a &ldquo;dumb bomb&rdquo; As a perfectionist of the glass heart, naturally, I don&rsquo;t want my own explosive record to be registered, so I have to find a way to debug the bomb locally. Fortunately, both sides are x86, at least binary files can run."><meta name=keywords content="blog,developer,personal"><meta name=twitter:card content="summary"><meta name=twitter:title content="Bomb Lab"><meta name=twitter:description content="This is the fourth experiment of assembly language. I didn&rsquo;t expect to use the well-known bomb lab on CSAPP. It is also very powerful.
Turn the bomb into a &ldquo;dumb bomb&rdquo; As a perfectionist of the glass heart, naturally, I don&rsquo;t want my own explosive record to be registered, so I have to find a way to debug the bomb locally. Fortunately, both sides are x86, at least binary files can run."><meta property="og:title" content="Bomb Lab"><meta property="og:description" content="This is the fourth experiment of assembly language. I didn&rsquo;t expect to use the well-known bomb lab on CSAPP. It is also very powerful.
Turn the bomb into a &ldquo;dumb bomb&rdquo; As a perfectionist of the glass heart, naturally, I don&rsquo;t want my own explosive record to be registered, so I have to find a way to debug the bomb locally. Fortunately, both sides are x86, at least binary files can run."><meta property="og:type" content="article"><meta property="og:url" content="https://ssine.ink/en/posts/bomb-lab/"><meta property="article:published_time" content="2018-07-20T00:00:00+00:00"><meta property="article:modified_time" content="2018-07-20T00:00:00+00:00"><title>Bomb Lab · Sine's Site</title><link rel=canonical href=https://ssine.ink/en/posts/bomb-lab/><link rel=preconnect href=https://fonts.gstatic.com><link href="https://fonts.googleapis.com/css?family=Lato:400,700%7CMerriweather:300,700%7CSource+Code+Pro:400,700&display=swap" rel=stylesheet><link rel=preload href="https://ssine.ink/fonts/forkawesome-webfont.woff2?v=1.1.7" as=font type=font/woff2 crossorigin><link rel=stylesheet href=https://ssine.ink/css/coder.min.a050bb9724f6a498b574acf612d6d523bc68756ddc62579923710a8542947c52.css integrity="sha256-oFC7lyT2pJi1dKz2EtbVI7xodW3cYleZI3EKhUKUfFI=" crossorigin=anonymous media=screen><link rel=stylesheet href=https://ssine.ink/css/coder-dark.min.126ad3988d46bdae6217a11105b53c9662bca05f39d42d3c0fb366919d334620.css integrity="sha256-EmrTmI1Gva5iF6ERBbU8lmK8oF851C08D7NmkZ0zRiA=" crossorigin=anonymous media=screen><link rel=icon type=image/png href=https://ssine.ink/favicon.ico sizes=32x32><link rel=icon type=image/png href=https://ssine.ink/favicon.ico sizes=16x16><link rel=apple-touch-icon href=https://ssine.ink/images/apple-touch-icon.png><link rel=apple-touch-icon sizes=180x180 href=https://ssine.ink/images/apple-touch-icon.png><meta name=generator content="Hugo 0.74.1"></head><body class=colorscheme-auto><div class=float-container><a id=dark-mode-toggle class=colorscheme-toggle><i class="fa fa-adjust fa-fw" aria-hidden=true></i></a></div><main class=wrapper><nav class=navigation><section class=container><a class=navigation-title href=https://ssine.ink/en>Sine's Site</a>
<input type=checkbox id=menu-toggle>
<label class="menu-button float-right" for=menu-toggle><i class="fa fa-bars fa-fw" aria-hidden=true></i></label><ul class=navigation-list><li class=navigation-item><a class=navigation-link href=https://ssine.ink/en/posts/>Blog</a></li><li class=navigation-item><a class=navigation-link href=https://kiwi.ssine.cc>Wiki</a></li><li class=navigation-item><a class=navigation-link href=https://ssine.ink/en/gallery>Gallery</a></li><li class=navigation-item><a class=navigation-link href=https://ssine.ink/en/projects/>Projects</a></li><li class="navigation-item menu-separator"><span>|</span></li><li class=navigation-item><a href=https://ssine.ink/posts/bomb-lab/>中文</a></li></ul></section></nav><div class=content><section class="container post"><article><header><div class=post-title><h1 class=title>Bomb Lab</h1></div><div class=post-meta><div class=date><span class=posted-on><i class="fa fa-calendar" aria-hidden=true></i><time datetime=2018-07-20T00:00:00Z>July 20, 2018</time></span>
<span class=reading-time><i class="fa fa-clock-o" aria-hidden=true></i>6-minute read</span></div></div></header><div><p>This is the fourth experiment of assembly language. I didn&rsquo;t expect to use the well-known bomb lab on CSAPP. It is also very powerful.</p><h1 id=turn-the-bomb-into-a-dumb-bomb>Turn the bomb into a &ldquo;dumb bomb&rdquo;</h1><p>As a perfectionist of the glass heart, naturally, I don&rsquo;t want my own explosive record to be registered, so I have to find a way to debug the bomb locally. Fortunately, both sides are x86, at least binary files can run. Running in the local linux environment, error:</p><pre><code class=language-assembly data-lang=assembly>Initialization error: Running on an illegal host [2]
</code></pre><p>After observing the disassembly, and giving the c file a line like this:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=color:#75715e>/* Do all sorts of secret stuff that makes the bomb harder to defuse. */</span>
initialize_bomb();
</code></pre></div><p>Found that this function is checking the runtime environment, it is not a good thing to look at its comments. Replace the function call statement with a null instruction with a binary editor:</p><p><img src=PAS20180720234228.png alt=replace-init></p><p>Then you can run it locally, but the information about the bomb explosion will still be sent out (it was accidentally bombed during class) and continue to hack &mdash;</p><p>The bomb explosion will call the explode_bomb function, and the phase_defused function will be called when the bomb is removed. (It is really conscience to keep the symbol table when compiling, which greatly reduces the difficulty); both functions call a function called send_msg to pass the information. Therefore, you only need to replace the function call statement in explode_bomb and phase_defused with a null instruction (the function has a return value, but it has not been used, so it is not investigated in detail):</p><p><img src=PAS20180720234058.png alt=replace-call-msg></p><p><img src=PAS20180720234154.png alt=replace-call-msg></p><p>You&rsquo;re done, and at this point the bomb has become a dumb bomb.</p><h1 id=tool-introduction>Tool introduction</h1><p>If a worker wants to do something good, he must first sharpen his tools. The following tools were mainly used in this experiment:</p><table><thead><tr><th align=center>Tool</th><th align=center>Effect</th></tr></thead><tbody><tr><td align=center>gdb</td><td align=center>Dynamic debugging</td></tr><tr><td align=center>IDA</td><td align=center>Auxiliary reading assembly code, decompilation</td></tr><tr><td align=center>objdump</td><td align=center>Disassembly</td></tr><tr><td align=center>Hex Editor Neo</td><td align=center>Binary Editing</td></tr></tbody></table><h1 id=phase-1>Phase 1</h1><p>The first question is very simple. The topic implements the strings_not_equal function. Its function is just like its name. It only needs to know the incoming parameters in rdi, rsi, and the return value is eax. Find another string to participate in the comparison based on the address <code>Verbosity leads to unclear, inarticulate things.</code>。</p><h1 id=phase-2>Phase 2</h1><p>The second problem, there is a function read_six_numbers, the function is to read six numbers from the string pointed to by the first parameter, stored in the array pointed to by the second int pointer. Note that when the function calls sscanf, the parameters are more than seven, and the parameters are passed using the stack. This point is not realized by the decompilation tool IDA.</p><p>After reading the six numbers, the program confirms that the first item is 0, the second item is 1, and then follows the law of Fibonacci numbers. Each item is the sum of the first two items, so the answer is:</p><pre><code class=language-number data-lang=number>0 1 1 2 3 5
</code></pre><p>This shows the IDA interface, which can display blocks separated by jump instructions, which greatly improves the readability of the code:</p><p><img src=PAS20180721000135.png alt=ida-tool></p><h1 id=phase-3>Phase 3</h1><p>The third question, the jump table, is equivalent to a switch statement. The input string is <code>"%d %c %d"</code>, with the first number as the index, there are 0 to 7 kinds of choices, each of which has corresponding characters and numbers. Here, for convenience, the first number is 0, and the character corresponding to 79H is y. The number 210H is 528. So a possible answer: <code>0 y 528</code>。</p><h1 id=phase-4>Phase 4</h1><p>The input to this level is the two numbers a, b, and the conditions for the bombing are <code>a == func4(7, b)</code> and <code>2 &lt;= b &lt;= 4</code>.</p><p>By studying the function body of func4, it is known that this is a recursive function, and its logical equivalent python function is:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>func4</span>(x, y):
    <span style=color:#66d9ef>if</span> x <span style=color:#f92672>&lt;=</span> <span style=color:#ae81ff>0</span>:
        <span style=color:#66d9ef>return</span> <span style=color:#ae81ff>0</span>
    <span style=color:#66d9ef>if</span> x <span style=color:#f92672>==</span> <span style=color:#ae81ff>1</span>:
        <span style=color:#66d9ef>return</span> y
    <span style=color:#66d9ef>return</span> func4(x<span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>, y) <span style=color:#f92672>+</span> func4(x<span style=color:#f92672>-</span><span style=color:#ae81ff>2</span>, y) <span style=color:#f92672>+</span> y
</code></pre></div><p>Taking b = 3, we can calculate func4(7, 3) = 99, so the answer is <code>99 3</code>。</p><h1 id=phase-5>Phase 5</h1><p>This question requires reading a string with a length of 6. Assuming one of the characters is c, the following program loops from 1 to 6, adding <code>array_3154[c & 0xF]</code> the character at it to an empty string s. The length of the array is exactly 16, and the memory is checked to see what it is <code>maduiersnfotvbyl</code>. Finally, <code>"flyers"</code> compares with the target string . Therefore, construct a string so that the last four digits of each character are the index of the corresponding position of the flyer. See below:</p><p><img src=bomb-phase-5.png alt=ph5></p><p>A possible answer is:</p><p><code>yonuvw</code></p><h1 id=phase-6>Phase 6</h1><p>The sixth question is really too much. . .</p><p>First read in six numbers (or read_six_numbers function), then the double loop determines that the six numbers are different. (The full arrangement of the six numbers is 720. It is also possible to find a violent search.)</p><p>There are still two loops that look a bit embarrassing, and can only be dynamically debugged with gdb.</p><p><img src=PAS20180721135950.png alt=node></p><p>The above figure is an array frequently involved in the loop. After observing, the program is newly opened with an array corresponding to 0x603490 to 0x6034e0 according to the original 1 to 6. After comparing the positions in the array shown in the first column of the above figure, they must be in descending order. Therefore, the numbers shown in the first column of the above figure are arranged, and then the order corresponding to each number (the second column in the above figure) is used as the answer.</p><pre><code class=language-number data-lang=number>2 1 6 4 3 5
</code></pre><h1 id=secret-phase>Secret Phase</h1><p>The existence of hidden gates is known from various places, such as comments in the c file, and the leaderboards that have cracked the seven levels.</p><p>Looking directly at the function list reveals that there is a function called secret_phase. Use gdb to <code>return 0;</code>, add a breakpoint before the statement, use the <code>call secret_phasecommand</code> after the first six levels of cracking to enter the hidden off. If the hidden off is called directly, the leaderboard will display phase 1 invalid.</p><p>The last level is relatively simple. Read a decimal number y. We want the return value of the fun7 function to be 0.</p><p><img src=bomb-fun7.png alt=fun7></p><p>Although the definition of the function is rather strange, it can be seen that if you want the function to return a value of 0, you only need to make y equal to the number pointed to by the pointer of the first parameter. You can see that the number is 36 by looking at the memory.</p></div><footer></footer></article><script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script><script id=MathJax-script async src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script><script>MathJax={tex:{inlineMath:[['$','$'],['\\(','\\)']],processEscapes:true,processEnvironments:true},options:{skipHtmlTags:['script','noscript','style','textarea','pre']}};</script></section></div><footer class=footer><section class=container><p>© 2016 - 2023 Sine Liu</p></section></footer></main><script src=https://ssine.ink/js/dark-mode.min.0213e1773e6d1c5a644f847c67a6f8abac49a3776e2976f6008038af8c5b76a1.js></script><script type=application/javascript>var doNotTrack=false;if(!doNotTrack){(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');ga('create','UA-127064931-1','auto');ga('send','pageview');}</script></body></html>
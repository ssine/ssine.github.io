<!doctype html><html lang=en><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta http-equiv=content-language content="en"><meta name=author content="Sine"><meta name=description content="Note: This article is automatically translated, please turn to the Chinese version for more accurate expression if possible.
Recently, I encountered an interesting problem when writing the check-in bot in the quiz group, so let&rsquo;s talk about it.
After a punch-in dialogue is completed, the program needs to write the data into the file, and then it will call the NodeJS API (JavaScript):
class XXX { async saveData() { await fs."><meta name=keywords content="blog,developer,personal"><meta name=twitter:card content="summary"><meta name=twitter:title content="Critical Section in Asynchronous Environment"><meta name=twitter:description content="Note: This article is automatically translated, please turn to the Chinese version for more accurate expression if possible.
Recently, I encountered an interesting problem when writing the check-in bot in the quiz group, so let&rsquo;s talk about it.
After a punch-in dialogue is completed, the program needs to write the data into the file, and then it will call the NodeJS API (JavaScript):
class XXX { async saveData() { await fs."><meta property="og:title" content="Critical Section in Asynchronous Environment"><meta property="og:description" content="Note: This article is automatically translated, please turn to the Chinese version for more accurate expression if possible.
Recently, I encountered an interesting problem when writing the check-in bot in the quiz group, so let&rsquo;s talk about it.
After a punch-in dialogue is completed, the program needs to write the data into the file, and then it will call the NodeJS API (JavaScript):
class XXX { async saveData() { await fs."><meta property="og:type" content="article"><meta property="og:url" content="https://ssine.ink/en/posts/critical-section-in-async-environment/"><meta property="article:published_time" content="2020-06-26T21:42:42+08:00"><meta property="article:modified_time" content="2020-06-26T21:42:42+08:00"><title>Critical Section in Asynchronous Environment · Sine's Site</title><link rel=canonical href=https://ssine.ink/en/posts/critical-section-in-async-environment/><link rel=preconnect href=https://fonts.gstatic.com><link href="https://fonts.googleapis.com/css?family=Lato:400,700%7CMerriweather:300,700%7CSource+Code+Pro:400,700&display=swap" rel=stylesheet><link rel=preload href="https://ssine.ink/fonts/forkawesome-webfont.woff2?v=1.1.7" as=font type=font/woff2 crossorigin><link rel=stylesheet href=https://ssine.ink/css/coder.min.a050bb9724f6a498b574acf612d6d523bc68756ddc62579923710a8542947c52.css integrity="sha256-oFC7lyT2pJi1dKz2EtbVI7xodW3cYleZI3EKhUKUfFI=" crossorigin=anonymous media=screen><link rel=stylesheet href=https://ssine.ink/css/coder-dark.min.126ad3988d46bdae6217a11105b53c9662bca05f39d42d3c0fb366919d334620.css integrity="sha256-EmrTmI1Gva5iF6ERBbU8lmK8oF851C08D7NmkZ0zRiA=" crossorigin=anonymous media=screen><link rel=icon type=image/png href=https://ssine.ink/favicon.ico sizes=32x32><link rel=icon type=image/png href=https://ssine.ink/favicon.ico sizes=16x16><link rel=apple-touch-icon href=https://ssine.ink/images/apple-touch-icon.png><link rel=apple-touch-icon sizes=180x180 href=https://ssine.ink/images/apple-touch-icon.png><meta name=generator content="Hugo 0.74.1"></head><body class=colorscheme-auto><div class=float-container><a id=dark-mode-toggle class=colorscheme-toggle><i class="fa fa-adjust fa-fw" aria-hidden=true></i></a></div><main class=wrapper><nav class=navigation><section class=container><a class=navigation-title href=https://ssine.ink/en>Sine's Site</a>
<input type=checkbox id=menu-toggle>
<label class="menu-button float-right" for=menu-toggle><i class="fa fa-bars fa-fw" aria-hidden=true></i></label><ul class=navigation-list><li class=navigation-item><a class=navigation-link href=https://ssine.ink/en/posts/>Blog</a></li><li class=navigation-item><a class=navigation-link href=https://kiwi.ssine.cc>Wiki</a></li><li class=navigation-item><a class=navigation-link href=https://ssine.ink/en/gallery>Gallery</a></li><li class=navigation-item><a class=navigation-link href=https://ssine.ink/en/projects/>Projects</a></li><li class="navigation-item menu-separator"><span>|</span></li><li class=navigation-item><a href=https://ssine.ink/posts/critical-section-in-async-environment/>中文</a></li></ul></section></nav><div class=content><section class="container post"><article><header><div class=post-title><h1 class=title>Critical Section in Asynchronous Environment</h1></div><div class=post-meta><div class=date><span class=posted-on><i class="fa fa-calendar" aria-hidden=true></i><time datetime=2020-06-26T21:42:42+08:00>June 26, 2020</time></span>
<span class=reading-time><i class="fa fa-clock-o" aria-hidden=true></i>3-minute read</span></div></div></header><div><p><strong>Note: This article is automatically translated, please turn to the Chinese version for more accurate expression if possible.</strong></p><p>Recently, I encountered an interesting problem when writing the check-in bot in the quiz group, so let&rsquo;s talk about it.</p><p>After a punch-in dialogue is completed, the program needs to write the data into the file, and then it will call the NodeJS API (JavaScript):</p><pre><code class=language-javasctipt data-lang=javasctipt>class XXX {
  async saveData() {
    await fs.promises.writeFile(...)
    return
  }
}
</code></pre><p>Since the program is asynchronous and allows two people to check in at the same time, as a result, a check-in dialogue between two people ends at the same time, and the two dialogue functions are executed simultaneously<code>await saveData()</code> 。</p><p>The consequence of this is that the first<code>writeFile</code> The operation returns normally. The person who executed the function first punched in and the function ended normally, and the second one<code>writeFile</code> The operation never ends. the second <code>writeFile</code> The operation is called during the first operation, and there is no mutual exclusion, which may cause problems in the internal processing of NodeJS, because<code>writeFile</code> NodeJS will be responsible for the creation and recycling of file handles.</p><p>So, how to solve this problem? This is a typical code key area in lower-level languages, and we have to mutually exclusive the code that accesses file resources. In C++, mutual exclusion is achieved through semaphores. The first thread that accesses the resource is locked, and the threads that access later can only wait, and this waiting process is blocked, and the thread is suspended while waiting. However, in the JavaScript environment, most of the APIs provided by Node are non-blocking, and we cannot and should not solve this problem by calling blocking file writing functions.</p><p>The asynchronous nature makes<code>saveData</code> The function may be called at any time, and the same may be the last time<code>saveData</code> Called before returning. In order to achieve <code>saveData</code> The internal code is mutually exclusive, we can use the queue to record all<code>saveData</code> Call (that is, the Promise object returned by the flag function). In each call, first check whether there is an unfinished call in the queue. If there is, wait for the last function to execute before continuing to execute the key area logic. At the same time Put the Promise object you want to return into the queue before execution, and remove your Promise object from the queue after the execution ends. The implementation code is as follows:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=color:#66d9ef>let</span> <span style=color:#a6e22e>queue</span> <span style=color:#f92672>=</span> []

<span style=color:#a6e22e>async</span> <span style=color:#66d9ef>function</span> <span style=color:#a6e22e>serialized_async_function</span>() {
  <span style=color:#66d9ef>const</span> <span style=color:#a6e22e>promise</span> <span style=color:#f92672>=</span> <span style=color:#66d9ef>new</span> Promise(<span style=color:#a6e22e>async</span> (<span style=color:#a6e22e>resolve</span>, <span style=color:#a6e22e>reject</span>) =&gt; {
    <span style=color:#66d9ef>if</span> (<span style=color:#a6e22e>queue</span>.<span style=color:#a6e22e>length</span> <span style=color:#f92672>&gt;</span> <span style=color:#ae81ff>0</span>)
      <span style=color:#a6e22e>await</span> <span style=color:#a6e22e>queue</span>[<span style=color:#a6e22e>queue</span>.<span style=color:#a6e22e>length</span> <span style=color:#f92672>-</span> <span style=color:#ae81ff>1</span>]

    <span style=color:#a6e22e>await</span> <span style=color:#a6e22e>fs</span>.<span style=color:#a6e22e>promises</span>.<span style=color:#a6e22e>writeFile</span>(...) <span style=color:#75715e>// any critical section logic
</span><span style=color:#75715e></span>
    <span style=color:#a6e22e>resolve</span>()
    <span style=color:#a6e22e>queue</span>.<span style=color:#a6e22e>splice</span>(<span style=color:#ae81ff>0</span>, <span style=color:#ae81ff>1</span>)
  })
  <span style=color:#a6e22e>queue</span>.<span style=color:#a6e22e>push</span>(<span style=color:#a6e22e>promise</span>)
  <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>promise</span>
}
</code></pre></div><p>Thanks to ES6&rsquo;s promise object, it greatly simplifies the solution to this problem.</p></div><footer></footer></article><script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script><script id=MathJax-script async src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script><script>MathJax={tex:{inlineMath:[['$','$'],['\\(','\\)']],processEscapes:true,processEnvironments:true},options:{skipHtmlTags:['script','noscript','style','textarea','pre']}};</script></section></div><footer class=footer><section class=container><p>© 2016 - 2023 Sine Liu</p></section></footer></main><script src=https://ssine.ink/js/dark-mode.min.0213e1773e6d1c5a644f847c67a6f8abac49a3776e2976f6008038af8c5b76a1.js></script><script type=application/javascript>var doNotTrack=false;if(!doNotTrack){(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');ga('create','UA-127064931-1','auto');ga('send','pageview');}</script></body></html>
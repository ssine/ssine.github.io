<!doctype html><html lang=zh-cn><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta http-equiv=content-language content="zh-cn"><meta name=author content="Sine"><meta name=description content="之前的文件管理一直用 NextCloud ，虽然不好描述，但总感觉差点意思。 最近开了个新的 esxi 虚拟机测试群晖系统，体验确实要好上不少，这里记录一些问题。 安装 安装这"><meta name=keywords content="blog,developer,personal"><meta name=twitter:card content="summary"><meta name=twitter:title content="黑群晖配置"><meta name=twitter:description content="之前的文件管理一直用 NextCloud ，虽然不好描述，但总感觉差点意思。 最近开了个新的 esxi 虚拟机测试群晖系统，体验确实要好上不少，这里记录一些问题。 安装 安装这"><meta property="og:title" content="黑群晖配置"><meta property="og:description" content="之前的文件管理一直用 NextCloud ，虽然不好描述，但总感觉差点意思。 最近开了个新的 esxi 虚拟机测试群晖系统，体验确实要好上不少，这里记录一些问题。 安装 安装这"><meta property="og:type" content="article"><meta property="og:url" content="https://ssine.ink/posts/synology-setup/"><meta property="article:published_time" content="2023-08-13T14:04:03+08:00"><meta property="article:modified_time" content="2023-08-13T14:04:03+08:00"><title>黑群晖配置 · Sine's Site</title><link rel=canonical href=https://ssine.ink/posts/synology-setup/><link rel=preconnect href=https://fonts.gstatic.com><link href="https://fonts.googleapis.com/css?family=Lato:400,700%7CMerriweather:300,700%7CSource+Code+Pro:400,700&display=swap" rel=stylesheet><link rel=preload href="https://ssine.ink/fonts/forkawesome-webfont.woff2?v=1.1.7" as=font type=font/woff2 crossorigin><link rel=stylesheet href=https://ssine.ink/css/coder.min.a050bb9724f6a498b574acf612d6d523bc68756ddc62579923710a8542947c52.css integrity="sha256-oFC7lyT2pJi1dKz2EtbVI7xodW3cYleZI3EKhUKUfFI=" crossorigin=anonymous media=screen><link rel=stylesheet href=https://ssine.ink/css/coder-dark.min.126ad3988d46bdae6217a11105b53c9662bca05f39d42d3c0fb366919d334620.css integrity="sha256-EmrTmI1Gva5iF6ERBbU8lmK8oF851C08D7NmkZ0zRiA=" crossorigin=anonymous media=screen><link rel=icon type=image/png href=https://ssine.ink/favicon.ico sizes=32x32><link rel=icon type=image/png href=https://ssine.ink/favicon.ico sizes=16x16><link rel=apple-touch-icon href=https://ssine.ink/images/apple-touch-icon.png><link rel=apple-touch-icon sizes=180x180 href=https://ssine.ink/images/apple-touch-icon.png><meta name=generator content="Hugo 0.74.1"></head><body class=colorscheme-auto><div class=float-container><a id=dark-mode-toggle class=colorscheme-toggle><i class="fa fa-adjust fa-fw" aria-hidden=true></i></a></div><main class=wrapper><nav class=navigation><section class=container><a class=navigation-title href=https://ssine.ink/>Sine's Site</a>
<input type=checkbox id=menu-toggle>
<label class="menu-button float-right" for=menu-toggle><i class="fa fa-bars fa-fw" aria-hidden=true></i></label><ul class=navigation-list><li class=navigation-item><a class=navigation-link href=https://ssine.ink/posts/>博客</a></li><li class=navigation-item><a class=navigation-link href=https://kiwi.ssine.cc>维基</a></li><li class=navigation-item><a class=navigation-link href=https://ssine.ink/gallery>画廊</a></li><li class=navigation-item><a class=navigation-link href=https://ssine.ink/projects/>项目</a></li><li class="navigation-item menu-separator"><span>|</span></li><li class=navigation-item><a href=https://ssine.ink/en/>English</a></li></ul></section></nav><div class=content><section class="container post"><article><header><div class=post-title><h1 class=title>黑群晖配置</h1></div><div class=post-meta><div class=date><span class=posted-on><i class="fa fa-calendar" aria-hidden=true></i><time datetime=2023-08-13T14:04:03+08:00>August 13, 2023</time></span>
<span class=reading-time><i class="fa fa-clock-o" aria-hidden=true></i>阅读时间：4 分钟</span></div></div></header><div><p>之前的文件管理一直用 NextCloud ，虽然不好描述，但总感觉差点意思。 最近开了个新的 esxi 虚拟机测试群晖系统，体验确实要好上不少，这里记录一些问题。</p><h1 id=安装>安装</h1><p>安装这块主要是跟随 <a href=https://wp.gxnas.com/11089.html>GXNAS 上的这篇教程</a> 完成的，这里的网盘也存了需要的文件。 简单概括一下流程：</p><ol><li>准备安装包、引导镜像和镜像格式转换器</li><li>修改引导镜像 grub.cfg 里面的 mac 地址和 sn 码</li><li>将引导镜像从 img 转换成 esxi 支持的 vmdk 格式 - 要选择 non growable</li><li>创建空虚拟机，添加引导镜像的硬盘和一块空硬盘，配置网卡等</li><li>启动虚拟机，在 5000 端口执行安装操作，过程中需要上传安装包</li></ol><p>流程中遇到的一些问题：</p><p>第三步如果用的是新版 V2V Converter 的话需要选择 non growable 的 vmdk ，否则会转换失败。</p><p>第五步两次遇到启动之后无法访问服务的现象。 第一次在 esxi 看到 CPU 利用率只起来一两分钟就又下去了，但是看不到日志，猜测是哪里出了问题。 在网上找了下，要允许修改网卡 mac 地址，在 esxi 的 网络->VM Network->编辑设置->安全 处打开对应的选项。 第二次启动之后 CPU 利用率一直有 30%但是等了四十多分钟还是没动静，试着在虚拟机配置里把网卡的适配器类型从 vmxnet3 改成 E1000e，之后再重启，两分钟就启动成功了。</p><p>之前还看到有坑说安装过程要断网，所以提前 ban 了对应 ip 的网络，不知道不这么做的话会不会有坑。</p><h2 id=洗白>洗白</h2><p>直接淘宝十来块买了个洗白码，包含一个 sn 和两个 mac 地址，在安装的第二步修改过了。 商家提醒对于需要登录群晖账号的应用，要用国际区账号，不然会被 ban 。 所以注册了美区账号，开机之后对应的应用都能正常使用。 只有 QuickConnect 不能用，不过可以用 DDNS 解决。</p><h1 id=配置>配置</h1><h2 id=目录共享>目录共享</h2><p>群晖自带了文件服务，在 控制面板->文件服务 可以看到，通常 SMB 服务就可以在 Windows 上面无缝使用了。</p><h2 id=synology-photos>Synology Photos</h2><p>Photos 应用的功能挺完善的，可以给图片单个或批量打标签加描述，可以按照元信息搜索，可以用不同的标签组合出虚拟相册，基本满足我的管理需求。 不过比较烦人的一点是不支持自定义相片的物理路径，只能使用预设的 /homes/user/photos 。 这对 Lightroom 等以前就维护过自己的目录结构的场景非常不友好。 这个问题在网上被讨论了无数次 （to name a few, <a href="https://community.synology.com/enu/forum/11/post/119655?page=3&sort=oldest">Photos Station forces you to use a specific folder? Really?</a> | <a href="https://www.reddit.com/r/synology/comments/vqcpes/importing_existing_photo_files_into_synology/?utm_source=share&utm_medium=web2x&context=3">Importing existing photo files into synology photos without copy on btrfs</a> | <a href=https://www.reddit.com/r/synology/comments/ocgj7h/change_default_photos_folder/>Change default Photos folder?</a> | <a href=https://www.zhihu.com/question/469030913/answer/2238293875>群晖更新 DSM7.0 后，synology photos 如何正确快速迁移好原有图片，方便使用？</a> | <a href=https://community.synology.com/enu/forum/17/post/47877>How to point Photo Station to existing folder</a>），目前来看这个不支持是事实而且不能指望群晖支持了。 大家的方案主要有三个：</p><ol><li>软链接，这个被证实不行，群晖的各类应用不认</li><li>mount ，这个有一部分人不行，有一部分可以</li><li>借助 Btrfs 的特性，拷贝文件但是不额外占用空间，缺点是源文件夹的修改不会同步过来</li></ol><p>只有方案 2 最靠谱，尝试了一下跑通了，首先在 控制面板->终端机和 SNMP 开启 SSH 访问，然后用群晖的用户名密码登录上去，把对应的目录给 mount 到 photos 下面：</p><pre><code>sudo mount --bind /var/services/homes/&lt;user&gt;/&lt;your-photos&gt; /var/services/homes/&lt;user&gt;/Photos/&lt;your-photos&gt;
</code></pre><p>之后在群晖界面内检查是否成功。 如果没问题，就在添加一个任务计划，每次启动时以 root 身份执行上述指令进行 mount 。</p><h1 id=备份>备份</h1><p>在本地做 raid 冗余或者定期离线备份都有一定的局限性，毕竟物理上还是在同一个屋子里，防不了物理灾害。 因此与其自购硬盘折腾各种备份，不如直接借助公有云。 通常对象存储服务都会提供冷存储，价格比较低，也比各类网盘稳定许多。 在国内考虑备份速度等问题，还是用阿里云比较方便，不公开的 bucket 预期不会涉及审查。</p><p>价格方面可以参考这个 <a href="https://www.aliyun.com/price/product?spm=a2c4g.11186623.0.0.25847802xHEUeb#/oss/detail/ossbag">价格表</a> 和 <a href="https://help.aliyun.com/zh/oss/user-guide/deep-cold-archive-storage-usage-best-practices?spm=a2c4g.11186623.0.0.173179331Rpm8e">最佳实践</a> 。 建议就设置一个正常的 oss bucket ，然后配置生命周期规则，把多长时间没访问的对象自动转换为冷存储。 个人使用场景不涉及非常多的文件，数据丢失取回也是个小概率事件，可以用深度冷归档型，备份 1TB 的文件每月需要 7.68 元，数据取回需要 256-512 元，其它费用可以忽略不计。 大概算了下 AWS 价格会更高一些。 深度冷归档有一个缺点就是只有本地冗余，不支持同城冗余，如果要确保安全可以手动再开另一个可用区的桶做双保险。</p><p>在系统里安装 Cloud Sync 应用，阿里云创建一个 bucket ，在 数据管理->生命周期 配置一个 「最后一次修改时间 30 天后，转换为深度冷归档型」 ，然后创建一个带有 OSS 权限的 RAM 角色，把 AKSK 交给 Cloud Sync ，剩下的在 GUI 里配置就好了。 需要注意的是应该选择 「仅上传本地更改」 ，否则冷归档存储无法直接读取，不知道会导致什么问题。</p><p>恢复的时候直接手动用 ossutil 下载下来就好。</p></div><footer></footer></article><script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script><script id=MathJax-script async src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script><script>MathJax={tex:{inlineMath:[['$','$'],['\\(','\\)']],processEscapes:true,processEnvironments:true},options:{skipHtmlTags:['script','noscript','style','textarea','pre']}};</script></section></div><footer class=footer><section class=container><p>© 2016 - 2023 正弦 | <a href=https://beian.miit.gov.cn/ target=_blank>京ICP备19051756号</a></p></section></footer></main><script src=https://ssine.ink/js/dark-mode.min.0213e1773e6d1c5a644f847c67a6f8abac49a3776e2976f6008038af8c5b76a1.js></script><script type=application/javascript>var doNotTrack=false;if(!doNotTrack){(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');ga('create','UA-127064931-1','auto');ga('send','pageview');}</script></body></html>
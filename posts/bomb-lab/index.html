<!doctype html><html lang=zh-cn><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta http-equiv=content-language content="zh-cn"><meta name=author content="Sine"><meta name=description content="这是汇编语言的第四个实验，没想到会用 CSAPP 上知名的 bomb lab，做起来也是十分带劲呢。 将炸弹变成“哑弹” 作为一名玻璃心的完美主义者，自然是不希望自己"><meta name=keywords content="blog,developer,personal"><meta name=twitter:card content="summary"><meta name=twitter:title content="Bomb Lab"><meta name=twitter:description content="这是汇编语言的第四个实验，没想到会用 CSAPP 上知名的 bomb lab，做起来也是十分带劲呢。 将炸弹变成“哑弹” 作为一名玻璃心的完美主义者，自然是不希望自己"><meta property="og:title" content="Bomb Lab"><meta property="og:description" content="这是汇编语言的第四个实验，没想到会用 CSAPP 上知名的 bomb lab，做起来也是十分带劲呢。 将炸弹变成“哑弹” 作为一名玻璃心的完美主义者，自然是不希望自己"><meta property="og:type" content="article"><meta property="og:url" content="https://ssine.ink/posts/bomb-lab/"><meta property="article:published_time" content="2018-07-20T00:00:00+00:00"><meta property="article:modified_time" content="2018-07-20T00:00:00+00:00"><title>Bomb Lab · Sine's Site</title><link rel=canonical href=https://ssine.ink/posts/bomb-lab/><link rel=preconnect href=https://fonts.gstatic.com><link href="https://fonts.googleapis.com/css?family=Lato:400,700%7CMerriweather:300,700%7CSource+Code+Pro:400,700&display=swap" rel=stylesheet><link rel=preload href="https://ssine.ink/fonts/forkawesome-webfont.woff2?v=1.1.7" as=font type=font/woff2 crossorigin><link rel=stylesheet href=https://ssine.ink/css/coder.min.a050bb9724f6a498b574acf612d6d523bc68756ddc62579923710a8542947c52.css integrity="sha256-oFC7lyT2pJi1dKz2EtbVI7xodW3cYleZI3EKhUKUfFI=" crossorigin=anonymous media=screen><link rel=stylesheet href=https://ssine.ink/css/coder-dark.min.126ad3988d46bdae6217a11105b53c9662bca05f39d42d3c0fb366919d334620.css integrity="sha256-EmrTmI1Gva5iF6ERBbU8lmK8oF851C08D7NmkZ0zRiA=" crossorigin=anonymous media=screen><link rel=icon type=image/png href=https://ssine.ink/favicon.ico sizes=32x32><link rel=icon type=image/png href=https://ssine.ink/favicon.ico sizes=16x16><link rel=apple-touch-icon href=https://ssine.ink/images/apple-touch-icon.png><link rel=apple-touch-icon sizes=180x180 href=https://ssine.ink/images/apple-touch-icon.png><meta name=generator content="Hugo 0.74.1"></head><body class=colorscheme-auto><div class=float-container><a id=dark-mode-toggle class=colorscheme-toggle><i class="fa fa-adjust fa-fw" aria-hidden=true></i></a></div><main class=wrapper><nav class=navigation><section class=container><a class=navigation-title href=https://ssine.ink/>Sine's Site</a>
<input type=checkbox id=menu-toggle>
<label class="menu-button float-right" for=menu-toggle><i class="fa fa-bars fa-fw" aria-hidden=true></i></label><ul class=navigation-list><li class=navigation-item><a class=navigation-link href=https://ssine.ink/posts/>博客</a></li><li class=navigation-item><a class=navigation-link href=https://kiwi.ssine.cc>维基</a></li><li class=navigation-item><a class=navigation-link href=https://ssine.ink/gallery>画廊</a></li><li class=navigation-item><a class=navigation-link href=https://ssine.ink/projects/>项目</a></li><li class="navigation-item menu-separator"><span>|</span></li><li class=navigation-item><a href=https://ssine.ink/en/posts/bomb-lab/>English</a></li></ul></section></nav><div class=content><section class="container post"><article><header><div class=post-title><h1 class=title>Bomb Lab</h1></div><div class=post-meta><div class=date><span class=posted-on><i class="fa fa-calendar" aria-hidden=true></i><time datetime=2018-07-20T00:00:00Z>July 20, 2018</time></span>
<span class=reading-time><i class="fa fa-clock-o" aria-hidden=true></i>阅读时间：4 分钟</span></div></div></header><div><p>这是汇编语言的第四个实验，没想到会用 CSAPP 上知名的 bomb lab，做起来也是十分带劲呢。</p><h1 id=将炸弹变成哑弹>将炸弹变成“哑弹”</h1><p>作为一名玻璃心的完美主义者，自然是不希望自己的爆炸记录被登记在册，因此要想办法能够在本地调试炸弹。好在两边都是 x86，至少二进制文件是能运行的。在本地 linux 环境下运行，报错：</p><pre><code class=language-assembly data-lang=assembly>Initialization error: Running on an illegal host [2]
</code></pre><p>经过观察反汇编，以及给的 c 文件中有这么一行：</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-c data-lang=c><span style=color:#75715e>/* Do all sorts of secret stuff that makes the bomb harder to defuse. */</span>
initialize_bomb();
</code></pre></div><p>发现是这个函数在检查运行环境，看它的注释就不是好东西。用二进制编辑器把函数调用语句替换为空指令：</p><p><img src=PAS20180720234228.png alt=replace-init></p><p>之后就可以在本地运行了，但是炸弹爆炸的信息还是会被发出去（上课的时候就不小心炸了），继续 hack——</p><p>炸弹爆炸会调用 explode_bomb 函数，炸弹被拆除会调用 phase_defused 函数（编译的时候保留了符号表真的很良心了，大大降低了难度）；而这两个函数都会调用一个叫做 send_msg 的函数来传递信息。因此只需要将 explode_bomb 与 phase_defused 中的函数调用语句替换为空指令即可（函数有返回值，但是并没有没用到过，因此不详细追究了）：</p><p><img src=PAS20180720234058.png alt=replace-call-msg></p><p><img src=PAS20180720234154.png alt=replace-call-msg></p><p>大功告成，至此这个炸弹就变成了任人摆布的哑弹了。</p><h1 id=工具简介>工具简介</h1><p>工欲善其事，必先利其器。本次实验中主要使用到了以下几个工具：</p><table><thead><tr><th align=center>工具</th><th align=center>作用</th></tr></thead><tbody><tr><td align=center>gdb</td><td align=center>动态调试</td></tr><tr><td align=center>IDA</td><td align=center>辅助阅读汇编代码，反编译</td></tr><tr><td align=center>objdump</td><td align=center>反汇编</td></tr><tr><td align=center>Hex Editor Neo</td><td align=center>编辑二进制文件</td></tr></tbody></table><h1 id=phase-1>Phase 1</h1><p>第一题很简单，题目实现了 strings_not_equal 函数，功能如其名，只需要知道传入参数在 rdi、rsi，返回值为 eax 即可。根据地址找到参与比较的另外一个字符串<code>Verbosity leads to unclear, inarticulate things.</code>。</p><h1 id=phase-2>Phase 2</h1><p>第二题，有一个函数 read_six_numbers，功能是从第一个参数指向的字符串中读出六个数字，保存在第二个 int 指针指向的数组中。注意函数调用 sscanf 时参数超过七个，使用堆栈传递了参数。这一点反编译工具 IDA 并没有意识到。</p><p>读完六个数之后，程序确认第一项是 0，第二项是 1，之后遵循斐波那契数的规律，每项是前面两项的和，因此答案为：</p><pre><code class=language-number data-lang=number>0 1 1 2 3 5
</code></pre><p>PS 这里展示一下 IDA 的界面，能够分块显示跳转指令分开的程序块，大大提高了代码可读性：</p><p><img src=PAS20180721000135.png alt=ida-tool></p><h1 id=phase-3>Phase 3</h1><p>第三题，跳转表，相当于一个 switch 语句。输入字符串是<code>"%d %c %d"</code>，以第一个数字作为索引，有 0 到 7 七种选择，每一种都有对应的字符与数字，这里为了方便直接取第一个数字为 0，对应 79H 的字符为 y，数字 210H 为 528。因此一个可能的答案：<code>0 y 528</code>。</p><h1 id=phase-4>Phase 4</h1><p>这一关的输入是两个数字 a、b，拆弹的条件为<code>a == func4(7, b)</code>且<code>2 &lt;= b &lt;= 4</code>。</p><p>通过研究 func4 的函数体得知这是一个递归函数，与其逻辑等价的 python 函数为：</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=color:#66d9ef>def</span> <span style=color:#a6e22e>func4</span>(x, y):
    <span style=color:#66d9ef>if</span> x <span style=color:#f92672>&lt;=</span> <span style=color:#ae81ff>0</span>:
        <span style=color:#66d9ef>return</span> <span style=color:#ae81ff>0</span>
    <span style=color:#66d9ef>if</span> x <span style=color:#f92672>==</span> <span style=color:#ae81ff>1</span>:
        <span style=color:#66d9ef>return</span> y
    <span style=color:#66d9ef>return</span> func4(x<span style=color:#f92672>-</span><span style=color:#ae81ff>1</span>, y) <span style=color:#f92672>+</span> func4(x<span style=color:#f92672>-</span><span style=color:#ae81ff>2</span>, y) <span style=color:#f92672>+</span> y
</code></pre></div><p>取 b = 3，可以算出 func4(7, 3) = 99，因此答案为<code>99 3</code>。</p><h1 id=phase-5>Phase 5</h1><p>本题要求读入一个字符串，长度为 6。假设其中一个字符为 c，后面的程序从 1 到 6 循环，将<code>array_3154[c & 0xF]</code>处的字符加到一个空字符串 s 上。那个数组的长度刚好为 16，查看内存得知其内容为<code>maduiersnfotvbyl</code>。最后用 s 与目标串<code>"flyers"</code>比较。因此，构建一个字符串使得每个字符后四位的值为 flyers 对应位置的索引即可。见下图：</p><p><img src=bomb-phase-5.png alt=ph5></p><p>一个可行的答案为：</p><p><code>yonuvw</code></p><h1 id=phase-6>Phase 6</h1><p>第六题实在是太绕了。。。</p><p>首先读入六个数（还是 read_six_numbers 函数），之后二重循环判定六个数不相同。（六个数的全排列是 720，想办法暴力搜索也是可以的）</p><p>后面还有两个循环看得有点懵了，只能借助 gdb 动态调试。</p><p><img src=PAS20180721135950.png alt=node></p><p>上图是循环中频繁涉及到的一个数组，经过观察，程序是新开了一个数组，按照原有的 1 到 6 将之对应为 0x603490 到 0x6034e0。之后比较数组中如上图第一列所示的位置，必须是降序排列。因此将上图第一列所示数字排列，之后将每个数字对应的顺序（同上图第二列）作为答案即可。</p><pre><code class=language-number data-lang=number>2 1 6 4 3 5
</code></pre><h1 id=secret-phase>Secret Phase</h1><p>从各种地方都得知隐藏关的存在，比如 c 文件中的注释，以及已经破解了七关的排行榜。</p><p>直接查看函数列表便可发现有一个名叫 secret_phase 的函数。使用 gdb 在<code>return 0;</code>语句前加上断点，在前六关破解之后使用<code>call secret_phase</code>指令即可进入隐藏关。如果直接调用隐藏关的话排行榜会显示 phase 1 invalid。</p><p>最后一关反而比较简单，读入一个十进制数 y，我们希望 fun7 函数的返回值为 0。</p><p><img src=bomb-fun7.png alt=fun7></p><p>虽然函数的定义比较奇怪，但可以看出，想要函数返回值为 0 的话，只需要让 y 等于第一个参数的指针指向的数字就可以了，通过查看内存得知这个数字为 36。</p></div><footer></footer></article><script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script><script id=MathJax-script async src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script><script>MathJax={tex:{inlineMath:[['$','$'],['\\(','\\)']],processEscapes:true,processEnvironments:true},options:{skipHtmlTags:['script','noscript','style','textarea','pre']}};</script></section></div><footer class=footer><section class=container><p>© 2016 - 2023 正弦 | <a href=https://beian.miit.gov.cn/ target=_blank>京ICP备19051756号</a></p></section></footer></main><script src=https://ssine.ink/js/dark-mode.min.0213e1773e6d1c5a644f847c67a6f8abac49a3776e2976f6008038af8c5b76a1.js></script><script type=application/javascript>var doNotTrack=false;if(!doNotTrack){(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');ga('create','UA-127064931-1','auto');ga('send','pageview');}</script></body></html>
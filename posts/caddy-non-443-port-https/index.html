<!doctype html><html lang=zh-cn><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta http-equiv=content-language content="zh-cn"><meta name=author content="Sine"><meta name=description content="最近新入手了 HPE ProLiant MicroServer Gen10 Plus ，拿来做家庭服务器，以期避免长期租用云服务器。 虽然家庭服务器对比云服务器在性价比上有很明显的优势，但是却缺少了云服务的"><meta name=keywords content="blog,developer,personal"><meta name=twitter:card content="summary"><meta name=twitter:title content="使用 Caddy 在非 443 端口开启 HTTPS"><meta name=twitter:description content="最近新入手了 HPE ProLiant MicroServer Gen10 Plus ，拿来做家庭服务器，以期避免长期租用云服务器。 虽然家庭服务器对比云服务器在性价比上有很明显的优势，但是却缺少了云服务的"><meta property="og:title" content="使用 Caddy 在非 443 端口开启 HTTPS"><meta property="og:description" content="最近新入手了 HPE ProLiant MicroServer Gen10 Plus ，拿来做家庭服务器，以期避免长期租用云服务器。 虽然家庭服务器对比云服务器在性价比上有很明显的优势，但是却缺少了云服务的"><meta property="og:type" content="article"><meta property="og:url" content="https://ssine.ink/posts/caddy-non-443-port-https/"><meta property="article:published_time" content="2020-10-17T21:18:29+08:00"><meta property="article:modified_time" content="2020-10-17T21:18:29+08:00"><title>使用 Caddy 在非 443 端口开启 HTTPS · Sine's Site</title><link rel=canonical href=https://ssine.ink/posts/caddy-non-443-port-https/><link rel=preconnect href=https://fonts.gstatic.com><link href="https://fonts.googleapis.com/css?family=Lato:400,700%7CMerriweather:300,700%7CSource+Code+Pro:400,700&display=swap" rel=stylesheet><link rel=preload href="https://ssine.ink/fonts/forkawesome-webfont.woff2?v=1.1.7" as=font type=font/woff2 crossorigin><link rel=stylesheet href=https://ssine.ink/css/coder.min.a050bb9724f6a498b574acf612d6d523bc68756ddc62579923710a8542947c52.css integrity="sha256-oFC7lyT2pJi1dKz2EtbVI7xodW3cYleZI3EKhUKUfFI=" crossorigin=anonymous media=screen><link rel=stylesheet href=https://ssine.ink/css/coder-dark.min.126ad3988d46bdae6217a11105b53c9662bca05f39d42d3c0fb366919d334620.css integrity="sha256-EmrTmI1Gva5iF6ERBbU8lmK8oF851C08D7NmkZ0zRiA=" crossorigin=anonymous media=screen><link rel=icon type=image/png href=https://ssine.ink/favicon.ico sizes=32x32><link rel=icon type=image/png href=https://ssine.ink/favicon.ico sizes=16x16><link rel=apple-touch-icon href=https://ssine.ink/images/apple-touch-icon.png><link rel=apple-touch-icon sizes=180x180 href=https://ssine.ink/images/apple-touch-icon.png><meta name=generator content="Hugo 0.74.1"></head><body class=colorscheme-auto><div class=float-container><a id=dark-mode-toggle class=colorscheme-toggle><i class="fa fa-adjust fa-fw" aria-hidden=true></i></a></div><main class=wrapper><nav class=navigation><section class=container><a class=navigation-title href=https://ssine.ink/>Sine's Site</a>
<input type=checkbox id=menu-toggle>
<label class="menu-button float-right" for=menu-toggle><i class="fa fa-bars fa-fw" aria-hidden=true></i></label><ul class=navigation-list><li class=navigation-item><a class=navigation-link href=https://ssine.ink/posts/>博客</a></li><li class=navigation-item><a class=navigation-link href=https://kiwi.ssine.cc>维基</a></li><li class=navigation-item><a class=navigation-link href=https://ssine.ink/gallery>画廊</a></li><li class=navigation-item><a class=navigation-link href=https://ssine.ink/projects/>项目</a></li><li class="navigation-item menu-separator"><span>|</span></li><li class=navigation-item><a href=https://ssine.ink/en/posts/caddy-non-443-port-https/>English</a></li></ul></section></nav><div class=content><section class="container post"><article><header><div class=post-title><h1 class=title>使用 Caddy 在非 443 端口开启 HTTPS</h1></div><div class=post-meta><div class=date><span class=posted-on><i class="fa fa-calendar" aria-hidden=true></i><time datetime=2020-10-17T21:18:29+08:00>October 17, 2020</time></span>
<span class=reading-time><i class="fa fa-clock-o" aria-hidden=true></i>阅读时间：4 分钟</span></div></div></header><div><p>最近新入手了 HPE ProLiant MicroServer Gen10 Plus ，拿来做家庭服务器，以期避免长期租用云服务器。 虽然家庭服务器对比云服务器在性价比上有很明显的优势，但是却缺少了云服务的一项重要内容： 固定公网 IP 。 平时我们使用公网 IP 是为了可以随时随地访问服务器，而这个需求通过 DDNS 也可以实现，只是访问需要用域名而不是裸 IP 。</p><p>通常 DDNS 由路由器来完成，并通过端口映射的方式把内网的服务暴露在外。 国内要求所有 IP 只有在域名备案之后才可以开放 80 和 443 端口对外提供 Web 服务，云服务器可以照常备案，而普通家庭宽带用户被分配的公网 IP （某些运营商/地区甚至不会分配公网 IP）是每隔一段时间就会发生变化的，因此没有办法走常规备案的流程。 因此在国内只能通过其它端口来访问家里的 Web 应用，但是这样会导致部署自动 HTTPS （通过Let&rsquo;s Encrypt）变得很麻烦，本文会介绍如何通过 Caddy 在非 443 端口部署 HTTPS 服务以及背后的原理。</p><h1 id=lets-encrypt-与-challenge>Let&rsquo;s Encrypt 与 Challenge</h1><p>我们需要从证书颁发机构获取证书来在网站上启用 HTTPS ， Let&rsquo;s Encrypt 是一个免费此类颁发证书的机构，以下内容摘自 <a href=https://letsencrypt.org/zh-cn/getting-started/>Let&rsquo;s Encrypt/快速入门</a> 与 <a href=https://letsencrypt.org/zh-cn/docs/challenge-types/>Let&rsquo;s Encrypt/验证方式</a> ：</p><blockquote><p>为了在您的网站上启用 HTTPS，您需要从证书颁发机构（CA）获取证书（一种文件）。Let’s Encrypt 是一个证书颁发机构（CA）。要从 Let’s Encrypt 获取您网站域名的证书，您必须证明您对域名的实际控制权。您可以在您的 Web 主机上运行使用 ACME 协议的软件来获取 Let’s Encrypt 证书。</p><p>当您从 Let’s Encrypt 获得证书时，我们的服务器会验证您是否使用 ACME 标准定义的验证方式来验证您对证书中域名的控制权。大多数情况下，验证由 ACME 客户端自动处理，但如果您需要做出一些更复杂的配置决策，那么了解更多有关它们的信息会很有用。</p></blockquote><p>通过 ACME 协议向 Let&rsquo;s Encrypt 证明自己的域名所有权的过程就叫做 Challenge （验证），目前有三种 Challenge 的方式：</p><ul><li>HTTP-01</li><li>DNS-01</li><li>TLS-SNI-01 （已禁用）</li><li>TLS-ALPN-01</li></ul><p>HTTP-01 是目前最常见的验证方式，但是该验证方式需要通过 80 端口开放一个路径给 Let&rsquo;s Encrypt 访问它提供的 token 来验证你的域名所有权，因此在 80 端口被封锁的情况下这个验证方式是不现实的。 类似的， TLS-ALPN-01 需要通过 443 端口访问来验证，也是行不通。 这样对于国内家庭带宽用户来说就只剩下了一种方式： DNS-01 。</p><blockquote><p>此验证方式要求您在该域名下的 TXT 记录中放置特定值来证明您控制域名的 DNS 系统。该配置比 HTTP-01 略困难，但可以在某些 HTTP-01 不可用的情况下工作。它还允许您颁发通配符证书。在 Let’s Encrypt 为您的 ACME 客户端提供令牌后，您的客户端将创建从该令牌和您的帐户密钥派生的 TXT 记录，并将该记录放在 _acme-challenge.&lt;YOUR_DOMAIN> 下。然后 Let’s Encrypt 将向 DNS 系统查询该记录。如果找到匹配项，您就可以继续颁发证书！</p><p>由于颁发和续期的自动化非常重要，只有当您的 DNS 提供商拥有可用于自动更新的 API 时，使用 DNS-01 验证方式才有意义。我们的社区在此处提供了此类 DNS 提供商的列表。您的 DNS 提供商可能与您的域名注册商（您从中购买域名的公司）相同或不同。如果您想更改 DNS 提供商，只需在注册商处进行一些小的更改，而无需等待域名即将到期。</p></blockquote><p>这种方式是通过服务器修改 DNS 记录， Let&rsquo;s Encrypt 去查询的方式来验证域名所有权，因此需要服务器有权通过 API 访问 DNS 提供商并修改记录。</p><h1 id=caddy-配置>Caddy 配置</h1><p>目前常见的服务器开启 HTTPS 并自动续期的方案有两种： Caddy 和 Nginx + Certbot 。 后者配置的复杂程度很高，就算利用 docker 也不能避免冗长的配置编写过程，而 Caddy 内置了 HTTPS 以及自动续期的支持，配置也相对简洁，因此下面介绍使用 Caddy 部署 HTTPS 的方法。</p><p>Caddy 默认使用 HTTP-01 验证方式，要通过 DNS-01 验证需要对应的插件支持，通过软件源安装的 Caddy 没有这些插件，需要在<a href=https://caddyserver.com/download>下载页</a>下载或是通过 xcaddy 从源码构建。</p><p>下载页 caddy-dns 开头的几个插件就是 DNS-01 验证的插件，插件与 DNS 提供商有关，因此有好几个，本文使用阿里云 DNS ，因此选中了 caddy-dns/lego-deprecated 插件（这个插件最近在用 go 重写，新版功能还不全，因此先用着旧版）。 Linux amd64 + lego 插件的二进制包下载地址为 <a href="https://caddyserver.com/api/download?os=linux&arch=amd64&p=github.com%2Fcaddy-dns%2Flego-deprecated&idempotency=80128464204175">https://caddyserver.com/api/download?os=linux&arch=amd64&p=github.com%2Fcaddy-dns%2Flego-deprecated&idempotency=80128464204175</a> 。</p><p>下载之后执行 <code>chmod +x caddy && mv caddy /usr/bin</code> 赋予执行权限并移到 bin 目录。 下面编写 caddy 的配置文件 Caddyfile ：</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text>{
  http_port 1999
  https_port 2000
}

xxx.yourdomain.com {
  reverse_proxy localhost:2001

  tls {
    dns lego_deprecated alidns
  }
}
</code></pre></div><p>这里第一个大括号内是全局配置，声明了 caddy 要在哪个端口监听外部的 HTTP / HTTPS 请求，这个端口也是做 DDNS 的路由器需要转发到外部的端口。 后面 xxx.yourdomain.com 需要替换成个人的域名，大括号内是这个域名的配置： 反向代理本地 2001 端口的 Web 服务，且 tls 证书申请通过 dns 方式进行，使用的插件为 lego_deprecated ， alidns 为<a href=https://github.com/caddy-dns/lego-deprecated>插件的参数</a>。</p><p>根据 <a href=https://go-acme.github.io/lego/dns/alidns/>lego 的文档</a> ，我们需要把阿里云的 Access key ID 与 Access Key secret 设置为环境变量，这两个值可以在阿里云的控制台获取。 鼠标悬停在右上角头像上，弹出的名片里有一项 Access Key 管理，进入之后点击创建 Access Key 就可以得到一组 Access key ID 与 Access Key secret ，将这两个值保存在一个环境变量文件 <code>alidns.env</code> 里：</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-text data-lang=text>ALICLOUD_ACCESS_KEY=id
ALICLOUD_SECRET_KEY=secret
</code></pre></div><p>作为测试，可以先起一个 python 简易服务器：</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>python3 -m http.server <span style=color:#ae81ff>2001</span>
</code></pre></div><p>之后运行 caddy 服务：</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>caddy run --config Caddyfile --envfile alidns.env
</code></pre></div><p>如果一切正常，应该可以在终端日志看到 caddy 通过 dns challenge 申请到证书的过程，之后就可以通过域名 + 非 443 端口通过 HTTPS 访问本地的 Web 服务了。</p><h1 id=合规性提醒>合规性提醒</h1><p>目前对于个人用户能否搭建服务器貌似没有明确的规定（无论是否为80/443端口），此前也有非标准端口搭建 Web 服务导致宽带被封的<a href="https://www.v2ex.com/t/608821?p=1">案例</a>，因此建议不要把此方案应用于对流量与稳定性有较高需求的场景。</p></div><footer></footer></article><script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script><script id=MathJax-script async src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script><script>MathJax={tex:{inlineMath:[['$','$'],['\\(','\\)']],processEscapes:true,processEnvironments:true},options:{skipHtmlTags:['script','noscript','style','textarea','pre']}};</script></section></div><footer class=footer><section class=container><p>© 2016 - 2023 正弦 | <a href=https://beian.miit.gov.cn/ target=_blank>京ICP备19051756号</a></p></section></footer></main><script src=https://ssine.ink/js/dark-mode.min.0213e1773e6d1c5a644f847c67a6f8abac49a3776e2976f6008038af8c5b76a1.js></script><script type=application/javascript>var doNotTrack=false;if(!doNotTrack){(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');ga('create','UA-127064931-1','auto');ga('send','pageview');}</script></body></html>
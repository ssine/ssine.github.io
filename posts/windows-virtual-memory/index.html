<!doctype html><html lang=zh-cn><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta http-equiv=content-language content="zh-cn"><meta name=author content="Sine"><meta name=description content="虚拟内存提供了一个内存的逻辑视图，它并不对应于物理内存的布局。在运行的时候，内存管理器借助于硬件的支持，将虚拟地址映射成物理地址。 每个进程都"><meta name=keywords content="blog,developer,personal"><meta name=twitter:card content="summary"><meta name=twitter:title content="Windows 虚拟内存简介"><meta name=twitter:description content="虚拟内存提供了一个内存的逻辑视图，它并不对应于物理内存的布局。在运行的时候，内存管理器借助于硬件的支持，将虚拟地址映射成物理地址。 每个进程都"><meta property="og:title" content="Windows 虚拟内存简介"><meta property="og:description" content="虚拟内存提供了一个内存的逻辑视图，它并不对应于物理内存的布局。在运行的时候，内存管理器借助于硬件的支持，将虚拟地址映射成物理地址。 每个进程都"><meta property="og:type" content="article"><meta property="og:url" content="https://ssine.ink/posts/windows-virtual-memory/"><meta property="article:published_time" content="2018-06-13T00:00:00+00:00"><meta property="article:modified_time" content="2018-06-13T00:00:00+00:00"><title>Windows 虚拟内存简介 · Sine's Site</title><link rel=canonical href=https://ssine.ink/posts/windows-virtual-memory/><link rel=preconnect href=https://fonts.gstatic.com><link href="https://fonts.googleapis.com/css?family=Lato:400,700%7CMerriweather:300,700%7CSource+Code+Pro:400,700&display=swap" rel=stylesheet><link rel=preload href="https://ssine.ink/fonts/forkawesome-webfont.woff2?v=1.1.7" as=font type=font/woff2 crossorigin><link rel=stylesheet href=https://ssine.ink/css/coder.min.a050bb9724f6a498b574acf612d6d523bc68756ddc62579923710a8542947c52.css integrity="sha256-oFC7lyT2pJi1dKz2EtbVI7xodW3cYleZI3EKhUKUfFI=" crossorigin=anonymous media=screen><link rel=stylesheet href=https://ssine.ink/css/coder-dark.min.126ad3988d46bdae6217a11105b53c9662bca05f39d42d3c0fb366919d334620.css integrity="sha256-EmrTmI1Gva5iF6ERBbU8lmK8oF851C08D7NmkZ0zRiA=" crossorigin=anonymous media=screen><link rel=icon type=image/png href=https://ssine.ink/favicon.ico sizes=32x32><link rel=icon type=image/png href=https://ssine.ink/favicon.ico sizes=16x16><link rel=apple-touch-icon href=https://ssine.ink/images/apple-touch-icon.png><link rel=apple-touch-icon sizes=180x180 href=https://ssine.ink/images/apple-touch-icon.png><meta name=generator content="Hugo 0.74.1"></head><body class=colorscheme-auto><div class=float-container><a id=dark-mode-toggle class=colorscheme-toggle><i class="fa fa-adjust fa-fw" aria-hidden=true></i></a></div><main class=wrapper><nav class=navigation><section class=container><a class=navigation-title href=https://ssine.ink/>Sine's Site</a>
<input type=checkbox id=menu-toggle>
<label class="menu-button float-right" for=menu-toggle><i class="fa fa-bars fa-fw" aria-hidden=true></i></label><ul class=navigation-list><li class=navigation-item><a class=navigation-link href=https://ssine.ink/posts/>博客</a></li><li class=navigation-item><a class=navigation-link href=https://kiwi.ssine.cc>维基</a></li><li class=navigation-item><a class=navigation-link href=https://ssine.ink/gallery>画廊</a></li><li class=navigation-item><a class=navigation-link href=https://ssine.ink/projects/>项目</a></li><li class="navigation-item menu-separator"><span>|</span></li><li class=navigation-item><a href=https://ssine.ink/en/posts/windows-virtual-memory/>English</a></li></ul></section></nav><div class=content><section class="container post"><article><header><div class=post-title><h1 class=title>Windows 虚拟内存简介</h1></div><div class=post-meta><div class=date><span class=posted-on><i class="fa fa-calendar" aria-hidden=true></i><time datetime=2018-06-13T00:00:00Z>June 13, 2018</time></span>
<span class=reading-time><i class="fa fa-clock-o" aria-hidden=true></i>阅读时间：2 分钟</span></div><div class=categories><i class="fa fa-folder" aria-hidden=true></i><a href=https://ssine.ink/categories/%E8%AF%BE%E7%A8%8B/>课程</a></div><div class=tags><i class="fa fa-tag" aria-hidden=true></i><a href=https://ssine.ink/tags/windows/>windows</a>
<span class=separator>•</span>
<a href=https://ssine.ink/tags/%E8%AF%BE%E7%A8%8B/>课程</a></div></div></header><div><p>虚拟内存提供了一个内存的逻辑视图，它并不对应于物理内存的布局。在运行的时候，内存管理器借助于硬件的支持，将虚拟地址映射成物理地址。</p><p>每个进程都有自己的虚拟地址空间，而且它会感觉到自己独占了这个很大的地址空间。在 32 位 x86 系统中，总的虚拟地址空间的大小为 4GB。因为 32 位指针可以表示 0X00000000 到 0XFFFFFFFF 之间的值。但是默认情况下，Windows 会将 2GB 的地址空间给进程，作为其私有地址空间，称为用户模式空间；而另一半（地址空间中较高的一半，从 0X80000000 到 0XFFFFFFFF）则用做它自己的受保护的内核使用，称为内核模式空间。</p><p>虚拟内存有三个好处：</p><ul><li>程序可以使用一系列相邻的虚拟地址来访问物理内存中不相邻的内存块。</li><li>程序可以访问大于可用物理内存的内存缓冲区。当物理内存的供应量变小时，内存管理器会将物理内存页（通常大小为 4 KB）保存到磁盘文件。页面会根据需要在物理内存与磁盘之间换入换出。</li><li>不同进程使用的虚拟地址彼此隔离。一个进程中的代码无法访问正在由另一进程使用的物理内存。</li></ul><p>应用程序有三种使用内存方法：</p><ol><li>以页为单位的虚拟内存分配方法，适合于大型对象或结构数组；</li><li>内存映射文件方法，适合于大型数据流文件以及多个进程之间的数据共享；</li><li>内存堆方法，适合于大量的小型内存申请。</li></ol><p>有一系列的 Win32 API 可以用来进行内存相关的分配、使用、查询操作，详细内容可以查询微软的文档。下面主要介绍第一类方法。</p><p>Windows 进程虚地址空间中的页有 3 种状态：自由(free)，预留(reserved)，提交(committed)。进程还可以对某一页进行锁定(lock)与解锁(unlock)，被锁定的内存会有极大概率被保留在物理内存中(不能保证)。状态间的相互关系如下图：</p><p><img src=OS-virtual-memory-states.svg alt="Win32 memory"></p><p>Windows 可以对内存设置保护类型，实验中用到的几个列举如下：</p><table><thead><tr><th>宏定义</th><th>类型</th></tr></thead><tbody><tr><td>PAGE_READONLY</td><td>只读</td></tr><tr><td>PAGE_READWRITE</td><td>读写</td></tr><tr><td>PAGE_EXECUTE</td><td>执行</td></tr><tr><td>PAGE_EXECUTE_READ</td><td>写+执行</td></tr><tr><td>PAGE_EXECUTE_READWRITE</td><td>读写+执行</td></tr></tbody></table><p>对一个页执行权限以外的操作会引发错误。</p></div><footer></footer></article><script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script><script id=MathJax-script async src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script><script>MathJax={tex:{inlineMath:[['$','$'],['\\(','\\)']],processEscapes:true,processEnvironments:true},options:{skipHtmlTags:['script','noscript','style','textarea','pre']}};</script></section></div><footer class=footer><section class=container><p>© 2016 - 2023 正弦 | <a href=https://beian.miit.gov.cn/ target=_blank>京ICP备19051756号</a></p></section></footer></main><script src=https://ssine.ink/js/dark-mode.min.0213e1773e6d1c5a644f847c67a6f8abac49a3776e2976f6008038af8c5b76a1.js></script><script type=application/javascript>var doNotTrack=false;if(!doNotTrack){(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');ga('create','UA-127064931-1','auto');ga('send','pageview');}</script></body></html>
<!doctype html><html lang=zh-cn><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta http-equiv=content-language content="zh-cn"><meta name=author content="Sine"><meta name=description content="为了方便记笔记而写的随时进行屏幕截图并/或去除白底色并上传图片到 OSS 服务的脚本。 最近写笔记的时候遇到需要把纸上手写/屏幕上的内容放到网页上的问"><meta name=keywords content="blog,developer,personal"><meta name=twitter:card content="summary"><meta name=twitter:title content="自动化图片脚本"><meta name=twitter:description content="为了方便记笔记而写的随时进行屏幕截图并/或去除白底色并上传图片到 OSS 服务的脚本。 最近写笔记的时候遇到需要把纸上手写/屏幕上的内容放到网页上的问"><meta property="og:title" content="自动化图片脚本"><meta property="og:description" content="为了方便记笔记而写的随时进行屏幕截图并/或去除白底色并上传图片到 OSS 服务的脚本。 最近写笔记的时候遇到需要把纸上手写/屏幕上的内容放到网页上的问"><meta property="og:type" content="article"><meta property="og:url" content="https://ssine.ink/posts/auto-image-script/"><meta property="article:published_time" content="2018-04-26T00:00:00+00:00"><meta property="article:modified_time" content="2018-04-26T00:00:00+00:00"><title>自动化图片脚本 · Sine's Site</title><link rel=canonical href=https://ssine.ink/posts/auto-image-script/><link rel=preconnect href=https://fonts.gstatic.com><link href="https://fonts.googleapis.com/css?family=Lato:400,700%7CMerriweather:300,700%7CSource+Code+Pro:400,700&display=swap" rel=stylesheet><link rel=preload href="https://ssine.ink/fonts/forkawesome-webfont.woff2?v=1.1.7" as=font type=font/woff2 crossorigin><link rel=stylesheet href=https://ssine.ink/css/coder.min.a050bb9724f6a498b574acf612d6d523bc68756ddc62579923710a8542947c52.css integrity="sha256-oFC7lyT2pJi1dKz2EtbVI7xodW3cYleZI3EKhUKUfFI=" crossorigin=anonymous media=screen><link rel=stylesheet href=https://ssine.ink/css/coder-dark.min.126ad3988d46bdae6217a11105b53c9662bca05f39d42d3c0fb366919d334620.css integrity="sha256-EmrTmI1Gva5iF6ERBbU8lmK8oF851C08D7NmkZ0zRiA=" crossorigin=anonymous media=screen><link rel=icon type=image/png href=https://ssine.ink/favicon.ico sizes=32x32><link rel=icon type=image/png href=https://ssine.ink/favicon.ico sizes=16x16><link rel=apple-touch-icon href=https://ssine.ink/images/apple-touch-icon.png><link rel=apple-touch-icon sizes=180x180 href=https://ssine.ink/images/apple-touch-icon.png><meta name=generator content="Hugo 0.74.1"></head><body class=colorscheme-auto><div class=float-container><a id=dark-mode-toggle class=colorscheme-toggle><i class="fa fa-adjust fa-fw" aria-hidden=true></i></a></div><main class=wrapper><nav class=navigation><section class=container><a class=navigation-title href=https://ssine.ink/>Sine's Site</a>
<input type=checkbox id=menu-toggle>
<label class="menu-button float-right" for=menu-toggle><i class="fa fa-bars fa-fw" aria-hidden=true></i></label><ul class=navigation-list><li class=navigation-item><a class=navigation-link href=https://ssine.ink/posts/>博客</a></li><li class=navigation-item><a class=navigation-link href=https://kiwi.ssine.cc>维基</a></li><li class=navigation-item><a class=navigation-link href=https://ssine.ink/gallery>画廊</a></li><li class=navigation-item><a class=navigation-link href=https://ssine.ink/projects/>项目</a></li><li class="navigation-item menu-separator"><span>|</span></li><li class=navigation-item><a href=https://ssine.ink/en/posts/auto-image-script/>English</a></li></ul></section></nav><div class=content><section class="container post"><article><header><div class=post-title><h1 class=title>自动化图片脚本</h1></div><div class=post-meta><div class=date><span class=posted-on><i class="fa fa-calendar" aria-hidden=true></i><time datetime=2018-04-26T00:00:00Z>April 26, 2018</time></span>
<span class=reading-time><i class="fa fa-clock-o" aria-hidden=true></i>阅读时间：2 分钟</span></div></div></header><div><p>为了方便记笔记而写的随时进行屏幕截图并/或去除白底色并上传图片到 OSS 服务的脚本。</p><p>最近写笔记的时候遇到需要把纸上手写/屏幕上的内容放到网页上的问题，这个是有一套手动的解决方案的：印象笔记文档扫描，保存同步到电脑，电脑上下载下来，PS 去掉白色背景，上传到 OSS，获取图片链接，插入到笔记上。不过整个过程太过冗杂，让我感到难受，就想办法写个脚本。原本想着全套包揽，但之后发现摄像头文档扫描和手机电脑文件同步这两点实在是不好做，就还是用印象笔记了。所以脚本做的事情是：可以截图，给文档图片去除白色背景（透明色，可选功能），上传到 OSS，把链接地址复制到剪贴板。</p><h2 id=屏幕截图>屏幕截图</h2><p>主要使用了 github 上一个现成的 python 库，用 pyQt5 写成，轻量级，好用。在源码的基础上修改了一下就能用了。</p><p><a href=https://github.com/SeptemberHX/screenshot>https://github.com/SeptemberHX/screenshot</a></p><h2 id=oss-api>OSS API</h2><p>先想办法以编程的方式上传到阿里云的 OSS，翻了半天他们的 API 官方文档，后来发现有现成的 Python SDK，何乐而不为：）</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>pip install oss2
</code></pre></div><p>就可以安装了。使用起来也很方便，用权限 ID 与密钥、终端名称等初始化，之后直接上传一个文件对象就行。专门给自动上传脚本设了文件前缀。不过本来就是拿来做图床的 OSS 结构也挺乱的。</p><p>上传完成之后用 python 的跨平台剪贴板包<code>pyperclip</code>来把地址复制到剪贴板</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=color:#f92672>import</span> pyperclip

pyperclip<span style=color:#f92672>.</span>copy(address)
</code></pre></div><p>这样基础结构就完成了。</p><h2 id=去除图片白底色>去除图片白底色</h2><p>还有比较麻烦的一点是背景透明化，因为白色背景的图片放到别的颜色的网页上会很丑。印象笔记扫描模式出来的照片背景基本都是很白的，之前直接在 PS 里面选中颜色（容差也不大）删除就行。这一步还是可以编程实现的。</p><p>Python 的图片处理库：PIL(Python Image Library)。步骤：读入文件、转换为 RGBA 模式、遍历像素，如果是白色就把 Alpha 通道设为 0、保存。代码：</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=color:#f92672>from</span> PIL <span style=color:#f92672>import</span> Image

im <span style=color:#f92672>=</span> Image<span style=color:#f92672>.</span>open(filename)<span style=color:#f92672>.</span>convert(<span style=color:#e6db74>&#39;RGBA&#39;</span>)
pix <span style=color:#f92672>=</span> im<span style=color:#f92672>.</span>load()
<span style=color:#66d9ef>for</span> y <span style=color:#f92672>in</span> range(im<span style=color:#f92672>.</span>size[<span style=color:#ae81ff>1</span>]):
    <span style=color:#66d9ef>for</span> x <span style=color:#f92672>in</span> range(im<span style=color:#f92672>.</span>size[<span style=color:#ae81ff>0</span>]):
        <span style=color:#66d9ef>if</span> pix[x,y][<span style=color:#ae81ff>0</span>] <span style=color:#f92672>&gt;</span> <span style=color:#ae81ff>220</span> <span style=color:#f92672>and</span> pix[x,y][<span style=color:#ae81ff>2</span>] <span style=color:#f92672>&gt;</span> <span style=color:#ae81ff>220</span> <span style=color:#f92672>and</span> pix[x,y][<span style=color:#ae81ff>3</span>] <span style=color:#f92672>&gt;</span> <span style=color:#ae81ff>220</span>:
            pix[x,y] <span style=color:#f92672>=</span> (<span style=color:#ae81ff>255</span>,<span style=color:#ae81ff>255</span>,<span style=color:#ae81ff>255</span>,<span style=color:#ae81ff>0</span>)
filename <span style=color:#f92672>=</span> os<span style=color:#f92672>.</span>path<span style=color:#f92672>.</span>splitext(filename)[<span style=color:#ae81ff>0</span>] <span style=color:#f92672>+</span> <span style=color:#e6db74>&#39;_rmbg.png&#39;</span>
im<span style=color:#f92672>.</span>save(filename, <span style=color:#e6db74>&#39;PNG&#39;</span>)
</code></pre></div><h2 id=配置-path>配置 Path</h2><p>这样基本就完成了。为了让脚本能在任何路径下访问到，新建了路径 D:\scripts\，并把它加入到系统 Path 中，这样里面的脚本就可以直接执行了。目录下 python 文件和 bat 脚本，通过执行 bat 来调用 python 脚本。ossup.bat：</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bat data-lang=bat>python D:\scripts\oss.py %1 %2
</code></pre></div><p>大功告成。</p><p>最后附上完整 python 文件：</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=color:#f92672>import</span> os<span style=color:#f92672>,</span> sys<span style=color:#f92672>,</span> pyperclip
<span style=color:#f92672>import</span> oss2
<span style=color:#f92672>from</span> PIL <span style=color:#f92672>import</span> Image

<span style=color:#66d9ef>if</span> len(sys<span style=color:#f92672>.</span>argv) <span style=color:#f92672>&lt;</span> <span style=color:#ae81ff>2</span>:
    <span style=color:#66d9ef>print</span>(<span style=color:#e6db74>&#39;No enough arguments!&#39;</span>)
    exit()

filename <span style=color:#f92672>=</span> os<span style=color:#f92672>.</span>path<span style=color:#f92672>.</span>basename(sys<span style=color:#f92672>.</span>argv[<span style=color:#ae81ff>1</span>])

<span style=color:#66d9ef>if</span> <span style=color:#f92672>not</span> os<span style=color:#f92672>.</span>path<span style=color:#f92672>.</span>exists(filename):
    <span style=color:#66d9ef>print</span>(<span style=color:#e6db74>&#39;File not exists : &#39;</span> <span style=color:#f92672>+</span> filename)
    exit()

<span style=color:#66d9ef>if</span> <span style=color:#e6db74>&#39;bg&#39;</span> <span style=color:#f92672>in</span> sys<span style=color:#f92672>.</span>argv:
    <span style=color:#66d9ef>print</span>(<span style=color:#e6db74>&#39;Processing background...&#39;</span>)
    im <span style=color:#f92672>=</span> Image<span style=color:#f92672>.</span>open(filename)<span style=color:#f92672>.</span>convert(<span style=color:#e6db74>&#39;RGBA&#39;</span>)
    pix <span style=color:#f92672>=</span> im<span style=color:#f92672>.</span>load()
    <span style=color:#66d9ef>for</span> y <span style=color:#f92672>in</span> range(im<span style=color:#f92672>.</span>size[<span style=color:#ae81ff>1</span>]):
        <span style=color:#66d9ef>for</span> x <span style=color:#f92672>in</span> range(im<span style=color:#f92672>.</span>size[<span style=color:#ae81ff>0</span>]):
            <span style=color:#66d9ef>if</span> pix[x,y][<span style=color:#ae81ff>0</span>] <span style=color:#f92672>&gt;</span> <span style=color:#ae81ff>220</span> <span style=color:#f92672>and</span> pix[x,y][<span style=color:#ae81ff>2</span>] <span style=color:#f92672>&gt;</span> <span style=color:#ae81ff>220</span> <span style=color:#f92672>and</span> pix[x,y][<span style=color:#ae81ff>3</span>] <span style=color:#f92672>&gt;</span> <span style=color:#ae81ff>220</span>:
                pix[x,y] <span style=color:#f92672>=</span> (<span style=color:#ae81ff>255</span>,<span style=color:#ae81ff>255</span>,<span style=color:#ae81ff>255</span>,<span style=color:#ae81ff>0</span>)
    filename <span style=color:#f92672>=</span> os<span style=color:#f92672>.</span>path<span style=color:#f92672>.</span>splitext(filename)[<span style=color:#ae81ff>0</span>] <span style=color:#f92672>+</span> <span style=color:#e6db74>&#39;_rmbg.png&#39;</span>
    im<span style=color:#f92672>.</span>save(filename, <span style=color:#e6db74>&#39;PNG&#39;</span>)

<span style=color:#66d9ef>print</span>(<span style=color:#e6db74>&#39;Initializing oss sdk...&#39;</span>)

access_key_id <span style=color:#f92672>=</span> os<span style=color:#f92672>.</span>getenv(<span style=color:#e6db74>&#39;OSS_TEST_ACCESS_KEY_ID&#39;</span>, <span style=color:#e6db74>&#39;&lt;&gt;&#39;</span>)
access_key_secret <span style=color:#f92672>=</span> os<span style=color:#f92672>.</span>getenv(<span style=color:#e6db74>&#39;OSS_TEST_ACCESS_KEY_SECRET&#39;</span>, <span style=color:#e6db74>&#39;&lt;&gt;&#39;</span>)
bucket_name <span style=color:#f92672>=</span> os<span style=color:#f92672>.</span>getenv(<span style=color:#e6db74>&#39;OSS_TEST_BUCKET&#39;</span>, <span style=color:#e6db74>&#39;&lt;&gt;&#39;</span>)
endpoint <span style=color:#f92672>=</span> os<span style=color:#f92672>.</span>getenv(<span style=color:#e6db74>&#39;OSS_TEST_ENDPOINT&#39;</span>, <span style=color:#e6db74>&#39;&lt;&gt;&#39;</span>)

bucket <span style=color:#f92672>=</span> oss2<span style=color:#f92672>.</span>Bucket(oss2<span style=color:#f92672>.</span>Auth(access_key_id, access_key_secret), endpoint, bucket_name)

oss_name <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;autoup/&#39;</span> <span style=color:#f92672>+</span> filename

<span style=color:#66d9ef>print</span>(<span style=color:#e6db74>&#39;Filename : &#39;</span> <span style=color:#f92672>+</span> oss_name <span style=color:#f92672>+</span> <span style=color:#e6db74>&#39;</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>Uploading&#39;</span>)

<span style=color:#66d9ef>with</span> open(filename, <span style=color:#e6db74>&#39;rb&#39;</span>) <span style=color:#66d9ef>as</span> f:
    bucket<span style=color:#f92672>.</span>put_object(oss_name, f)

<span style=color:#66d9ef>if</span> <span style=color:#e6db74>&#39;bg&#39;</span> <span style=color:#f92672>in</span> sys<span style=color:#f92672>.</span>argv:
    os<span style=color:#f92672>.</span>remove(filename)

address <span style=color:#f92672>=</span> <span style=color:#e6db74>&#39;&lt;&gt;&#39;</span> <span style=color:#f92672>+</span> oss_name
pyperclip<span style=color:#f92672>.</span>copy(address)

<span style=color:#66d9ef>print</span>(<span style=color:#e6db74>&#39;Address copied to clipboard!</span><span style=color:#ae81ff>\n</span><span style=color:#e6db74>Bye~&#39;</span>)
</code></pre></div></div><footer></footer></article><script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script><script id=MathJax-script async src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script><script>MathJax={tex:{inlineMath:[['$','$'],['\\(','\\)']],processEscapes:true,processEnvironments:true},options:{skipHtmlTags:['script','noscript','style','textarea','pre']}};</script></section></div><footer class=footer><section class=container><p>© 2016 - 2023 正弦 | <a href=https://beian.miit.gov.cn/ target=_blank>京ICP备19051756号</a></p></section></footer></main><script src=https://ssine.ink/js/dark-mode.min.0213e1773e6d1c5a644f847c67a6f8abac49a3776e2976f6008038af8c5b76a1.js></script><script type=application/javascript>var doNotTrack=false;if(!doNotTrack){(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');ga('create','UA-127064931-1','auto');ga('send','pageview');}</script></body></html>
<!doctype html><html lang=zh-cn><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta http-equiv=content-language content="zh-cn"><meta name=author content="Sine"><meta name=description content="平时经常会有一些小的想法需要测试，比如看一下 TypeScript 能不能支持这个写法，用 Python 做两道题，快速处理一些文件。 这种时候在本地开一个编辑器写脚本再运行就比"><meta name=keywords content="blog,developer,personal"><meta name=twitter:card content="summary"><meta name=twitter:title content="打造有多个内核的 Jupyter Lab 容器"><meta name=twitter:description content="平时经常会有一些小的想法需要测试，比如看一下 TypeScript 能不能支持这个写法，用 Python 做两道题，快速处理一些文件。 这种时候在本地开一个编辑器写脚本再运行就比"><meta property="og:title" content="打造有多个内核的 Jupyter Lab 容器"><meta property="og:description" content="平时经常会有一些小的想法需要测试，比如看一下 TypeScript 能不能支持这个写法，用 Python 做两道题，快速处理一些文件。 这种时候在本地开一个编辑器写脚本再运行就比"><meta property="og:type" content="article"><meta property="og:url" content="https://ssine.ink/posts/versatile-jupyter-lab/"><meta property="article:published_time" content="2021-03-07T19:08:13+08:00"><meta property="article:modified_time" content="2021-03-07T19:08:13+08:00"><title>打造有多个内核的 Jupyter Lab 容器 · Sine's Site</title><link rel=canonical href=https://ssine.ink/posts/versatile-jupyter-lab/><link rel=preconnect href=https://fonts.gstatic.com><link href="https://fonts.googleapis.com/css?family=Lato:400,700%7CMerriweather:300,700%7CSource+Code+Pro:400,700&display=swap" rel=stylesheet><link rel=preload href="https://ssine.ink/fonts/forkawesome-webfont.woff2?v=1.1.7" as=font type=font/woff2 crossorigin><link rel=stylesheet href=https://ssine.ink/css/coder.min.a050bb9724f6a498b574acf612d6d523bc68756ddc62579923710a8542947c52.css integrity="sha256-oFC7lyT2pJi1dKz2EtbVI7xodW3cYleZI3EKhUKUfFI=" crossorigin=anonymous media=screen><link rel=stylesheet href=https://ssine.ink/css/coder-dark.min.126ad3988d46bdae6217a11105b53c9662bca05f39d42d3c0fb366919d334620.css integrity="sha256-EmrTmI1Gva5iF6ERBbU8lmK8oF851C08D7NmkZ0zRiA=" crossorigin=anonymous media=screen><link rel=icon type=image/png href=https://ssine.ink/favicon.ico sizes=32x32><link rel=icon type=image/png href=https://ssine.ink/favicon.ico sizes=16x16><link rel=apple-touch-icon href=https://ssine.ink/images/apple-touch-icon.png><link rel=apple-touch-icon sizes=180x180 href=https://ssine.ink/images/apple-touch-icon.png><meta name=generator content="Hugo 0.74.1"></head><body class=colorscheme-auto><div class=float-container><a id=dark-mode-toggle class=colorscheme-toggle><i class="fa fa-adjust fa-fw" aria-hidden=true></i></a></div><main class=wrapper><nav class=navigation><section class=container><a class=navigation-title href=https://ssine.ink/>Sine's Site</a>
<input type=checkbox id=menu-toggle>
<label class="menu-button float-right" for=menu-toggle><i class="fa fa-bars fa-fw" aria-hidden=true></i></label><ul class=navigation-list><li class=navigation-item><a class=navigation-link href=https://ssine.ink/posts/>博客</a></li><li class=navigation-item><a class=navigation-link href=https://kiwi.ssine.cc>维基</a></li><li class=navigation-item><a class=navigation-link href=https://ssine.ink/gallery>画廊</a></li><li class=navigation-item><a class=navigation-link href=https://ssine.ink/projects/>项目</a></li><li class="navigation-item menu-separator"><span>|</span></li><li class=navigation-item><a href=https://ssine.ink/en/posts/versatile-jupyter-lab/>English</a></li></ul></section></nav><div class=content><section class="container post"><article><header><div class=post-title><h1 class=title>打造有多个内核的 Jupyter Lab 容器</h1></div><div class=post-meta><div class=date><span class=posted-on><i class="fa fa-calendar" aria-hidden=true></i><time datetime=2021-03-07T19:08:13+08:00>March 7, 2021</time></span>
<span class=reading-time><i class="fa fa-clock-o" aria-hidden=true></i>阅读时间：3 分钟</span></div></div></header><div><p>平时经常会有一些小的想法需要测试，比如看一下 TypeScript 能不能支持这个写法，用 Python 做两道题，快速处理一些文件。 这种时候在本地开一个编辑器写脚本再运行就比较繁琐，把各种语言的环境放在本机也比较乱且不便携，因此萌生了部署一个 Jupyter Lab 服务，可以随时随地通过浏览器写各种语言的代码的想法。</p><p>目前 Jupyter Lab 深受社区欢迎，已经有各种各样的语言实现了 Jupyter 的 Kernel ( 详见 <a href=https://github.com/jupyter/jupyter/wiki/Jupyter-kernels>文档</a> ) 。 我挑选了个人比较常用的几个语言做了集成 ( 通常一个语言有好几个 Kernel 实现，挑选了其中比较完善的 ) ：</p><ul><li>GoLang - <a href=https://github.com/gopherdata/gophernotes>gophernotes</a></li><li>TypeScript & JavaScript - <a href=https://github.com/yunabe/tslab>tslab</a></li><li>C++11/14/17 - <a href=https://github.com/jupyter-xeus/xeus-cling>xeus-cling</a></li><li>Racket - <a href=https://github.com/rmculpepper/iracket>iracket</a></li><li>Scala - <a href=https://github.com/almond-sh/almond>almond</a></li><li>Java - <a href=https://github.com/SpencerPark/IJava>IJava</a></li></ul><p>目前这个镜像已经在 Docker Hub 上公开，使用方式：</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>docker run -d <span style=color:#ae81ff>\
</span><span style=color:#ae81ff></span>  --name<span style=color:#f92672>=</span>jupyter <span style=color:#ae81ff>\
</span><span style=color:#ae81ff></span>  -e LABUID<span style=color:#f92672>=</span><span style=color:#ae81ff>1000</span> <span style=color:#ae81ff>\
</span><span style=color:#ae81ff></span>  -e LABGID<span style=color:#f92672>=</span><span style=color:#ae81ff>1000</span> <span style=color:#ae81ff>\
</span><span style=color:#ae81ff></span>  -e LABPASSWD<span style=color:#f92672>=</span>userpassword <span style=color:#ae81ff>\
</span><span style=color:#ae81ff></span>  -e JUPYTER_TOKEN<span style=color:#f92672>=</span>token_to_jupyter_page <span style=color:#ae81ff>\
</span><span style=color:#ae81ff></span>  -p 80:8080 <span style=color:#ae81ff>\
</span><span style=color:#ae81ff></span>  -v /home/user/lab:/data <span style=color:#ae81ff>\
</span><span style=color:#ae81ff></span>  --restart unless-stopped <span style=color:#ae81ff>\
</span><span style=color:#ae81ff></span>  sineliu/jupyterlab-all-in-one:latest
</code></pre></div><p><img src=screenshot.png alt=screenshot></p><h2 id=一些实现细节>一些实现细节</h2><p>事情很简单，但是做起来有很多要解决的问题，下面简单聊一下。</p><h3 id=指定-jupyter-lab-密码>指定 Jupyter Lab 密码</h3><p>Jupyter Lab 通常会在启动后生成一个 Token，用来在浏览器登录，然而这个方式并不便于用户在一段时间后重新登陆 ( Token 容易丢 ) 。 有两个解决方案，一个是通过用户名密码登录，一个是指定 Token。 用户名密码登录的方式都需要比较麻烦的配置，好在 Jupyter Lab 支持通过环境变量 <a href="https://jupyter-notebook.readthedocs.io/en/stable/config.html?highlight=JUPYTER_TOKEN#options">JUPYTER_TOKEN</a> 指定 Token ，这个东西很难搜，翻了半天文档才找到 ( 真的很久！ ) 。 这样就可以通过设置环境变量的方式固定一个方便记忆的 Token 了。</p><h3 id=通过自定义用户避免-docker-root-权限产生问题>通过自定义用户避免 Docker Root 权限产生问题</h3><p>Docker 容器默认以 root 用户运行，这导致在容器下面创建的文件 owner 都是 root。 不清楚 docker 有没有官方的解决方案，我最后是通过在容器第一次启动时创建用户来实现的。 这个过程分为两步，第一个时识别首次启动 ( 否则 restart 时再次创建用户会报错 ) ，第二个是用非交互的方式创建指定密码的用户。</p><p>一开始并没有什么首次启动脚本的思路，找了一圈发现可以把一个文件当作 flag，如果文件不存在就是首次，然后创建该文件，之后检测到文件存在，就知道不是首次启动了。</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=color:#66d9ef>if</span> test -e /tmp/fr; <span style=color:#66d9ef>then</span> <span style=color:#ae81ff>\
</span><span style=color:#ae81ff></span>  regular script <span style=color:#ae81ff>\
</span><span style=color:#ae81ff></span><span style=color:#66d9ef>else</span> <span style=color:#ae81ff>\
</span><span style=color:#ae81ff></span>  touch /tmp/fr <span style=color:#ae81ff>\
</span><span style=color:#ae81ff></span>  initialization script <span style=color:#ae81ff>\
</span><span style=color:#ae81ff></span><span style=color:#66d9ef>fi</span>
</code></pre></div><p>之后是非交互创建指定密码的用户，一般修改密码是交互式进行的 ( 需要用户手动在命令行输入密码 ) ，好在 <code>chpasswd</code> 命令支持流式输入，这样就可以用 <code>|</code> 符号设置密码了，镜像会读取三个环境变量：</p><ul><li>LABUID: uid</li><li>LABGID: gid</li><li>LABPASSWD： 用户密码</li></ul><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>groupadd -g <span style=color:#e6db74>${</span>LABGID<span style=color:#e6db74>}</span> username
useradd -u <span style=color:#e6db74>${</span>LABUID<span style=color:#e6db74>}</span> -g <span style=color:#e6db74>${</span>LABGID<span style=color:#e6db74>}</span> -G wheel username
echo <span style=color:#e6db74>&#34;username:</span><span style=color:#e6db74>${</span>LABPASSWD<span style=color:#e6db74>}</span><span style=color:#e6db74>&#34;</span> | chpasswd
</code></pre></div><p>首先创建一个指定 group id 的 group，之后创建用户，并赋予指定的 user id 和 group id，同时添加到 wheel 用户组赋予用户 root 权限。 最后通过 echo + pip 的方式避免 chpasswd 要求交互式输入并设置密码。</p><h3 id=与网络做斗争>与网络做斗争</h3><p>国内的网络环境访问很多外网资源的时候会慢速、卡顿甚至中断。 这个问题在 Docker build 的过程中尤为明显，因为要下载很多资源，比较常用的资源通常有国内源，很多比较罕见的安装包就只能多试几次了。 如何在 <code>curl</code> 下载失败的时候不报错而是静默重试呢？ 可以用循环来完成：</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=color:#66d9ef>for</span> i in <span style=color:#ae81ff>1</span> <span style=color:#ae81ff>2</span> <span style=color:#ae81ff>3</span> <span style=color:#ae81ff>4</span> 5; <span style=color:#66d9ef>do</span> <span style=color:#ae81ff>\
</span><span style=color:#ae81ff></span>  curl -L https://git.io/vQhTU | bash <span style=color:#f92672>&amp;&amp;</span> break <span style=color:#ae81ff>\
</span><span style=color:#ae81ff></span>  <span style=color:#f92672>||</span> sleep 1; <span style=color:#ae81ff>\
</span><span style=color:#ae81ff></span><span style=color:#66d9ef>done</span>
</code></pre></div><p>整个循环会重试 5 次，一旦脚本正常执行没有报错，就会 break 退出循环，否则睡眠 1 秒后重试。</p><p>后来碰巧租了一个香港的服务器，访问国内国外的资源速度都快的飞起，也是个不错的解决方案 ( 就是要多花点钱 XD ) 。</p><h3 id=上传-docker-hub>上传 Docker Hub</h3><p>上传到 Docker Hub 的过程比想象中要简单，首先注册一个账号，然后起个名字，创建仓库。在本地构建镜像的时候使用仓库的名字：</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>docker build -t sineliu/jupyterlab-all-in-one:latest .
</code></pre></div><p>之后</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>docker push sineliu/jupyterlab-all-in-one:latest
</code></pre></div><p>就可以了。</p></div><footer></footer></article><script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script><script id=MathJax-script async src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script><script>MathJax={tex:{inlineMath:[['$','$'],['\\(','\\)']],processEscapes:true,processEnvironments:true},options:{skipHtmlTags:['script','noscript','style','textarea','pre']}};</script></section></div><footer class=footer><section class=container><p>© 2016 - 2023 正弦 | <a href=https://beian.miit.gov.cn/ target=_blank>京ICP备19051756号</a></p></section></footer></main><script src=https://ssine.ink/js/dark-mode.min.0213e1773e6d1c5a644f847c67a6f8abac49a3776e2976f6008038af8c5b76a1.js></script><script type=application/javascript>var doNotTrack=false;if(!doNotTrack){(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');ga('create','UA-127064931-1','auto');ga('send','pageview');}</script></body></html>
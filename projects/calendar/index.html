<!DOCTYPE html>
<html>

<head>
  <link rel="shortcut icon" href="./favicon.ico" type="image/x-icon" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
  <title>L.I.F.E</title>
  <style>
    body {
      margin-top: 0px;
    }

    #container {
      width: 80%;
      margin: 0 auto;
      line-height: 0px;
      display: flex;
      flex-wrap: wrap;
    }

    .day {
      border-style: solid;
      border-width: 1px;
      border-color: darkgray;
      cursor: default;
      width: 20px;
      height: 20px;
      margin: 1px;
      line-height: 20px;
      font-size: 15px;
      text-align: center;
    }

    .left-margin {
      position: absolute;
      left: 5%;
    }

    h1 {
      text-align: center;
      margin-top: 0px;
      padding-top: 20px;
    }

    .detail {
      display: none;
      position: absolute;
      margin: 0;
      background-color: aliceblue;
      border-width: 2px;
    }

    /* æŠ½å±‰æ ·å¼ */
    #drawer {
      position: fixed;
      right: 0;
      top: 0;
      width: 400px;
      height: 100vh;
      background-color: #ffffff;
      box-shadow: -2px 0 8px rgba(0, 0, 0, 0.15);
      transform: translateX(100%);
      transition: transform 0.3s ease;
      z-index: 1000;
      display: flex;
      flex-direction: column;
    }

    #drawer.open {
      transform: translateX(0);
    }

    #drawer-toggle {
      position: fixed;
      right: 0;
      top: 50%;
      transform: translateY(-50%);
      background-color: #881798;
      color: white;
      border: none;
      padding: 15px 10px;
      cursor: pointer;
      border-radius: 5px 0 0 5px;
      z-index: 999;
      font-size: 16px;
      transition: right 0.3s ease;
    }

    #drawer-toggle.drawer-open {
      right: 400px;
    }

    #drawer-header {
      padding: 20px;
      background-color: #F9E4FE;
      border-bottom: 2px solid #881798;
    }

    #drawer-header h2 {
      margin: 0 0 15px 0;
      color: #881798;
      font-size: 20px;
    }

    #search-box {
      width: 100%;
      padding: 10px;
      border: 2px solid #881798;
      border-radius: 5px;
      font-size: 14px;
      box-sizing: border-box;
    }

    #drawer-content {
      flex: 1;
      overflow-y: auto;
      padding: 15px;
    }

    .record-card {
      background-color: #f9f9f9;
      border: 1px solid #ddd;
      border-left: 4px solid #881798;
      border-radius: 5px;
      padding: 15px;
      margin-bottom: 15px;
      transition: all 0.2s ease;
    }

    .record-card:hover {
      box-shadow: 0 2px 8px rgba(136, 23, 152, 0.2);
      transform: translateY(-2px);
    }

    .record-card.hidden {
      display: none;
    }

    .record-date {
      font-weight: bold;
      color: #881798;
      margin-bottom: 8px;
      font-size: 16px;
    }

    .record-content {
      color: #333;
      line-height: 1.6;
      font-size: 14px;
    }

    .no-records {
      text-align: center;
      color: #999;
      padding: 40px 20px;
      font-size: 14px;
    }

    ::-webkit-scrollbar {
      width: 10px;
      height: 10px;
      background-color: #f5f5f5;
    }

    ::-webkit-scrollbar-track {
      border-radius: 0px;
      background-color: #F9E4FE;
    }

    ::-webkit-scrollbar-thumb {
      height: 20px;
      border-radius: 0px;
      background-color: #881798;
    }

    ::-webkit-scrollbar-thumb:hover {
      background: #A31FBF;
    }
  </style>
</head>

<body>

  <h1>LIFE Calendar</h1>
  <div style="text-align: center;">å…¶å®äººç”Ÿ å¹¶éè™šè€—</div><br>

  <div id="left-margin" style="display: none;"></div>
  <div id="body" style="display: none;"></div>
  <div id="detail"></div>
  <div id="password-section" style="display: none; text-align: center;">
    <input id="password" type="password" placeholder="è¯·è¾“å…¥å¯†ç " /><button onclick="setPassword()">ç¡®è®¤</button>
  </div>

  <!-- æŠ½å±‰æŒ‰é’® -->
  <button id="drawer-toggle" onclick="toggleDrawer()" style="display: none;">ğŸ“</button>

  <!-- æŠ½å±‰ -->
  <div id="drawer" style="display: none;">
    <div id="drawer-header">
      <h2>æ¯æ—¥è®°å½•</h2>
      <input type="text" id="search-box" placeholder="æœç´¢æ—¥æœŸæˆ–å†…å®¹..." oninput="searchRecords()">
    </div>
    <div id="drawer-content">
      <div class="no-records">æš‚æ— è®°å½•</div>
    </div>
  </div>

  <script>
    function setPassword() {
      const pw = document.getElementById('password').value;
      if (!pw) {
        alert('è¯·è¾“å…¥å¯†ç ');
        return;
      }
      document.cookie = `password=${pw};max-age=${365 * 24 * 3600}`;
      // å°è¯•åŠ è½½æ•°æ®
      loadEventsWithAuth(pw);
    }
    function getCookie(sKey) {
      return decodeURIComponent(document.cookie.replace(new RegExp("(?:(?:^|.*;)\\s*" + encodeURIComponent(sKey).replace(/[-.+*]/g, "\\$&") + "\\s*\\=\\s*([^;]*).*$)|^.*$"), "$1")) || null;
    }
  </script>

  <script>
    let display_count = 0;
    let isAuthenticated = false;

    history.scrollRestoration = 'manual';
    const birth = new Date(1998, 4, 30);
    const expected_years = 102;
    const death = new Date(1998 + expected_years, 4, 30);
    const today = new Date();
    const password = getCookie('password');

    // å°è¯•è®¤è¯å¹¶åŠ è½½äº‹ä»¶æ•°æ®
    function loadEventsWithAuth(token) {
      $.ajax({
        url: "https://life-cadar-data-srkfhcittb.cn-beijing.fcapp.run",
        method: "GET",
        headers: {
          "Authorization": "Bearer " + token
        },
        success: function(res) {
          if (res && res.indexOf('<div id="events">') !== -1) {
            // è®¤è¯æˆåŠŸ
            isAuthenticated = true;
            let p = new DOMParser();
            p = p.parseFromString(res, 'text/html');
            process_events(p.getElementById('events'));
            // éšè—å¯†ç è¾“å…¥æ¡†
            document.getElementById('password-section').style.display = 'none';
            // æ˜¾ç¤ºæ—¥å†å†…å®¹
            document.getElementById('left-margin').style.display = 'block';
            document.getElementById('body').style.display = 'block';
            document.getElementById('drawer-toggle').style.display = 'block';
            document.getElementById('drawer').style.display = 'flex';
            // ç”Ÿæˆå¹´é¾„æ ‡ç­¾
            generateAgeLabels();
            // æ¸²æŸ“æŠ½å±‰å†…å®¹
            renderDrawerContent();
            // æ»šåŠ¨åˆ°ä»Šå¤©çš„ä½ç½®
            setTimeout(() => {
              let cur_offset_y = today_el.getBoundingClientRect().top - document.body.getBoundingClientRect().top;
              window.scroll(0, cur_offset_y - document.documentElement.clientHeight / 2);
            }, 100);
          } else {
            // è®¤è¯å¤±è´¥
            handleAuthFailure();
          }
        },
        error: function() {
          // è¯·æ±‚å¤±è´¥
          handleAuthFailure();
        }
      });
    }

    function handleAuthFailure() {
      isAuthenticated = false;
      alert('è®¤è¯å¤±è´¥ï¼Œè¯·è¾“å…¥æ­£ç¡®çš„å¯†ç ');
      // æ¸…é™¤æ— æ•ˆå¯†ç 
      document.cookie = 'password=;max-age=0';
      // æ˜¾ç¤ºå¯†ç è¾“å…¥æ¡†
      document.getElementById('password-section').style.display = 'block';
    }

    // å¦‚æœæœ‰ä¿å­˜çš„å¯†ç ï¼Œå°è¯•è‡ªåŠ¨åŠ è½½
    if (password) {
      loadEventsWithAuth(password);
    } else {
      // æ˜¾ç¤ºå¯†ç è¾“å…¥æ¡†
      document.getElementById('password-section').style.display = 'block';
    }

    function getIdxByDate(date) {
      return Math.floor((date.getTime() - birth.getTime()) / (1000 * 3600 * 24));
    }
    function getDateStr(date) {
      return date.getFullYear() + '-' + (date.getMonth() + 1) + '-' + date.getDate();
    }
    function getColor(hue, credit) {
      return 'hsl(' + hue + ',100%,' + (100 - Math.min(100, credit) / 2) + '%)';
    }

    let days = [];
    let dateToDetailsData = {};
    let detailsContainer = document.getElementById('detail');

    const genDetailEl = (date) => {
      let detail_el = document.createElement('div');
      detail_el.className = 'detail';
      detail_el.innerHTML = date;
      if (dateToDetailsData[date]) {
        detail_el.innerHTML += '<br>' + dateToDetailsData[date];
      }
      detail_el.id = date;
      detail_el.clicked = 0;
      detailsContainer.appendChild(detail_el);
      return detail_el
    };

    const removeDetailEl = (date) => {
      document.getElementById(date).remove();
    };

    const onmouseenter = (ev) => {
      let detail_el = document.getElementById(ev.srcElement.date);
      if (!detail_el) {
        detail_el = genDetailEl(ev.srcElement.date);
      }
      if (!detail_el.clicked) {
        detail_el.style.display = 'block';
        // é™åˆ¶å¡ç‰‡ä¸è¶…å‡ºæµè§ˆå™¨å³è¾¹ç•Œ
        let left = ev.pageX + 10;
        let maxLeft = window.innerWidth + window.pageXOffset - detail_el.offsetWidth - 10;
        detail_el.style.left = Math.min(left, maxLeft) + 'px';
        detail_el.style.top = ev.pageY + 1 + 'px';
        detail_el.style.zIndex = display_count++;
      }
    };
    const onmousemove = (ev) => {
      let detail_el = document.getElementById(ev.srcElement.date);
      if (!detail_el.clicked) {
        // é™åˆ¶å¡ç‰‡ä¸è¶…å‡ºæµè§ˆå™¨å³è¾¹ç•Œ
        let left = ev.pageX + 10;
        let maxLeft = window.innerWidth + window.pageXOffset - detail_el.offsetWidth - 10;
        detail_el.style.left = Math.min(left, maxLeft) + 'px';
        detail_el.style.top = ev.pageY + 1 + 'px';
      }
    };
    const onmouseleave = (ev) => {
      let detail_el = document.getElementById(ev.srcElement.date);
      if (!detail_el.clicked) {
        detail_el.remove()
      }
    }
    const onclick = (ev) => {
      let detail_el = document.getElementById(ev.srcElement.date);
      if (detail_el.clicked) {
        detail_el.clicked = 0;
        detail_el.style.borderStyle = 'none';
        ev.srcElement.style.borderWidth = '1px';
        ev.srcElement.style.margin = '1px';
      } else {
        detail_el.clicked = 1;
        detail_el.style.borderStyle = 'solid';
        ev.srcElement.style.borderWidth = '2px';
        ev.srcElement.style.margin = '0px';
      }
    }

    for (let cur = new Date(+birth); cur < death; cur.setDate(cur.getDate() + 1)) {
      let el = document.createElement('div');
      el.className = 'day';
      if (cur >= today) {
        el.style.borderColor = '#000';
      }
      el.date = getDateStr(cur);
      el.credit = 0;
      el.no_credit_color = false;
      el.hue = 180;
      days.push(el);

      el.onmouseenter = onmouseenter;
      el.onmousemove = onmousemove;
      el.onmouseleave = onmouseleave;
      el.onclick = onclick;
    }

    let container = document.createElement('div');
    container.id = 'container';
    for (let wk in days) {
      container.appendChild(days[wk]);
    }
    document.getElementById('body').appendChild(container);

    // å°†å¹´é¾„æ ‡ç­¾ç”Ÿæˆå»¶è¿Ÿåˆ°è®¤è¯æˆåŠŸå
    function generateAgeLabels() {
      let cur_age = 0;
      for (let cur = new Date(+birth); cur < death; cur.setFullYear(cur.getFullYear() + 1)) {
        let y = days[getIdxByDate(cur)].getBoundingClientRect().top
          - document.body.getBoundingClientRect().top;
        let time_label = document.createElement('div');
        time_label.className = 'left-margin';
        time_label.style.top = y.toString() + 'px';
        if (navigator.language === 'zh-CN') {
          time_label.innerText = cur_age.toString() + ' å²';
        } else {
          time_label.innerText = 'age ' + cur_age.toString();
        }
        document.getElementById('left-margin').appendChild(time_label);
        cur_age++;
      }
    }

    let today_el = days[getIdxByDate(new Date())];
    today_el.style.borderColor = 'deeppink';



    function is_emoji(s) {
      let res = /\u{1F3F4}\u{E0067}\u{E0062}(?:\u{E0077}\u{E006C}\u{E0073}|\u{E0073}\u{E0063}\u{E0074}|\u{E0065}\u{E006E}\u{E0067})\u{E007F}|\u{1F469}\u200D\u{1F469}\u200D(?:\u{1F466}\u200D\u{1F466}|\u{1F467}\u200D[\u{1F466}\u{1F467}])|\u{1F468}(?:\u{1F3FF}\u200D(?:\u{1F91D}\u200D\u{1F468}[\u{1F3FB}-\u{1F3FE}]|[\u{1F33E}\u{1F373}\u{1F37C}\u{1F393}\u{1F3A4}\u{1F3A8}\u{1F3EB}\u{1F3ED}\u{1F4BB}\u{1F4BC}\u{1F527}\u{1F52C}\u{1F680}\u{1F692}\u{1F9AF}-\u{1F9B3}\u{1F9BC}\u{1F9BD}])|\u{1F3FE}\u200D(?:\u{1F91D}\u200D\u{1F468}[\u{1F3FB}-\u{1F3FD}\u{1F3FF}]|[\u{1F33E}\u{1F373}\u{1F37C}\u{1F393}\u{1F3A4}\u{1F3A8}\u{1F3EB}\u{1F3ED}\u{1F4BB}\u{1F4BC}\u{1F527}\u{1F52C}\u{1F680}\u{1F692}\u{1F9AF}-\u{1F9B3}\u{1F9BC}\u{1F9BD}])|\u{1F3FD}\u200D(?:\u{1F91D}\u200D\u{1F468}[\u{1F3FB}\u{1F3FC}\u{1F3FE}\u{1F3FF}]|[\u{1F33E}\u{1F373}\u{1F37C}\u{1F393}\u{1F3A4}\u{1F3A8}\u{1F3EB}\u{1F3ED}\u{1F4BB}\u{1F4BC}\u{1F527}\u{1F52C}\u{1F680}\u{1F692}\u{1F9AF}-\u{1F9B3}\u{1F9BC}\u{1F9BD}])|\u{1F3FC}\u200D(?:\u{1F91D}\u200D\u{1F468}[\u{1F3FB}\u{1F3FD}-\u{1F3FF}]|[\u{1F33E}\u{1F373}\u{1F37C}\u{1F393}\u{1F3A4}\u{1F3A8}\u{1F3EB}\u{1F3ED}\u{1F4BB}\u{1F4BC}\u{1F527}\u{1F52C}\u{1F680}\u{1F692}\u{1F9AF}-\u{1F9B3}\u{1F9BC}\u{1F9BD}])|\u{1F3FB}\u200D(?:\u{1F91D}\u200D\u{1F468}[\u{1F3FC}-\u{1F3FF}]|[\u{1F33E}\u{1F373}\u{1F37C}\u{1F393}\u{1F3A4}\u{1F3A8}\u{1F3EB}\u{1F3ED}\u{1F4BB}\u{1F4BC}\u{1F527}\u{1F52C}\u{1F680}\u{1F692}\u{1F9AF}-\u{1F9B3}\u{1F9BC}\u{1F9BD}])|\u200D(?:\u2764\uFE0F\u200D(?:\u{1F48B}\u200D)?\u{1F468}|[\u{1F468}\u{1F469}]\u200D(?:\u{1F466}\u200D\u{1F466}|\u{1F467}\u200D[\u{1F466}\u{1F467}])|\u{1F466}\u200D\u{1F466}|\u{1F467}\u200D[\u{1F466}\u{1F467}]|[\u{1F468}\u{1F469}]\u200D[\u{1F466}\u{1F467}]|[\u2695\u2696\u2708]\uFE0F|[\u{1F466}\u{1F467}]|[\u{1F33E}\u{1F373}\u{1F37C}\u{1F393}\u{1F3A4}\u{1F3A8}\u{1F3EB}\u{1F3ED}\u{1F4BB}\u{1F4BC}\u{1F527}\u{1F52C}\u{1F680}\u{1F692}\u{1F9AF}-\u{1F9B3}\u{1F9BC}\u{1F9BD}])|(?:\u{1F3FF}\u200D[\u2695\u2696\u2708]|\u{1F3FE}\u200D[\u2695\u2696\u2708]|\u{1F3FD}\u200D[\u2695\u2696\u2708]|\u{1F3FC}\u200D[\u2695\u2696\u2708]|\u{1F3FB}\u200D[\u2695\u2696\u2708])\uFE0F|[\u{1F3FB}-\u{1F3FF}])|\u{1F9D1}(?:[\u{1F3FB}-\u{1F3FF}]\u200D(?:\u{1F91D}\u200D\u{1F9D1}[\u{1F3FB}-\u{1F3FF}]|[\u{1F33E}\u{1F373}\u{1F37C}\u{1F384}\u{1F393}\u{1F3A4}\u{1F3A8}\u{1F3EB}\u{1F3ED}\u{1F4BB}\u{1F4BC}\u{1F527}\u{1F52C}\u{1F680}\u{1F692}\u{1F9AF}-\u{1F9B3}\u{1F9BC}\u{1F9BD}])|\u200D(?:\u{1F91D}\u200D\u{1F9D1}|[\u{1F33E}\u{1F373}\u{1F37C}\u{1F384}\u{1F393}\u{1F3A4}\u{1F3A8}\u{1F3EB}\u{1F3ED}\u{1F4BB}\u{1F4BC}\u{1F527}\u{1F52C}\u{1F680}\u{1F692}\u{1F9AF}-\u{1F9B3}\u{1F9BC}\u{1F9BD}]))|\u{1F469}(?:\u200D(?:\u2764\uFE0F\u200D(?:\u{1F48B}\u200D[\u{1F468}\u{1F469}]|[\u{1F468}\u{1F469}])|[\u{1F33E}\u{1F373}\u{1F37C}\u{1F393}\u{1F3A4}\u{1F3A8}\u{1F3EB}\u{1F3ED}\u{1F4BB}\u{1F4BC}\u{1F527}\u{1F52C}\u{1F680}\u{1F692}\u{1F9AF}-\u{1F9B3}\u{1F9BC}\u{1F9BD}])|\u{1F3FF}\u200D[\u{1F33E}\u{1F373}\u{1F37C}\u{1F393}\u{1F3A4}\u{1F3A8}\u{1F3EB}\u{1F3ED}\u{1F4BB}\u{1F4BC}\u{1F527}\u{1F52C}\u{1F680}\u{1F692}\u{1F9AF}-\u{1F9B3}\u{1F9BC}\u{1F9BD}]|\u{1F3FE}\u200D[\u{1F33E}\u{1F373}\u{1F37C}\u{1F393}\u{1F3A4}\u{1F3A8}\u{1F3EB}\u{1F3ED}\u{1F4BB}\u{1F4BC}\u{1F527}\u{1F52C}\u{1F680}\u{1F692}\u{1F9AF}-\u{1F9B3}\u{1F9BC}\u{1F9BD}]|\u{1F3FD}\u200D[\u{1F33E}\u{1F373}\u{1F37C}\u{1F393}\u{1F3A4}\u{1F3A8}\u{1F3EB}\u{1F3ED}\u{1F4BB}\u{1F4BC}\u{1F527}\u{1F52C}\u{1F680}\u{1F692}\u{1F9AF}-\u{1F9B3}\u{1F9BC}\u{1F9BD}]|\u{1F3FC}\u200D[\u{1F33E}\u{1F373}\u{1F37C}\u{1F393}\u{1F3A4}\u{1F3A8}\u{1F3EB}\u{1F3ED}\u{1F4BB}\u{1F4BC}\u{1F527}\u{1F52C}\u{1F680}\u{1F692}\u{1F9AF}-\u{1F9B3}\u{1F9BC}\u{1F9BD}]|\u{1F3FB}\u200D[\u{1F33E}\u{1F373}\u{1F37C}\u{1F393}\u{1F3A4}\u{1F3A8}\u{1F3EB}\u{1F3ED}\u{1F4BB}\u{1F4BC}\u{1F527}\u{1F52C}\u{1F680}\u{1F692}\u{1F9AF}-\u{1F9B3}\u{1F9BC}\u{1F9BD}])|\u{1F469}\u{1F3FF}\u200D\u{1F91D}\u200D[\u{1F468}\u{1F469}][\u{1F3FB}-\u{1F3FE}]|\u{1F469}\u{1F3FE}\u200D\u{1F91D}\u200D[\u{1F468}\u{1F469}][\u{1F3FB}-\u{1F3FD}\u{1F3FF}]|\u{1F469}\u{1F3FD}\u200D\u{1F91D}\u200D[\u{1F468}\u{1F469}][\u{1F3FB}\u{1F3FC}\u{1F3FE}\u{1F3FF}]|\u{1F469}\u{1F3FC}\u200D\u{1F91D}\u200D[\u{1F468}\u{1F469}][\u{1F3FB}\u{1F3FD}-\u{1F3FF}]|\u{1F469}\u{1F3FB}\u200D\u{1F91D}\u200D[\u{1F468}\u{1F469}][\u{1F3FC}-\u{1F3FF}]|\u{1F469}\u200D\u{1F466}\u200D\u{1F466}|\u{1F469}\u200D\u{1F469}\u200D[\u{1F466}\u{1F467}]|(?:\u{1F441}\uFE0F\u200D\u{1F5E8}|\u{1F469}(?:\u{1F3FF}\u200D[\u2695\u2696\u2708]|\u{1F3FE}\u200D[\u2695\u2696\u2708]|\u{1F3FD}\u200D[\u2695\u2696\u2708]|\u{1F3FC}\u200D[\u2695\u2696\u2708]|\u{1F3FB}\u200D[\u2695\u2696\u2708]|\u200D[\u2695\u2696\u2708])|\u{1F3F3}\uFE0F\u200D\u26A7|\u{1F9D1}(?:[\u{1F3FB}-\u{1F3FF}]\u200D[\u2695\u2696\u2708]|\u200D[\u2695\u2696\u2708])|\u{1F43B}\u200D\u2744|[\u{1F3C3}\u{1F3C4}\u{1F3CA}\u{1F46E}\u{1F470}\u{1F471}\u{1F473}\u{1F477}\u{1F481}\u{1F482}\u{1F486}\u{1F487}\u{1F645}-\u{1F647}\u{1F64B}\u{1F64D}\u{1F64E}\u{1F6A3}\u{1F6B4}-\u{1F6B6}\u{1F926}\u{1F935}\u{1F937}-\u{1F939}\u{1F93D}\u{1F93E}\u{1F9B8}\u{1F9B9}\u{1F9CD}-\u{1F9CF}\u{1F9D6}-\u{1F9DD}][\u{1F3FB}-\u{1F3FF}]\u200D[\u2640\u2642]|[\u26F9\u{1F3CB}\u{1F3CC}\u{1F575}](?:\uFE0F\u200D[\u2640\u2642]|[\u{1F3FB}-\u{1F3FF}]\u200D[\u2640\u2642])|\u{1F3F4}\u200D\u2620|[\u{1F3C3}\u{1F3C4}\u{1F3CA}\u{1F46E}-\u{1F471}\u{1F473}\u{1F477}\u{1F481}\u{1F482}\u{1F486}\u{1F487}\u{1F645}-\u{1F647}\u{1F64B}\u{1F64D}\u{1F64E}\u{1F6A3}\u{1F6B4}-\u{1F6B6}\u{1F926}\u{1F935}\u{1F937}-\u{1F939}\u{1F93C}-\u{1F93E}\u{1F9B8}\u{1F9B9}\u{1F9CD}-\u{1F9CF}\u{1F9D6}-\u{1F9DF}]\u200D[\u2640\u2642])\uFE0F|\u{1F469}\u200D\u{1F467}\u200D[\u{1F466}\u{1F467}]|\u{1F3F3}\uFE0F\u200D\u{1F308}|\u{1F469}\u200D\u{1F467}|\u{1F469}\u200D\u{1F466}|\u{1F415}\u200D\u{1F9BA}|\u{1F1FD}\u{1F1F0}|\u{1F1F6}\u{1F1E6}|\u{1F1F4}\u{1F1F2}|\u{1F408}\u200D\u2B1B|\u{1F9D1}[\u{1F3FB}-\u{1F3FF}]|\u{1F469}[\u{1F3FB}-\u{1F3FF}]|\u{1F1FF}[\u{1F1E6}\u{1F1F2}\u{1F1FC}]|\u{1F1FE}[\u{1F1EA}\u{1F1F9}]|\u{1F1FC}[\u{1F1EB}\u{1F1F8}]|\u{1F1FB}[\u{1F1E6}\u{1F1E8}\u{1F1EA}\u{1F1EC}\u{1F1EE}\u{1F1F3}\u{1F1FA}]|\u{1F1FA}[\u{1F1E6}\u{1F1EC}\u{1F1F2}\u{1F1F3}\u{1F1F8}\u{1F1FE}\u{1F1FF}]|\u{1F1F9}[\u{1F1E6}\u{1F1E8}\u{1F1E9}\u{1F1EB}-\u{1F1ED}\u{1F1EF}-\u{1F1F4}\u{1F1F7}\u{1F1F9}\u{1F1FB}\u{1F1FC}\u{1F1FF}]|\u{1F1F8}[\u{1F1E6}-\u{1F1EA}\u{1F1EC}-\u{1F1F4}\u{1F1F7}-\u{1F1F9}\u{1F1FB}\u{1F1FD}-\u{1F1FF}]|\u{1F1F7}[\u{1F1EA}\u{1F1F4}\u{1F1F8}\u{1F1FA}\u{1F1FC}]|\u{1F1F5}[\u{1F1E6}\u{1F1EA}-\u{1F1ED}\u{1F1F0}-\u{1F1F3}\u{1F1F7}-\u{1F1F9}\u{1F1FC}\u{1F1FE}]|\u{1F1F3}[\u{1F1E6}\u{1F1E8}\u{1F1EA}-\u{1F1EC}\u{1F1EE}\u{1F1F1}\u{1F1F4}\u{1F1F5}\u{1F1F7}\u{1F1FA}\u{1F1FF}]|\u{1F1F2}[\u{1F1E6}\u{1F1E8}-\u{1F1ED}\u{1F1F0}-\u{1F1FF}]|\u{1F1F1}[\u{1F1E6}-\u{1F1E8}\u{1F1EE}\u{1F1F0}\u{1F1F7}-\u{1F1FB}\u{1F1FE}]|\u{1F1F0}[\u{1F1EA}\u{1F1EC}-\u{1F1EE}\u{1F1F2}\u{1F1F3}\u{1F1F5}\u{1F1F7}\u{1F1FC}\u{1F1FE}\u{1F1FF}]|\u{1F1EF}[\u{1F1EA}\u{1F1F2}\u{1F1F4}\u{1F1F5}]|\u{1F1EE}[\u{1F1E8}-\u{1F1EA}\u{1F1F1}-\u{1F1F4}\u{1F1F6}-\u{1F1F9}]|\u{1F1ED}[\u{1F1F0}\u{1F1F2}\u{1F1F3}\u{1F1F7}\u{1F1F9}\u{1F1FA}]|\u{1F1EC}[\u{1F1E6}\u{1F1E7}\u{1F1E9}-\u{1F1EE}\u{1F1F1}-\u{1F1F3}\u{1F1F5}-\u{1F1FA}\u{1F1FC}\u{1F1FE}]|\u{1F1EB}[\u{1F1EE}-\u{1F1F0}\u{1F1F2}\u{1F1F4}\u{1F1F7}]|\u{1F1EA}[\u{1F1E6}\u{1F1E8}\u{1F1EA}\u{1F1EC}\u{1F1ED}\u{1F1F7}-\u{1F1FA}]|\u{1F1E9}[\u{1F1EA}\u{1F1EC}\u{1F1EF}\u{1F1F0}\u{1F1F2}\u{1F1F4}\u{1F1FF}]|\u{1F1E8}[\u{1F1E6}\u{1F1E8}\u{1F1E9}\u{1F1EB}-\u{1F1EE}\u{1F1F0}-\u{1F1F5}\u{1F1F7}\u{1F1FA}-\u{1F1FF}]|\u{1F1E7}[\u{1F1E6}\u{1F1E7}\u{1F1E9}-\u{1F1EF}\u{1F1F1}-\u{1F1F4}\u{1F1F6}-\u{1F1F9}\u{1F1FB}\u{1F1FC}\u{1F1FE}\u{1F1FF}]|\u{1F1E6}[\u{1F1E8}-\u{1F1EC}\u{1F1EE}\u{1F1F1}\u{1F1F2}\u{1F1F4}\u{1F1F6}-\u{1F1FA}\u{1F1FC}\u{1F1FD}\u{1F1FF}]|[#\*0-9]\uFE0F\u20E3|[\u{1F3C3}\u{1F3C4}\u{1F3CA}\u{1F46E}\u{1F470}\u{1F471}\u{1F473}\u{1F477}\u{1F481}\u{1F482}\u{1F486}\u{1F487}\u{1F645}-\u{1F647}\u{1F64B}\u{1F64D}\u{1F64E}\u{1F6A3}\u{1F6B4}-\u{1F6B6}\u{1F926}\u{1F935}\u{1F937}-\u{1F939}\u{1F93D}\u{1F93E}\u{1F9B8}\u{1F9B9}\u{1F9CD}-\u{1F9CF}\u{1F9D6}-\u{1F9DD}][\u{1F3FB}-\u{1F3FF}]|[\u26F9\u{1F3CB}\u{1F3CC}\u{1F575}][\u{1F3FB}-\u{1F3FF}]|[\u261D\u270A-\u270D\u{1F385}\u{1F3C2}\u{1F3C7}\u{1F442}\u{1F443}\u{1F446}-\u{1F450}\u{1F466}\u{1F467}\u{1F46B}-\u{1F46D}\u{1F472}\u{1F474}-\u{1F476}\u{1F478}\u{1F47C}\u{1F483}\u{1F485}\u{1F4AA}\u{1F574}\u{1F57A}\u{1F590}\u{1F595}\u{1F596}\u{1F64C}\u{1F64F}\u{1F6C0}\u{1F6CC}\u{1F90C}\u{1F90F}\u{1F918}-\u{1F91C}\u{1F91E}\u{1F91F}\u{1F930}-\u{1F934}\u{1F936}\u{1F977}\u{1F9B5}\u{1F9B6}\u{1F9BB}\u{1F9D2}-\u{1F9D5}][\u{1F3FB}-\u{1F3FF}]|[\u231A\u231B\u23E9-\u23EC\u23F0\u23F3\u25FD\u25FE\u2614\u2615\u2648-\u2653\u267F\u2693\u26A1\u26AA\u26AB\u26BD\u26BE\u26C4\u26C5\u26CE\u26D4\u26EA\u26F2\u26F3\u26F5\u26FA\u26FD\u2705\u270A\u270B\u2728\u274C\u274E\u2753-\u2755\u2757\u2795-\u2797\u27B0\u27BF\u2B1B\u2B1C\u2B50\u2B55\u{1F004}\u{1F0CF}\u{1F18E}\u{1F191}-\u{1F19A}\u{1F1E6}-\u{1F1FF}\u{1F201}\u{1F21A}\u{1F22F}\u{1F232}-\u{1F236}\u{1F238}-\u{1F23A}\u{1F250}\u{1F251}\u{1F300}-\u{1F320}\u{1F32D}-\u{1F335}\u{1F337}-\u{1F37C}\u{1F37E}-\u{1F393}\u{1F3A0}-\u{1F3CA}\u{1F3CF}-\u{1F3D3}\u{1F3E0}-\u{1F3F0}\u{1F3F4}\u{1F3F8}-\u{1F43E}\u{1F440}\u{1F442}-\u{1F4FC}\u{1F4FF}-\u{1F53D}\u{1F54B}-\u{1F54E}\u{1F550}-\u{1F567}\u{1F57A}\u{1F595}\u{1F596}\u{1F5A4}\u{1F5FB}-\u{1F64F}\u{1F680}-\u{1F6C5}\u{1F6CC}\u{1F6D0}-\u{1F6D2}\u{1F6D5}-\u{1F6D7}\u{1F6EB}\u{1F6EC}\u{1F6F4}-\u{1F6FC}\u{1F7E0}-\u{1F7EB}\u{1F90C}-\u{1F93A}\u{1F93C}-\u{1F945}\u{1F947}-\u{1F978}\u{1F97A}-\u{1F9CB}\u{1F9CD}-\u{1F9FF}\u{1FA70}-\u{1FA74}\u{1FA78}-\u{1FA7A}\u{1FA80}-\u{1FA86}\u{1FA90}-\u{1FAA8}\u{1FAB0}-\u{1FAB6}\u{1FAC0}-\u{1FAC2}\u{1FAD0}-\u{1FAD6}]|[#\*0-9\xA9\xAE\u203C\u2049\u2122\u2139\u2194-\u2199\u21A9\u21AA\u231A\u231B\u2328\u23CF\u23E9-\u23F3\u23F8-\u23FA\u24C2\u25AA\u25AB\u25B6\u25C0\u25FB-\u25FE\u2600-\u2604\u260E\u2611\u2614\u2615\u2618\u261D\u2620\u2622\u2623\u2626\u262A\u262E\u262F\u2638-\u263A\u2640\u2642\u2648-\u2653\u265F\u2660\u2663\u2665\u2666\u2668\u267B\u267E\u267F\u2692-\u2697\u2699\u269B\u269C\u26A0\u26A1\u26A7\u26AA\u26AB\u26B0\u26B1\u26BD\u26BE\u26C4\u26C5\u26C8\u26CE\u26CF\u26D1\u26D3\u26D4\u26E9\u26EA\u26F0-\u26F5\u26F7-\u26FA\u26FD\u2702\u2705\u2708-\u270D\u270F\u2712\u2714\u2716\u271D\u2721\u2728\u2733\u2734\u2744\u2747\u274C\u274E\u2753-\u2755\u2757\u2763\u2764\u2795-\u2797\u27A1\u27B0\u27BF\u2934\u2935\u2B05-\u2B07\u2B1B\u2B1C\u2B50\u2B55\u3030\u303D\u3297\u3299\u{1F004}\u{1F0CF}\u{1F170}\u{1F171}\u{1F17E}\u{1F17F}\u{1F18E}\u{1F191}-\u{1F19A}\u{1F1E6}-\u{1F1FF}\u{1F201}\u{1F202}\u{1F21A}\u{1F22F}\u{1F232}-\u{1F23A}\u{1F250}\u{1F251}\u{1F300}-\u{1F321}\u{1F324}-\u{1F393}\u{1F396}\u{1F397}\u{1F399}-\u{1F39B}\u{1F39E}-\u{1F3F0}\u{1F3F3}-\u{1F3F5}\u{1F3F7}-\u{1F4FD}\u{1F4FF}-\u{1F53D}\u{1F549}-\u{1F54E}\u{1F550}-\u{1F567}\u{1F56F}\u{1F570}\u{1F573}-\u{1F57A}\u{1F587}\u{1F58A}-\u{1F58D}\u{1F590}\u{1F595}\u{1F596}\u{1F5A4}\u{1F5A5}\u{1F5A8}\u{1F5B1}\u{1F5B2}\u{1F5BC}\u{1F5C2}-\u{1F5C4}\u{1F5D1}-\u{1F5D3}\u{1F5DC}-\u{1F5DE}\u{1F5E1}\u{1F5E3}\u{1F5E8}\u{1F5EF}\u{1F5F3}\u{1F5FA}-\u{1F64F}\u{1F680}-\u{1F6C5}\u{1F6CB}-\u{1F6D2}\u{1F6D5}-\u{1F6D7}\u{1F6E0}-\u{1F6E5}\u{1F6E9}\u{1F6EB}\u{1F6EC}\u{1F6F0}\u{1F6F3}-\u{1F6FC}\u{1F7E0}-\u{1F7EB}\u{1F90C}-\u{1F93A}\u{1F93C}-\u{1F945}\u{1F947}-\u{1F978}\u{1F97A}-\u{1F9CB}\u{1F9CD}-\u{1F9FF}\u{1FA70}-\u{1FA74}\u{1FA78}-\u{1FA7A}\u{1FA80}-\u{1FA86}\u{1FA90}-\u{1FAA8}\u{1FAB0}-\u{1FAB6}\u{1FAC0}-\u{1FAC2}\u{1FAD0}-\u{1FAD6}]\uFE0F|[\u261D\u26F9\u270A-\u270D\u{1F385}\u{1F3C2}-\u{1F3C4}\u{1F3C7}\u{1F3CA}-\u{1F3CC}\u{1F442}\u{1F443}\u{1F446}-\u{1F450}\u{1F466}-\u{1F478}\u{1F47C}\u{1F481}-\u{1F483}\u{1F485}-\u{1F487}\u{1F48F}\u{1F491}\u{1F4AA}\u{1F574}\u{1F575}\u{1F57A}\u{1F590}\u{1F595}\u{1F596}\u{1F645}-\u{1F647}\u{1F64B}-\u{1F64F}\u{1F6A3}\u{1F6B4}-\u{1F6B6}\u{1F6C0}\u{1F6CC}\u{1F90C}\u{1F90F}\u{1F918}-\u{1F91F}\u{1F926}\u{1F930}-\u{1F939}\u{1F93C}-\u{1F93E}\u{1F977}\u{1F9B5}\u{1F9B6}\u{1F9B8}\u{1F9B9}\u{1F9BB}\u{1F9CD}-\u{1F9CF}\u{1F9D1}-\u{1F9DD}]/gu.exec(s);
      if (res) return res[0];
      else return false;
    }

    function process_events(el) {
      let events = el.childNodes;
      for (let idx = 0; idx < events.length; idx++) {
        if (events[idx].nodeType == 1) {
          let ev = events[idx];
          const content = ev.innerHTML;

          if (ev.getAttribute('date') != null) {
            // one-day event
            let cur_date = new Date(Date.parse(ev.getAttribute('date')));
            let el_idx = getIdxByDate(cur_date);
            let day_el = days[el_idx];
            if (!day_el) continue;
            if (ev.getAttribute('icon') != null) {
              day_el.style.backgroundSize = '100% 100%';
              day_el.style.backgroundImage = 'url("' + ev.getAttribute('icon') + '")';
            }

            if (ev.getAttribute('color') != null) {
              day_el.style.backgroundColor = ev.getAttribute('color');
              day_el.no_credit_color = true;
            }

            if (ev.className == 'base') {
              day_el.hue = parseInt(ev.getAttribute('hue'));
            }

            let ev_credit = parseFloat(ev.getAttribute('credit'));
            day_el.credit += ev_credit == NaN ? 1 : ev_credit;
            if (!day_el.no_credit_color)
              day_el.style.backgroundColor = getColor(day_el.hue, day_el.credit);

            dateStr = getDateStr(cur_date);
            if (!dateToDetailsData[dateStr]) {
              dateToDetailsData[dateStr] = content;
            } else {
              dateToDetailsData[dateStr] += '<br>' + content;
            }

            ev.childNodes.forEach((cn) => {
              let emo = is_emoji(cn.textContent.trim());
              if (cn.nodeType === 3 && emo) {
                day_el.innerHTML = emo;
              }
            })
          } else if (ev.getAttribute('start') != null && ev.getAttribute('end') != null) {
            // mutiple-day event
            let start = new Date(Date.parse(ev.getAttribute('start')));
            let end = new Date(Date.parse(ev.getAttribute('end')));
            for (; start <= end; start.setDate(start.getDate() + 1)) {
              let el_idx = getIdxByDate(start);
              let day_el = days[el_idx];
              if (!day_el) continue;
              if (ev.getAttribute('color') != null) {
                day_el.style.backgroundColor = ev.getAttribute('color');
                day_el.no_credit_color = true;
              }

              if (ev.className == 'base') {
                day_el.hue = parseInt(ev.getAttribute('hue'));
              }

              let ev_credit = parseFloat(ev.getAttribute('credit'));
              day_el.credit += ev_credit == NaN ? 1 : ev_credit;
              if (!day_el.no_credit_color)
                day_el.style.backgroundColor = getColor(day_el.hue, day_el.credit);
              // console.log(getColor(day_el.hue, day_el.credit));

              dateStr = getDateStr(start);
              if (!dateToDetailsData[dateStr]) {
                dateToDetailsData[dateStr] = content;
              } else {
                dateToDetailsData[dateStr] += '<br>' + content;
              }
            }

          }
        }
      }
    }


    let cur_offset_y = today_el.getBoundingClientRect().top - document.body.getBoundingClientRect().top;
    window.onload = () => {
      window.scroll(0, cur_offset_y - document.documentElement.clientHeight / 2);
      // console.log(cur_offset_y - document.documentElement.clientHeight/2);
      // åŠ è½½å®Œæˆåæ¸²æŸ“æŠ½å±‰å†…å®¹
      renderDrawerContent();
    }

// setTimeout(() => {
//     window.scroll(0, cur_offset_y - document.documentElement.clientHeight/2);
// }, 500);

    // æŠ½å±‰åŠŸèƒ½
    function toggleDrawer() {
      const drawer = document.getElementById('drawer');
      const toggleBtn = document.getElementById('drawer-toggle');
      drawer.classList.toggle('open');
      toggleBtn.classList.toggle('drawer-open');
    }

    // æ£€æŸ¥å†…å®¹æ˜¯å¦åªåŒ…å«æ–œä½“æ ‡ç­¾
    function isOnlyItalic(htmlContent) {
      // åˆ›å»ºä¸´æ—¶å…ƒç´ æ¥è§£æHTML
      const temp = document.createElement('div');
      temp.innerHTML = htmlContent;

      // è·å–æ‰€æœ‰æ–‡æœ¬å†…å®¹ï¼ˆä¸åŒ…æ‹¬æ ‡ç­¾ï¼‰
      const textContent = temp.textContent.trim();

      // ç§»é™¤æ‰€æœ‰<i>æ ‡ç­¾åçš„å†…å®¹
      const withoutItalic = htmlContent.replace(/<i[^>]*>.*?<\/i>/gi, '').replace(/<br\s*\/?>/gi, '').trim();

      // å¦‚æœç§»é™¤<i>æ ‡ç­¾åæ²¡æœ‰å®è´¨å†…å®¹ï¼Œè¯´æ˜åªåŒ…å«æ–œä½“
      return textContent.length > 0 && withoutItalic === '';
    }

    // æ¸²æŸ“æŠ½å±‰å†…å®¹
    function renderDrawerContent() {
      const drawerContent = document.getElementById('drawer-content');
      drawerContent.innerHTML = '';

      // å°†æ‰€æœ‰è®°å½•æŒ‰æ—¥æœŸæ’åºï¼ˆæœ€æ–°çš„åœ¨å‰ï¼‰
      const sortedDates = Object.keys(dateToDetailsData).sort((a, b) => {
        return new Date(b) - new Date(a);
      });

      if (sortedDates.length === 0) {
        drawerContent.innerHTML = '<div class="no-records">æš‚æ— è®°å½•</div>';
        return;
      }

      let renderedCount = 0;

      // æ¸²æŸ“æ¯æ¡è®°å½•
      sortedDates.forEach(date => {
        const content = dateToDetailsData[date];

        // å¦‚æœå†…å®¹åªåŒ…å«æ–œä½“ï¼Œè·³è¿‡æ¸²æŸ“
        if (isOnlyItalic(content)) {
          return;
        }

        const card = document.createElement('div');
        card.className = 'record-card';
        card.setAttribute('data-date', date);
        card.setAttribute('data-content', content);

        const dateEl = document.createElement('div');
        dateEl.className = 'record-date';
        dateEl.textContent = date;

        const contentEl = document.createElement('div');
        contentEl.className = 'record-content';
        contentEl.innerHTML = content;

        card.appendChild(dateEl);
        card.appendChild(contentEl);
        drawerContent.appendChild(card);
        renderedCount++;
      });

      // å¦‚æœæ²¡æœ‰æ¸²æŸ“ä»»ä½•å¡ç‰‡ï¼Œæ˜¾ç¤ºæç¤º
      if (renderedCount === 0) {
        drawerContent.innerHTML = '<div class="no-records">æš‚æ— è®°å½•</div>';
      }
    }

    // æœç´¢åŠŸèƒ½
    function searchRecords() {
      const searchText = document.getElementById('search-box').value.toLowerCase();
      const cards = document.querySelectorAll('.record-card');
      let visibleCount = 0;

      cards.forEach(card => {
        const date = card.getAttribute('data-date').toLowerCase();
        const content = card.getAttribute('data-content').toLowerCase();

        if (date.includes(searchText) || content.includes(searchText)) {
          card.classList.remove('hidden');
          visibleCount++;
        } else {
          card.classList.add('hidden');
        }
      });

      // å¦‚æœæ²¡æœ‰åŒ¹é…ç»“æœï¼Œæ˜¾ç¤ºæç¤º
      const drawerContent = document.getElementById('drawer-content');
      const existingNoResults = drawerContent.querySelector('.no-records');

      if (visibleCount === 0 && cards.length > 0) {
        if (!existingNoResults) {
          const noResults = document.createElement('div');
          noResults.className = 'no-records';
          noResults.textContent = 'æœªæ‰¾åˆ°åŒ¹é…çš„è®°å½•';
          drawerContent.appendChild(noResults);
        }
      } else if (existingNoResults) {
        existingNoResults.remove();
      }
    }
  </script>
</body>

</html>